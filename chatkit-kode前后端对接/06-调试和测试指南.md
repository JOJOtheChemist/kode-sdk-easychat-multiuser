# 调试和测试指南

## 调试技巧

### 1. 查看 SSE 事件流

使用 curl 测试 SSE 端点：

```bash
curl -N -X POST http://localhost:8001/chatkit \
  -H "Content-Type: application/json" \
  -d '{
    "thread_id": "test-thread",
    "messages": [
      {"role": "user", "content": "Hello, my name is Alice"}
    ]
  }'
```

预期输出：
```
event: thread.stream
data: {"type":"text.delta","delta":"Hello","thread_id":"test-thread"}

event: thread.stream
data: {"type":"client_tool_call","name":"record_fact","arguments":{"fact_id":"fact_xxx","fact_text":"Alice"},"thread_id":"test-thread"}

event: thread.stream
data: {"type":"thread_item.done","thread_id":"test-thread","item":{...}}
```

### 2. 启用详细日志

在 `.env` 中设置：

```bash
LOG_LEVEL=debug
```

在代码中添加日志：

```typescript
// src/chatkit/converter.ts
console.log('[converter] Event type:', event.type);
console.log('[converter] Event data:', JSON.stringify(event, null, 2));
```

### 3. 使用 Chrome DevTools 监控 SSE

1. 打开 Chrome DevTools
2. 进入 Network 标签
3. 筛选 EventStream
4. 发送消息并查看 SSE 事件

### 4. 测试客户端工具调用

创建测试脚本 `test-client-tools.ts`:

```typescript
import { clientToolCallQueue } from './src/kode/tools.js';

// 模拟添加客户端工具调用
const threadId = 'test-123';
clientToolCallQueue.set(threadId, [
  {
    name: 'record_fact',
    arguments: { fact_id: 'fact_001', fact_text: 'Test fact' }
  }
]);

// 检查队列
console.log('Queue:', clientToolCallQueue.get(threadId));
```

### 5. 监控 Kode-SDK Agent 事件

```typescript
// 在 agent-manager.ts 中
agent.events.on('chat', (envelope) => {
  console.log('[Agent Event]', envelope.event.type);
});

agent.events.on('monitor', (envelope) => {
  if (envelope.event.type === 'error') {
    console.error('[Agent Error]', envelope.event.detail);
  }
});
```

## 单元测试

### 1. 安装测试框架

```bash
npm install -D vitest @vitest/ui
```

### 2. 测试事件转换器

```typescript
// tests/converter.test.ts
import { describe, it, expect } from 'vitest';
import { convertKodeEventsToSSE } from '../src/chatkit/converter.js';

describe('Event Converter', () => {
  it('should convert text_chunk to text.delta', async () => {
    const kodeEvents = async function* () {
      yield {
        channel: 'chat',
        event: { type: 'text_chunk', delta: 'Hello' },
        bookmark: { seq: 1, timestamp: Date.now() }
      };
    };
    
    const sseEvents: string[] = [];
    for await (const event of convertKodeEventsToSSE(kodeEvents(), 'test-thread', 'agent-1')) {
      sseEvents.push(event);
    }
    
    expect(sseEvents.length).toBeGreaterThan(0);
    expect(sseEvents[0]).toContain('text.delta');
    expect(sseEvents[0]).toContain('Hello');
  });
});
```

### 3. 测试 Facts Store

```typescript
// tests/facts-store.test.ts
import { describe, it, expect, beforeEach } from 'vitest';
import { factsStore } from '../src/storage/facts-store.js';

describe('Facts Store', () => {
  beforeEach(async () => {
    // 清空存储
    factsStore.facts.clear();
  });
  
  it('should create a fact', async () => {
    const fact = await factsStore.create('Test fact');
    
    expect(fact.id).toBeDefined();
    expect(fact.text).toBe('Test fact');
    expect(fact.status).toBe('saved');
  });
  
  it('should retrieve a fact by id', async () => {
    const created = await factsStore.create('Test fact');
    const retrieved = await factsStore.get(created.id);
    
    expect(retrieved).toEqual(created);
  });
});
```

### 4. 测试工具

```typescript
// tests/tools.test.ts
import { describe, it, expect } from 'vitest';
import { createSaveFactTool } from '../src/kode/tools.js';

describe('Save Fact Tool', () => {
  it('should save fact and trigger client tool call', async () => {
    const tool = createSaveFactTool();
    const context = { agentId: 'test-agent' };
    
    const result = await tool.handler(
      { fact: 'Test fact' },
      context
    );
    
    expect(result.success).toBe(true);
    expect(result.fact_id).toBeDefined();
  });
});
```

## 集成测试

### 1. 测试完整对话流程

```typescript
// tests/integration/chat-flow.test.ts
import { describe, it, expect } from 'vitest';
import { AgentManager } from '../../src/kode/agent-manager.js';
import { initKodeSDK } from '../../src/kode/config.js';

describe('Chat Flow Integration', () => {
  it('should handle a complete conversation', async () => {
    const deps = initKodeSDK();
    const manager = new AgentManager(deps);
    
    const agent = await manager.getOrCreate('test-thread');
    
    const events: any[] = [];
    for await (const envelope of agent.chatStream('My name is Bob')) {
      events.push(envelope.event);
    }
    
    // 应该包含文本输出
    const textChunks = events.filter(e => e.type === 'text_chunk');
    expect(textChunks.length).toBeGreaterThan(0);
    
    // 应该调用 save_fact 工具
    const toolCalls = events.filter(e => e.type === 'tool_call');
    expect(toolCalls.some(e => e.tool === 'save_fact')).toBe(true);
  });
});
```

### 2. 测试 ChatKit 适配器

```typescript
// tests/integration/chatkit-adapter.test.ts
import { describe, it, expect } from 'vitest';
import Fastify from 'fastify';
import { chatkitAdapter } from '../../src/chatkit/adapter.js';
import { AgentManager } from '../../src/kode/agent-manager.js';
import { initKodeSDK } from '../../src/kode/config.js';

describe('ChatKit Adapter Integration', () => {
  it('should return SSE stream for chat request', async () => {
    const server = Fastify();
    const deps = initKodeSDK();
    const manager = new AgentManager(deps);
    
    server.post('/chatkit', (req, reply) => 
      chatkitAdapter(req, reply, manager)
    );
    
    const response = await server.inject({
      method: 'POST',
      url: '/chatkit',
      payload: {
        thread_id: 'test-thread',
        messages: [
          { role: 'user', content: 'Hello' }
        ]
      }
    });
    
    expect(response.statusCode).toBe(200);
    expect(response.headers['content-type']).toContain('text/event-stream');
  });
});
```

## E2E 测试

### 1. 安装 Playwright

```bash
npm install -D @playwright/test
```

### 2. E2E 测试脚本

```typescript
// tests/e2e/chat.spec.ts
import { test, expect } from '@playwright/test';

test.describe('ChatKit Frontend', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('http://localhost:5173');
  });
  
  test('should send message and receive response', async ({ page }) => {
    // 等待 ChatKit 加载
    await page.waitForSelector('[data-testid="chatkit-composer"]');
    
    // 输入消息
    await page.fill('[data-testid="chatkit-input"]', 'My name is Alice');
    await page.click('[data-testid="chatkit-send"]');
    
    // 等待响应
    await page.waitForSelector('[data-testid="assistant-message"]');
    
    // 验证响应
    const response = await page.textContent('[data-testid="assistant-message"]');
    expect(response).toContain('Alice');
    
    // 验证 fact 被保存
    await page.waitForSelector('[data-testid="fact-card"]');
    const factText = await page.textContent('[data-testid="fact-card"]');
    expect(factText).toContain('Alice');
  });
  
  test('should switch theme', async ({ page }) => {
    // 点击主题切换按钮
    await page.click('[data-testid="theme-toggle"]');
    
    // 发送主题切换命令
    await page.fill('[data-testid="chatkit-input"]', 'Switch to dark mode');
    await page.click('[data-testid="chatkit-send"]');
    
    // 等待主题切换
    await page.waitForTimeout(1000);
    
    // 验证主题已切换
    const html = await page.locator('html');
    const darkMode = await html.getAttribute('class');
    expect(darkMode).toContain('dark');
  });
});
```

## 性能测试

### 1. 压力测试

```typescript
// tests/performance/load.test.ts
import { describe, it } from 'vitest';
import autocannon from 'autocannon';

describe('Performance Tests', () => {
  it('should handle concurrent requests', async () => {
    const result = await autocannon({
      url: 'http://localhost:8001/chatkit',
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        thread_id: 'perf-test',
        messages: [{ role: 'user', content: 'Hello' }]
      }),
      connections: 10,  // 10 个并发连接
      duration: 30,     // 30 秒
    });
    
    console.log('Requests/sec:', result.requests.average);
    console.log('Latency avg:', result.latency.mean);
  });
});
```

### 2. 内存泄漏检测

```typescript
// tests/performance/memory.test.ts
import { describe, it } from 'vitest';
import { AgentManager } from '../../src/kode/agent-manager.js';
import { initKodeSDK } from '../../src/kode/config.js';

describe('Memory Leak Tests', () => {
  it('should not leak memory with many agents', async () => {
    const deps = initKodeSDK();
    const manager = new AgentManager(deps);
    
    const initialMemory = process.memoryUsage().heapUsed;
    
    // 创建并清理 100 个 agent
    for (let i = 0; i < 100; i++) {
      const agent = await manager.getOrCreate(`thread-${i}`);
      await manager.cleanup(`thread-${i}`);
    }
    
    // 强制 GC（需要 --expose-gc 标志）
    if (global.gc) {
      global.gc();
    }
    
    const finalMemory = process.memoryUsage().heapUsed;
    const memoryGrowth = finalMemory - initialMemory;
    
    console.log('Memory growth:', memoryGrowth / 1024 / 1024, 'MB');
    
    // 内存增长应该在合理范围内（< 50MB）
    expect(memoryGrowth).toBeLessThan(50 * 1024 * 1024);
  });
});
```

## 常见问题排查

### 问题 1: SSE 连接断开

**症状**: 前端显示"连接失败"或"网络错误"

**排查步骤**:
1. 检查后端是否正常运行
2. 查看后端日志是否有错误
3. 使用 curl 测试 SSE 端点
4. 检查 CORS 配置
5. 检查防火墙设置

**解决方案**:
```typescript
// 添加心跳机制
setInterval(() => {
  reply.raw.write(': heartbeat\n\n');
}, 30000);
```

### 问题 2: 客户端工具未触发

**症状**: 主题切换或 fact 保存不生效

**排查步骤**:
1. 检查工具是否正确注册
2. 查看 `clientToolCallQueue` 是否有数据
3. 检查事件转换器是否正确发送 `client_tool_call` 事件
4. 前端是否正确监听 `onClientTool`

**调试代码**:
```typescript
// 在 converter.ts 中
else if (event.type === 'tool_result') {
  const queue = clientToolCallQueue.get(agentId) || [];
  console.log('[DEBUG] Client tool queue:', queue);
  for (const call of queue) {
    console.log('[DEBUG] Sending client_tool_call:', call);
    yield formatSSE({...});
  }
}
```

### 问题 3: Agent 状态未恢复

**症状**: 刷新页面后丢失对话历史

**排查步骤**:
1. 检查 `.kode` 目录是否有数据
2. 查看 `thread_id` 是否保持一致
3. 检查 Store 配置是否正确

**解决方案**:
```typescript
// 确保 thread_id 持久化
// 前端需要保存 thread_id 到 localStorage
localStorage.setItem('chatkit_thread_id', threadId);
```

### 问题 4: GLM API 调用失败

**症状**: 后端返回 "API error" 或超时

**排查步骤**:
1. 验证 API Key 是否正确
2. 检查网络连接
3. 查看 GLM API 配额
4. 测试 API Key:

```bash
curl -X POST https://open.bigmodel.cn/api/paas/v4/chat/completions \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "glm-4.5-air",
    "messages": [{"role": "user", "content": "Hello"}]
  }'
```

## 日志最佳实践

### 结构化日志

```typescript
// src/utils/logger.ts
import pino from 'pino';

export const logger = pino({
  level: process.env.LOG_LEVEL || 'info',
  transport: {
    target: 'pino-pretty',
    options: {
      colorize: true,
      translateTime: 'SYS:standard',
    }
  }
});

// 使用
logger.info({ threadId, agentId }, 'Agent created');
logger.error({ error, context }, 'Failed to process request');
```

### 请求日志

```typescript
// 在 server.ts 中
server.addHook('onRequest', async (request, reply) => {
  request.log.info({ url: request.url, method: request.method }, 'Incoming request');
});

server.addHook('onResponse', async (request, reply) => {
  request.log.info({ 
    url: request.url, 
    statusCode: reply.statusCode,
    responseTime: reply.getResponseTime()
  }, 'Request completed');
});
```

## 监控和告警

### 使用 Prometheus

```typescript
// 安装
npm install prom-client

// src/utils/metrics.ts
import { register, Counter, Histogram } from 'prom-client';

export const requestCounter = new Counter({
  name: 'chatkit_requests_total',
  help: 'Total number of ChatKit requests',
  labelNames: ['status']
});

export const responseTime = new Histogram({
  name: 'chatkit_response_duration_seconds',
  help: 'Response time in seconds',
  buckets: [0.1, 0.5, 1, 2, 5]
});

// 在 server.ts 中暴露指标
server.get('/metrics', async () => {
  return register.metrics();
});
```

运行测试：
```bash
npm run test
npm run test:e2e
```

