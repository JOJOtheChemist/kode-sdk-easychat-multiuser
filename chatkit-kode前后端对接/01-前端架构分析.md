# ChatKit 前端架构分析

## 概述
前端基于 React + TypeScript + Vite，使用 OpenAI 的 `@openai/chatkit-react` 库实现对话界面。

## 目录结构

```
frontend/src/
├── components/          # React 组件
│   ├── ChatKitPanel.tsx    # 核心对话面板组件
│   ├── Home.tsx            # 主页面布局
│   ├── FactCard.tsx        # Fact 展示卡片
│   └── ThemeToggle.tsx     # 主题切换按钮
├── hooks/              # 自定义 Hooks
│   ├── useColorScheme.ts   # 主题管理
│   └── useFacts.ts         # Facts 状态管理
├── lib/                # 工具库
│   ├── config.ts           # 配置常量
│   └── facts.ts            # Fact 数据类型
├── types/              # TypeScript 类型定义
│   └── chatkit-tools.d.ts  # ChatKit 工具类型扩展
├── App.tsx             # 应用入口
├── main.tsx            # React 挂载点
└── index.css           # 全局样式

```

## 核心组件分析

### 1. ChatKitPanel.tsx - 对话面板核心

**功能：**
- 使用 `@openai/chatkit-react` 的 `useChatKit` Hook
- 配置 ChatKit API 连接（URL + domain key）
- 处理主题切换
- 处理客户端工具调用（client tools）

**关键配置：**

```typescript
const chatkit = useChatKit({
  // API 配置
  api: { 
    url: CHATKIT_API_URL,           // 默认: http://localhost:8001/chatkit
    domainKey: CHATKIT_API_DOMAIN_KEY 
  },
  
  // 主题配置
  theme: { colorScheme: 'light' | 'dark', ... },
  
  // 启动屏幕配置
  startScreen: { greeting, prompts },
  
  // 客户端工具处理器
  onClientTool: async (invocation) => {
    // 处理 switch_theme
    // 处理 record_fact
  },
  
  // 事件回调
  onResponseEnd: () => {},
  onThreadChange: () => {},
  onError: ({ error }) => {}
});
```

### 2. 客户端工具（Client Tools）

前端定义了两个客户端工具，在 `types/chatkit-tools.d.ts` 中声明：

```typescript
interface ClientToolInvocation<TArgs = Record<string, unknown>> {
  switch_theme(params: { theme: "light" | "dark" }): { success: boolean };
  record_fact(params: { fact_id: string; fact_text: string }): { success: boolean };
}
```

**处理流程：**
1. 后端 Agent 调用工具时，会发送客户端工具调用请求
2. 前端 `onClientTool` 回调接收请求
3. 前端执行操作（切换主题/保存 fact）
4. 返回执行结果给后端

### 3. API 通信配置（lib/config.ts）

```typescript
// ChatKit API 端点（对话流式接口）
export const CHATKIT_API_URL = 
  import.meta.env.VITE_CHATKIT_API_URL ?? "http://localhost:8001/chatkit";

// ChatKit Domain Key（安全验证）
export const CHATKIT_API_DOMAIN_KEY = 
  import.meta.env.VITE_CHATKIT_API_DOMAIN_KEY ?? "domain_pk_localhost_dev";

// Facts REST API 端点（可选，当前前端未使用）
export const FACTS_API_URL = 
  import.meta.env.VITE_FACTS_API_URL ?? "http://localhost:8001/facts";
```

### 4. Facts 状态管理（hooks/useFacts.ts）

**特点：**
- 纯前端状态管理（内存存储）
- 不依赖后端 REST API
- 通过客户端工具机制接收 fact 数据

**数据流：**
```
用户消息 → 后端 Agent 
  → 调用 save_fact 工具
  → 触发客户端工具 record_fact
  → 前端 onClientTool 回调
  → useFacts.performAction
  → 更新前端 facts 状态
```

## 前端依赖的后端接口

### 1. POST /chatkit（核心接口）

**请求：**
- Content-Type: application/json
- Body: ChatKit 协议消息（包含 thread_id, messages 等）

**响应：**
- Content-Type: text/event-stream（SSE 流式响应）
- 事件类型：
  - `text_delta`: 流式文本输出
  - `client_tool_call`: 客户端工具调用
  - `thread_item_done`: 消息完成
  - 其他 ChatKit 协议事件

### 2. GET /facts（可选，当前未使用）

获取所有保存的 facts 列表。

### 3. POST /facts/{fact_id}/save（可选，当前未使用）

标记 fact 为已保存状态。

## 前端技术栈

- **框架**: React 18 + TypeScript
- **构建工具**: Vite
- **UI 库**: @openai/chatkit-react
- **样式**: Tailwind CSS + CSS Modules
- **状态管理**: React Hooks（无需 Redux/Zustand）
- **HTTP 客户端**: ChatKit SDK 内置（基于 fetch）

## 数据流总结

```
用户输入消息
  ↓
ChatKit React 组件
  ↓
POST /chatkit (SSE 流)
  ↓
后端 Agent 处理
  ↓
流式返回事件
  ├─ text_delta → 前端展示打字效果
  ├─ client_tool_call → 前端执行客户端工具
  └─ thread_item_done → 完成标记
```

## 关键特性

1. **流式响应**：使用 SSE 实时显示 AI 回复
2. **客户端工具**：前端直接执行某些操作（主题切换、fact 保存）
3. **线程管理**：支持多会话（thread）管理
4. **主题系统**：支持亮色/暗色主题切换
5. **启动提示**：预设提示词快速开始对话

## 前端不需要改动的部分

✅ ChatKitPanel 组件（保持 ChatKit 协议）
✅ Facts 状态管理逻辑
✅ 主题系统
✅ UI 组件和样式

## 前端需要注意的配置

⚙️ 环境变量 `.env`:
```bash
VITE_CHATKIT_API_URL=http://localhost:8001/chatkit
VITE_CHATKIT_API_DOMAIN_KEY=domain_pk_localhost_dev
```

