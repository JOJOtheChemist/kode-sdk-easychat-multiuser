import{w as O}from"./chunk-NISHYRIK-DZZPl_mu.js";import{R as E,j as e}from"./index-CMJ4-CVj.js";import{a as A,u as F}from"./open-hands-axios-ClrcRGkQ.js";import{u as _,a as L}from"./use-config-Zfd3ADvo.js";import{S as j}from"./secrets-service-CDEmldwz.js";import{u as M}from"./use-is-authed-kuEynX9G.js";import{u as v,B as D}from"./brand-button-CsKuHua0.js";import{I as u,c as R}from"./utils-jvfsLBpK.js";import{S as k,O as q}from"./settings-input-BtoPbxLp.js";import{F as U,a as P}from"./index-0Pv5buiH.js";import{C as Q}from"./confirmation-modal-I1B4bWRf.js";import"./modal-backdrop-DNWwb-qL.js";const $=()=>{const{data:t}=_(),{data:s}=M(),r=t?.APP_MODE==="oss";return L({queryKey:["secrets"],queryFn:j.getSecrets,enabled:r||s})},K=()=>v({mutationFn:t=>j.deleteSecret(t)}),V=()=>v({mutationFn:({name:t,value:s,description:r})=>j.createSecret(t,s,r)}),z=()=>v({mutationFn:({secretToEdit:t,name:s,description:r})=>j.updateSecret(t,s,r)});function B({mode:t,selectedSecret:s,onCancel:r}){const d=A(),{t:c}=F(),{data:o}=$(),{mutate:x}=V(),{mutate:p}=z(),[f,S]=E.useState(null),h=t==="edit"&&s&&o?.find(a=>a.name===s)?.description?.trim()||"",N=(a,i,l)=>{x({name:a,value:i,description:l},{onSettled:r,onSuccess:async()=>{await d.invalidateQueries({queryKey:["secrets"]})}})},y=(a,i,l)=>{d.setQueryData(["secrets"],b=>b?b.map(m=>m.name===a?{...m,name:i,description:l}:m):[])},w=()=>{d.invalidateQueries({queryKey:["secrets"]})},C=(a,i,l)=>{y(a,i,l),p({secretToEdit:a,name:i,description:l},{onSettled:r,onError:w})},g=a=>{a.preventDefault();const i=new FormData(a.currentTarget),l=i.get("secret-name")?.toString(),b=i.get("secret-value")?.toString().trim(),m=i.get("secret-description")?.toString();if(l){if(S(null),o?.some(I=>I.name===l&&I.name!==s)){S(c("SECRETS$SECRET_ALREADY_EXISTS"));return}if(t==="add"){if(!b){S(c("SECRETS$SECRET_VALUE_REQUIRED"));return}N(l,b,m||void 0)}else t==="edit"&&s&&C(s,l,m||void 0)}},n=t==="add"?"add-secret-form":"edit-secret-form";return e.jsxs("form",{"data-testid":n,onSubmit:g,className:"flex flex-col items-start gap-6",children:[e.jsx(k,{testId:"name-input",name:"secret-name",type:"text",label:"Name",className:"w-full max-w-[350px]",required:!0,defaultValue:t==="edit"&&s?s:"",placeholder:c("SECRETS$API_KEY_EXAMPLE"),pattern:"^\\S*$"}),f&&e.jsx("p",{className:"text-red-500 text-sm",children:f}),t==="add"&&e.jsxs("label",{className:"flex flex-col gap-2.5 w-full max-w-[680px]",children:[e.jsx("span",{className:"text-sm",children:c(u.FORM$VALUE)}),e.jsx("textarea",{"data-testid":"value-input",name:"secret-value",required:!0,className:R("resize-none","bg-tertiary border border-[#717888] rounded-sm p-2 placeholder:italic placeholder:text-tertiary-alt","disabled:bg-[#2D2F36] disabled:border-[#2D2F36] disabled:cursor-not-allowed"),rows:8})]}),e.jsxs("label",{className:"flex flex-col gap-2.5 w-full max-w-[680px]",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm",children:c(u.FORM$DESCRIPTION)}),e.jsx(q,{})]}),e.jsx("input",{"data-testid":"description-input",name:"secret-description",defaultValue:h,className:R("resize-none","bg-tertiary border border-[#717888] rounded-sm p-2 placeholder:italic placeholder:text-tertiary-alt","disabled:bg-[#2D2F36] disabled:border-[#2D2F36] disabled:cursor-not-allowed")})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(D,{testId:"cancel-button",type:"button",variant:"secondary",onClick:r,children:c(u.BUTTON$CANCEL)}),e.jsxs(D,{testId:"submit-button",type:"submit",variant:"primary",children:[t==="add"&&c("SECRETS$ADD_SECRET"),t==="edit"&&c("SECRETS$EDIT_SECRET")]})]})]})}function T(){return e.jsxs("div",{className:"border-t border-[#717888] last-of-type:border-b max-w-[830px] pr-2.5 py-[13px] flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center justify-between w-1/3",children:[e.jsx("span",{className:"skeleton h-4 w-1/2"}),e.jsx("span",{className:"skeleton h-4 w-1/4"})]}),e.jsxs("div",{className:"flex items-center gap-8",children:[e.jsx("span",{className:"skeleton h-4 w-4"}),e.jsx("span",{className:"skeleton h-4 w-4"})]})]})}function G({title:t,description:s,onEdit:r,onDelete:d}){return e.jsxs("tr",{"data-testid":"secret-item",className:"flex w-full items-center border-t border-tertiary",children:[e.jsx("td",{className:"p-3 w-1/4 text-sm text-content-2 truncate",title:t,children:t}),e.jsx("td",{className:"p-3 w-1/2 truncate overflow-hidden whitespace-nowrap text-sm text-content-2 opacity-80 italic",title:s||"",children:s||""}),e.jsxs("td",{className:"p-3 w-1/4 flex items-center justify-end gap-4",children:[e.jsx("button",{"data-testid":"edit-secret-button",type:"button",onClick:r,"aria-label":`Edit ${t}`,className:"cursor-pointer",children:e.jsx(U,{size:16})}),e.jsx("button",{"data-testid":"delete-secret-button",type:"button",onClick:d,"aria-label":`Delete ${t}`,className:"cursor-pointer",children:e.jsx(P,{size:16})})]})]})}function Y(){const t=A(),{t:s}=F(),{data:r,isLoading:d}=$(),{mutate:c}=K(),[o,x]=E.useState("list"),[p,f]=E.useState(null),[S,h]=E.useState(!1),N=n=>{t.setQueryData(["secrets"],a=>a?a.filter(i=>i.name!==n):[])},y=()=>{t.invalidateQueries({queryKey:["secrets"]})},w=n=>{N(n),c(n,{onSettled:()=>{h(!1)},onError:y})},C=()=>{p&&w(p)},g=()=>{h(!1)};return e.jsxs("div",{"data-testid":"secrets-settings-screen",className:"flex flex-col gap-5",children:[d&&o==="list"&&e.jsxs("ul",{children:[e.jsx(T,{}),e.jsx(T,{}),e.jsx(T,{})]}),o==="list"&&e.jsx(D,{testId:"add-secret-button",type:"button",variant:"primary",onClick:()=>x("add-secret-form"),isDisabled:d,children:s("SECRETS$ADD_NEW_SECRET")}),o==="list"&&e.jsx("div",{className:"border border-tertiary rounded-md overflow-hidden",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-base-tertiary",children:e.jsxs("tr",{className:"flex w-full items-center",children:[e.jsx("th",{className:"w-1/4 text-left p-3 text-sm font-medium",children:s(u.SETTINGS$NAME)}),e.jsx("th",{className:"w-1/2 text-left p-3 text-sm font-medium",children:s(u.SECRETS$DESCRIPTION)}),e.jsx("th",{className:"w-1/4 text-right p-3 text-sm font-medium",children:s(u.SETTINGS$ACTIONS)})]})}),e.jsx("tbody",{children:r?.map(n=>e.jsx(G,{title:n.name,description:n.description,onEdit:()=>{x("edit-secret-form"),f(n.name)},onDelete:()=>{h(!0),f(n.name)}},n.name))})]})}),(o==="add-secret-form"||o==="edit-secret-form")&&e.jsx(B,{mode:o==="add-secret-form"?"add":"edit",selectedSecret:p,onCancel:()=>x("list")}),S&&e.jsx(Q,{text:s("SECRETS$CONFIRM_DELETE_KEY"),onConfirm:C,onCancel:g})]})}const ce=O(Y);export{ce as default};
