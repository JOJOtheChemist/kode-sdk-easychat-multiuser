# 06 前后端联调工作笔记

日期：2025-10-13  
作者：Codex 助手

## 目标

- 让前端 `http://localhost:3020` 能通过 Socket.IO 与后端桥接服务通信。
- 为前端提供其依赖的 REST API（配置、会话生命周期、设置等），确保页面加载和会话流程不再报错。

## 关键改动

- **会话存储**：在 `Kode-sdk/server/websocket-bridge.ts` 内新增内存级会话仓库，生成 `conversation_id`、`session_api_key`、运行状态等字段，保持 REST 与 WebSocket 视图一致。
- **REST 路由补全**：实现 `/api/options/*`、`/api/settings`、`/api/auth/user`、`/api/user/info`、`/api/conversations/*` 等端点，覆盖创建、查询、启动、停止、删除会话以及配置、轨迹、微代理、文件相关占位接口。
- **Socket.IO 协议**：支持 `conversation_id` 参数自动建档；在收到用户消息后回写最新元数据，保证前端事件流与会话列表同步。
- **工具与模型初始化**：沿用 GLM-4.5-air 模型与内置工具注册，前端发送消息后 Kode Agent 可持续输出回复、工具调用事件。

## 验证

1. `npm run server` 启动后端桥接服务，确认日志输出各路由 ready。
2. `curl` 测试 `/health`、`/api/settings`、`/api/conversations` 等返回 JSON。
3. 多次 `POST /api/conversations` 创建会话，再访问 `GET /api/conversations/:id`、`/start`，结果均为 200。

## 前端最小化改造（追加）

- 将 `entry.client` 切换到 `MinimalApp`，只渲染对话界面，移除登录、仓库选择等入口。
- 将 `root-layout`、`home`、`conversations/:id` 路由改写为调用同一 `ChatPage`，仅保留聊天面板和状态栏。
- 新建的对话页直接使用 `socket.io-client` 连接桥接服务，展示用户消息、模型回复以及工具执行开始/结束提示。
- 禁用 PostHog，避免额外网络请求导致的 404/401 噪声日志。

## 后续建议

- 前端完成重新连接后，手动在浏览器新建对话，确认消息、工具调用流无误。
- 若需要显示 Git 变更、任务推荐等高级模块，可基于当前占位路由补充真实逻辑或代理到实际服务。
