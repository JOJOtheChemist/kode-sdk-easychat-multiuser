# GLM æ¨¡å‹åç«¯å¤æµ‹æŠ¥å‘Š - 2025å¹´10æœˆ14æ—¥

## é—®é¢˜è¯Šæ–­

### ç”¨æˆ·åé¦ˆé—®é¢˜

ç”¨æˆ·è®¿é—® `http://localhost:4311/demo/conversations/1`ï¼Œå‘é€æ¶ˆæ¯"ä½ å¥½ï¼Œæˆ‘æ˜¯å°ç¾"åï¼š
- â“ æ¶ˆæ¯æ˜¯å¦æˆåŠŸå‘é€ç»™å¤§æ¨¡å‹ï¼Ÿ
- â“ å¤§æ¨¡å‹æ˜¯å¦æˆåŠŸå›å¤ï¼Ÿ
- â“ ä¸ºä»€ä¹ˆå›å¤æ²¡æœ‰æ¸²æŸ“åˆ°æ°”æ³¡é‡Œï¼Ÿ

### è¯Šæ–­è¿‡ç¨‹

#### 1. åç«¯æœåŠ¡çŠ¶æ€æ£€æŸ¥

```bash
# åç«¯å¥åº·æ£€æŸ¥
curl http://localhost:3000/health
# âœ… å“åº”: {"status":"ok","timestamp":"2025-10-14T06:33:39.796Z"}

# åç«¯è¿›ç¨‹
ps aux | grep tsx | grep server.ts
# âœ… è¿›ç¨‹ 12907 æ­£åœ¨è¿è¡Œ
```

#### 2. å‰ç«¯æœåŠ¡çŠ¶æ€æ£€æŸ¥

```bash
# å‰ç«¯ç«¯å£æ£€æŸ¥
lsof -i :4311 | grep LISTEN
# âœ… è¿›ç¨‹ 67082 åœ¨ç›‘å¬ç«¯å£ 4311

# å‰ç«¯ç«¯å£æ£€æŸ¥
lsof -i :4310 | grep LISTEN  
# âœ… è¿›ç¨‹ 59858 åœ¨ç›‘å¬ç«¯å£ 4310
```

#### 3. ä»£ç é€»è¾‘åˆ†æ

**å…³é”®å‘ç°ï¼šURLå‚æ•°è¢«å¿½ç•¥ï¼**

æŸ¥çœ‹ `frontend/src/routes/demo-conversation.tsx`ï¼š

```typescript
// âŒ é—®é¢˜ï¼šç»„ä»¶æ²¡æœ‰ä½¿ç”¨ URL ä¸­çš„ conversationId å‚æ•°
const DemoConversationRoute: React.FC = () => {
  const [conversationId, setConversationId] = React.useState<string | null>(null);
  
  // åœ¨ useEffect ä¸­ç›´æ¥åˆ›å»ºæ–°ä¼šè¯ï¼Œå¿½ç•¥äº† URL å‚æ•°
  React.useEffect(() => {
    initializeConversation();  // æ€»æ˜¯åˆ›å»ºæ–°ä¼šè¯ï¼
    return () => {
      eventSourceRef.current?.close();
    };
  }, [initializeConversation]);
  
  const initializeConversation = React.useCallback(async () => {
    // åˆ›å»ºå…¨æ–°çš„ä¼šè¯ ID
    const response = await fetch(`${BACKEND_BASE_URL}/api/conversations`, {
      method: "POST",
    });
    const data = await response.json();
    setConversationId(data.conversationId);  // conv_1760423658501
    // ...
  }, []);
}
```

**å¯¹æ¯”æ­£å¸¸è·¯ç”± `conversation.tsx`ï¼š**

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ URL å‚æ•°
function AppContent() {
  const { conversationId } = useConversationId();  // ä» URL è·å–
  const { data: conversation } = useActiveConversation();
  // ...
}
```

### é—®é¢˜æ ¹å› 

1. **URLå‚æ•°æœªä½¿ç”¨**ï¼šè®¿é—® `/demo/conversations/1` æ—¶ï¼ŒURLä¸­çš„ `1` è¢«å®Œå…¨å¿½ç•¥
2. **æ€»æ˜¯åˆ›å»ºæ–°ä¼šè¯**ï¼šæ¯æ¬¡åˆ·æ–°é¡µé¢éƒ½ä¼šè°ƒç”¨ `initializeConversation()`ï¼Œåˆ›å»ºæ–°çš„ä¼šè¯IDï¼ˆå¦‚ `conv_1760423658501`ï¼‰
3. **äº‹ä»¶æµè¿æ¥é”™è¯¯**ï¼šå‰ç«¯è¿æ¥åˆ°æ–°åˆ›å»ºçš„ä¼šè¯IDçš„äº‹ä»¶æµï¼Œè€Œä¸æ˜¯URLä¸­æŒ‡å®šçš„ä¼šè¯

### é—®é¢˜å½±å“

- âœ… æ¶ˆæ¯**ç¡®å®**å‘é€åˆ°äº†å¤§æ¨¡å‹
- âœ… å¤§æ¨¡å‹**ç¡®å®**å›å¤äº†
- âŒ ä½†å›å¤å‘é€åˆ°äº†**é”™è¯¯çš„ä¼šè¯ID**ï¼Œå¯¼è‡´å‰ç«¯æ— æ³•æ¥æ”¶

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä½¿ç”¨URLå‚æ•°ï¼ˆæ¨èï¼‰

ä¿®æ”¹ `demo-conversation.tsx` ä½¿ç”¨URLå‚æ•°ï¼š

```typescript
import { useParams } from "react-router";

const DemoConversationRoute: React.FC = () => {
  const params = useParams();
  const urlConversationId = params.conversationId;
  
  const [conversationId, setConversationId] = React.useState<string | null>(
    urlConversationId || null
  );
  
  React.useEffect(() => {
    if (urlConversationId) {
      // å¦‚æœ URL æœ‰ conversationIdï¼Œç›´æ¥ä½¿ç”¨
      setConversationId(urlConversationId);
      openEventStream(urlConversationId);
    } else {
      // å¦åˆ™åˆ›å»ºæ–°ä¼šè¯
      initializeConversation();
    }
  }, [urlConversationId]);
  
  // ...
}
```

### æ–¹æ¡ˆ2ï¼šé‡å®šå‘åˆ°æ­£ç¡®çš„URL

ä¿®æ”¹åˆå§‹åŒ–é€»è¾‘ï¼Œåˆ›å»ºä¼šè¯åé‡å®šå‘ï¼š

```typescript
import { useNavigate } from "react-router";

const DemoConversationRoute: React.FC = () => {
  const navigate = useNavigate();
  const params = useParams();
  
  const initializeConversation = React.useCallback(async () => {
    const response = await fetch(`${BACKEND_BASE_URL}/api/conversations`, {
      method: "POST",
    });
    const data = await response.json();
    
    // é‡å®šå‘åˆ°æ–°åˆ›å»ºçš„ä¼šè¯ URL
    navigate(`/demo/conversations/${data.conversationId}`, { replace: true });
  }, [navigate]);
}
```

### æ–¹æ¡ˆ3ï¼šä¿®æ”¹è·¯ç”±ç»“æ„ï¼ˆæœ€ç®€å•ï¼‰

å¦‚æœdemoåªéœ€è¦ä¸€ä¸ªä¼šè¯ï¼Œå¯ä»¥æ”¹ç”¨å›ºå®šè·¯ç”±ï¼š

```typescript
// routes.ts
route("demo/conversation", "routes/demo-conversation.tsx")  // æ— å‚æ•°

// demo-conversation.tsx ä¿æŒç°æœ‰é€»è¾‘ä¸å˜
```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **åˆ›å»ºä¼šè¯**
```bash
curl -X POST http://localhost:3000/api/conversations
# å“åº”: {"conversationId":"conv_123","agentId":"agt_conv_123",...}
```

2. **å‘é€æ¶ˆæ¯**
```bash
curl -X POST http://localhost:3000/api/conversations/conv_123/messages \
  -H "Content-Type: application/json" \
  -d '{"content":"ä½ å¥½ï¼Œæˆ‘æ˜¯å°ç¾"}'
```

3. **ç›‘å¬äº‹ä»¶æµ**
```bash
curl -N http://localhost:3000/api/conversations/conv_123/events
```

4. **å‰ç«¯è®¿é—®**
```
http://localhost:4311/demo/conversations/conv_123
```

### é¢„æœŸç»“æœ

- âœ… äº‹ä»¶æµæ­£å¸¸æ¥æ”¶ `text_chunk` äº‹ä»¶
- âœ… åŠ©æ‰‹æ¶ˆæ¯æ­£ç¡®æ¸²æŸ“åˆ°æ°”æ³¡
- âœ… å·¥å…·è°ƒç”¨æ­£å¸¸æ˜¾ç¤º

## é¢å¤–å‘ç°

### åç«¯æ—¥å¿—è¾“å‡º

æŸ¥çœ‹åç«¯æ§åˆ¶å°ï¼ˆè¿›ç¨‹12907ï¼‰ï¼Œåº”è¯¥èƒ½çœ‹åˆ°ï¼š

```
ğŸ’¬ User message: ä½ å¥½ï¼Œæˆ‘æ˜¯å°ç¾
ä½ å¥½ï¼æˆ‘æ˜¯ä¸€ä¸ªå‹å¥½çš„AIåŠ©æ‰‹...
âœ… Message queued: msg_xxx
ğŸ Conversation done (step 1)
```

### å‰ç«¯åˆå§‹æ¶ˆæ¯é—®é¢˜

ä»£ç ä¸­è®¾ç½®äº†åˆå§‹æç¤ºï¼š

```typescript
const INITIAL_PROMPT = "ä½ å¥½";
```

ä½†è¿™åªæ˜¯è¾“å…¥æ¡†çš„é»˜è®¤å€¼ï¼Œä¸ä¼šè‡ªåŠ¨å‘é€ã€‚

## å»ºè®®æ”¹è¿›

1. **æ·»åŠ è°ƒè¯•ä¿¡æ¯**ï¼šåœ¨å‰ç«¯æ˜¾ç¤ºå½“å‰ä½¿ç”¨çš„ conversationId
2. **é”™è¯¯æç¤ºä¼˜åŒ–**ï¼šå½“ä¼šè¯ä¸å­˜åœ¨æ—¶ç»™å‡ºæ˜ç¡®æç¤º
3. **URLåŒæ­¥**ï¼šç¡®ä¿URLå§‹ç»ˆåæ˜ å½“å‰ä¼šè¯ID
4. **å†å²ä¼šè¯æ”¯æŒ**ï¼šæ”¯æŒé€šè¿‡URLè®¿é—®å†å²ä¼šè¯

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

- [ ] å®æ–½æ–¹æ¡ˆ1æˆ–æ–¹æ¡ˆ2ä¿®å¤URLå‚æ•°é—®é¢˜
- [ ] æ·»åŠ å‰ç«¯è°ƒè¯•ä¿¡æ¯æ˜¾ç¤º
- [ ] å®Œæ•´æµ‹è¯•æ¶ˆæ¯å‘é€å’Œæ¥æ”¶æµç¨‹
- [ ] æ›´æ–°ç”¨æˆ·æ–‡æ¡£è¯´æ˜æ­£ç¡®çš„è®¿é—®æ–¹å¼
