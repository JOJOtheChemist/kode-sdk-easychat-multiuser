# GLM 模型后端复测报告 - 2025年10月14日

## 问题诊断

### 用户反馈问题

用户访问 `http://localhost:4311/demo/conversations/1`，发送消息"你好，我是小美"后：
- ❓ 消息是否成功发送给大模型？
- ❓ 大模型是否成功回复？
- ❓ 为什么回复没有渲染到气泡里？

### 诊断过程

#### 1. 后端服务状态检查

```bash
# 后端健康检查
curl http://localhost:3000/health
# ✅ 响应: {"status":"ok","timestamp":"2025-10-14T06:33:39.796Z"}

# 后端进程
ps aux | grep tsx | grep server.ts
# ✅ 进程 12907 正在运行
```

#### 2. 前端服务状态检查

```bash
# 前端端口检查
lsof -i :4311 | grep LISTEN
# ✅ 进程 67082 在监听端口 4311

# 前端端口检查
lsof -i :4310 | grep LISTEN  
# ✅ 进程 59858 在监听端口 4310
```

#### 3. 代码逻辑分析

**关键发现：URL参数被忽略！**

查看 `frontend/src/routes/demo-conversation.tsx`：

```typescript
// ❌ 问题：组件没有使用 URL 中的 conversationId 参数
const DemoConversationRoute: React.FC = () => {
  const [conversationId, setConversationId] = React.useState<string | null>(null);
  
  // 在 useEffect 中直接创建新会话，忽略了 URL 参数
  React.useEffect(() => {
    initializeConversation();  // 总是创建新会话！
    return () => {
      eventSourceRef.current?.close();
    };
  }, [initializeConversation]);
  
  const initializeConversation = React.useCallback(async () => {
    // 创建全新的会话 ID
    const response = await fetch(`${BACKEND_BASE_URL}/api/conversations`, {
      method: "POST",
    });
    const data = await response.json();
    setConversationId(data.conversationId);  // conv_1760423658501
    // ...
  }, []);
}
```

**对比正常路由 `conversation.tsx`：**

```typescript
// ✅ 正确：使用 URL 参数
function AppContent() {
  const { conversationId } = useConversationId();  // 从 URL 获取
  const { data: conversation } = useActiveConversation();
  // ...
}
```

### 问题根因

1. **URL参数未使用**：访问 `/demo/conversations/1` 时，URL中的 `1` 被完全忽略
2. **总是创建新会话**：每次刷新页面都会调用 `initializeConversation()`，创建新的会话ID（如 `conv_1760423658501`）
3. **事件流连接错误**：前端连接到新创建的会话ID的事件流，而不是URL中指定的会话

### 问题影响

- ✅ 消息**确实**发送到了大模型
- ✅ 大模型**确实**回复了
- ❌ 但回复发送到了**错误的会话ID**，导致前端无法接收

## 解决方案

### 方案1：使用URL参数（推荐）

修改 `demo-conversation.tsx` 使用URL参数：

```typescript
import { useParams } from "react-router";

const DemoConversationRoute: React.FC = () => {
  const params = useParams();
  const urlConversationId = params.conversationId;
  
  const [conversationId, setConversationId] = React.useState<string | null>(
    urlConversationId || null
  );
  
  React.useEffect(() => {
    if (urlConversationId) {
      // 如果 URL 有 conversationId，直接使用
      setConversationId(urlConversationId);
      openEventStream(urlConversationId);
    } else {
      // 否则创建新会话
      initializeConversation();
    }
  }, [urlConversationId]);
  
  // ...
}
```

### 方案2：重定向到正确的URL

修改初始化逻辑，创建会话后重定向：

```typescript
import { useNavigate } from "react-router";

const DemoConversationRoute: React.FC = () => {
  const navigate = useNavigate();
  const params = useParams();
  
  const initializeConversation = React.useCallback(async () => {
    const response = await fetch(`${BACKEND_BASE_URL}/api/conversations`, {
      method: "POST",
    });
    const data = await response.json();
    
    // 重定向到新创建的会话 URL
    navigate(`/demo/conversations/${data.conversationId}`, { replace: true });
  }, [navigate]);
}
```

### 方案3：修改路由结构（最简单）

如果demo只需要一个会话，可以改用固定路由：

```typescript
// routes.ts
route("demo/conversation", "routes/demo-conversation.tsx")  // 无参数

// demo-conversation.tsx 保持现有逻辑不变
```

## 测试验证

### 测试步骤

1. **创建会话**
```bash
curl -X POST http://localhost:3000/api/conversations
# 响应: {"conversationId":"conv_123","agentId":"agt_conv_123",...}
```

2. **发送消息**
```bash
curl -X POST http://localhost:3000/api/conversations/conv_123/messages \
  -H "Content-Type: application/json" \
  -d '{"content":"你好，我是小美"}'
```

3. **监听事件流**
```bash
curl -N http://localhost:3000/api/conversations/conv_123/events
```

4. **前端访问**
```
http://localhost:4311/demo/conversations/conv_123
```

### 预期结果

- ✅ 事件流正常接收 `text_chunk` 事件
- ✅ 助手消息正确渲染到气泡
- ✅ 工具调用正常显示

## 额外发现

### 后端日志输出

查看后端控制台（进程12907），应该能看到：

```
💬 User message: 你好，我是小美
你好！我是一个友好的AI助手...
✅ Message queued: msg_xxx
🏁 Conversation done (step 1)
```

### 前端初始消息问题

代码中设置了初始提示：

```typescript
const INITIAL_PROMPT = "你好";
```

但这只是输入框的默认值，不会自动发送。

## 建议改进

1. **添加调试信息**：在前端显示当前使用的 conversationId
2. **错误提示优化**：当会话不存在时给出明确提示
3. **URL同步**：确保URL始终反映当前会话ID
4. **历史会话支持**：支持通过URL访问历史会话

## 下一步行动

- [ ] 实施方案1或方案2修复URL参数问题
- [ ] 添加前端调试信息显示
- [ ] 完整测试消息发送和接收流程
- [ ] 更新用户文档说明正确的访问方式
