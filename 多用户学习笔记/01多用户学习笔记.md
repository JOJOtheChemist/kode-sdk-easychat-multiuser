# 多用户会话管理经验总结

## 核心原理：共享配置 + 独立实例

### 1. 配置共享（静态）
- Agent配置（工具列表、系统提示词等）只有一份
- 所有会话读取相同的配置文件
- 节省内存，易于维护

### 2. 独立实例（动态）
- 每个 `userId:sessionId` 组合创建独立Agent实例
- 独立的运行时状态和内存
- 数据完全隔离

### 3. 工具注册（共享）
- 工具函数在系统级别注册一次
- 所有Agent实例都可调用

## 实现方式

```typescript
// 1. 共享配置
const agentConfig = getAgentConfig('schedule-assistant');

// 2. 独立存储
const storePath = `./.kode/${agentId}`;  // 独立目录
const store = new JSONStore(storePath);

// 3. 独立实例
const agent = await Agent.create({
  agentId: `${sessionId}:${agentId}`,  // 唯一标识
  ...
}, deps);
```

## 目录结构
```
.kode/
├── schedule-assistant/                    // 用户yeya的会话
│   └── schedule-assistant/
│       └── runtime/
│           └── messages.json
└── independent_session:schedule-assistant/  // 用户test_user的独立会话
    └── independent_session:schedule-assistant/
        └── runtime/
            └── messages.json
```

## API调用示例

```json
// 用户A的会话
{
  "userId": "yeya",
  "agentId": "schedule-assistant",
  "sessionId": "session_A"  // 可选，默认使用agentId
}

// 用户B的独立会话
{
  "userId": "test_user",
  "agentId": "schedule-assistant",
  "sessionId": "independent_session"
}
```

## 锁机制

系统使用 `userId:sessionId` 作为锁键，确保：
- 同一用户同一会话串行处理
- 不同用户或不同会话可并行处理
- 避免数据竞争

## 并发测试结果

### 测试1：简单对话并发
- **会话1**：创建日程（2.19秒）
- **会话2**：查询日程（16.73秒，调用8次工具）
- **结果**：✅ 真正并行处理，互不干扰

### 测试2：并发创建日程
- **会话1**：用户1创建今天下午会议
  - 成功调用 `create_schedule` 工具
  - 创建日程ID: 13039
  - 独立存储: `concurrent_create_1:schedule-assistant`
- **会话2**：用户2创建明天上午学习
  - 成功调用 `create_schedule` 工具
  - 创建日程ID: 13040+
  - 独立存储: `concurrent_create_2:schedule-assistant`
- **结果**：✅ 完全并发，数据隔离，工具调用成功

### 并发性能分析
```bash
# 时间戳对比
15:02:22 - 两个请求几乎同时到达（差<1ms）
15:02:24 - 会话1完成（2秒）
15:02:38 - 会话2完成（16秒）

# 存储隔离
.koke/
├── concurrent_create_1:schedule-assistant/  # 独立存储
└── concurrent_create_2:schedule-assistant/  # 独立存储
```

## 关键发现

1. **真正的并发**：不同 `sessionId` 可以真正并行处理
2. **工具调用安全**：并发调用工具不会互相干扰
3. **锁机制精确**：锁键为 `userId:sessionId`，粒度准确
4. **资源独立**：每个会话有独立的运行时和存储

## 优势

✅ **内存效率**：配置只加载一次  
✅ **数据隔离**：每个会话独立存储  
✅ **并发安全**：多用户互不干扰  
✅ **易于维护**：修改配置影响所有会话  
✅ **扩展性好**：支持无限用户和会话  
✅ **工具并发**：多用户可同时调用相同工具  
✅ **性能优良**：无阻塞，真正并行处理