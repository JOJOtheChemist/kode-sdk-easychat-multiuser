# å­˜å‚¨ç»“æ„ä¼˜åŒ– - æ‰å¹³åŒ–æ”¹é€ 

> **æ—¥æœŸ**: 2025-10-21  
> **ä»»åŠ¡**: ä¼˜åŒ– kode-sdk å­˜å‚¨è·¯å¾„ï¼Œæ¶ˆé™¤å¤šå±‚åµŒå¥—é—®é¢˜  
> **ç»“æœ**: âœ… å®Œå…¨æˆåŠŸ

---

## ä¸€ã€é—®é¢˜èƒŒæ™¯

åœ¨ä½¿ç”¨å¤šç”¨æˆ·å¤šä¼šè¯åŠŸèƒ½æ—¶ï¼Œå‘ç°å­˜å‚¨è·¯å¾„å­˜åœ¨ä¸¥é‡çš„åµŒå¥—é—®é¢˜ï¼š

### æ—§çš„åµŒå¥—ç»“æ„

```
.kode/
â””â”€â”€ user1/
    â””â”€â”€ concurrent_test_1/
        â””â”€â”€ schedule-assistant/
            â””â”€â”€ user1:concurrent_test_1:schedule-assistant/  âŒ é‡å¤åµŒå¥—
                â”œâ”€â”€ runtime/
                â”‚   â”œâ”€â”€ messages.json
                â”‚   â””â”€â”€ tool-calls.json
                â””â”€â”€ events/
                    â”œâ”€â”€ progress.log
                    â””â”€â”€ monitor.log
```

**é—®é¢˜åˆ†æ**:
1. âŒ è·¯å¾„åµŒå¥— 4-5 å±‚ï¼Œè¿‡äºå¤æ‚
2. âŒ `user1:concurrent_test_1:schedule-assistant` ä¿¡æ¯é‡å¤
3. âŒ ç›®å½•ååŒ…å«å†’å·ï¼Œä¸å¤Ÿæ¸…æ™°
4. âŒ å¤šä½™çš„ `schedule-assistant` å±‚çº§æ²¡æœ‰å®é™…æ„ä¹‰

### æœŸæœ›çš„æ‰å¹³ç»“æ„

```
.kode/
â”œâ”€â”€ user1/
â”‚   â”œâ”€â”€ session1/          âœ… ä¼šè¯1
â”‚   â”‚   â”œâ”€â”€ runtime/
â”‚   â”‚   â””â”€â”€ events/
â”‚   â””â”€â”€ session2/          âœ… ä¼šè¯2
â”‚       â”œâ”€â”€ runtime/
â”‚       â””â”€â”€ events/
â””â”€â”€ user2/
    â”œâ”€â”€ session1/          âœ… ä¼šè¯1
    â”‚   â”œâ”€â”€ runtime/
    â”‚   â””â”€â”€ events/
    â””â”€â”€ session2/          âœ… ä¼šè¯2
        â”œâ”€â”€ runtime/
        â””â”€â”€ events/
```

**ä¼˜åŒ–ç›®æ ‡**:
- âœ… åªéœ€ 3 å±‚ç›®å½•ï¼ˆç”¨æˆ·/ä¼šè¯/ç±»å‹ï¼‰
- âœ… æ¸…æ™°çš„å‘½åè§„èŒƒ
- âœ… æ˜“äºç†è§£å’Œç®¡ç†

---

## äºŒã€é—®é¢˜æ ¹æºåˆ†æ

### åŸå› åˆ†æ

ç»è¿‡ä»£ç è¿½è¸ªï¼Œå‘ç°é—®é¢˜å‡ºåœ¨ä¸‰ä¸ªåœ°æ–¹çš„è·¯å¾„æ‹¼æ¥ï¼š

#### 1. `server/routes/chat.ts` (ç¬¬ 76 è¡Œ)

ç”Ÿæˆå®Œæ•´çš„ agentIdï¼š

```typescript
const agentIdForSession = sessionId 
  ? `${userId}:${sessionId}:${agentId}` 
  : agentId;

// ç»“æœ: "user1:concurrent_test_1:schedule-assistant"
```

#### 2. `server/services/agent-service.ts` (ç¬¬ 38-39 è¡Œ)

æ—§ä»£ç å°† agentId è½¬æ¢ä¸ºè·¯å¾„ï¼š

```typescript
// âŒ æ—§ä»£ç 
const agentIdForPath = agentId.replace(/:/g, '/');
const storePath = `./.kode/${agentIdForPath}`;

// ç»“æœ: .kode/user1/concurrent_test_1/schedule-assistant
```

#### 3. `src/infra/store.ts` (JSONStore)

JSONStore åœ¨ baseDir åè‡ªåŠ¨æ·»åŠ  agentId å±‚ï¼š

```typescript
private getAgentDir(agentId: string): string {
  return path.join(this.baseDir, agentId);
}

private getRuntimePath(agentId: string, file: string): string {
  const dir = path.join(this.baseDir, agentId, 'runtime');
  return path.join(dir, file);
}
```

**æœ€ç»ˆè·¯å¾„æ‹¼æ¥è¿‡ç¨‹**:
```
baseDir:  .kode/user1/concurrent_test_1/schedule-assistant
agentId:  user1:concurrent_test_1:schedule-assistant
---------------------------------------------------------
ç»“æœ:     .kode/user1/concurrent_test_1/schedule-assistant/
          user1:concurrent_test_1:schedule-assistant/runtime/  âŒ
```

---

## ä¸‰ã€è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

åˆ©ç”¨ JSONStore è‡ªåŠ¨æ·»åŠ  agentId çš„ç‰¹æ€§ï¼Œè°ƒæ•´è·¯å¾„åˆ†é…ï¼š

- **baseDir**: åªåˆ°ç”¨æˆ·å±‚ `.kode/userId`
- **agentId**: ä½¿ç”¨ sessionIdï¼ˆä¼šè¯æ ‡è¯†ï¼‰
- **æœ€ç»ˆè·¯å¾„**: JSONStore è‡ªåŠ¨ç”Ÿæˆ `.kode/userId/sessionId/runtime/`

### ä¿®æ”¹ä»£ç 

**æ–‡ä»¶**: `/Users/yeya/FlutterProjects/kode-sdk/kode-sdk/server/services/agent-service.ts`

```typescript
console.log(`ğŸ†• [åˆ›å»º] åˆå§‹åŒ– Agent: ${agentId}`);

// ğŸ”¥ ä¼˜åŒ–å­˜å‚¨ç»“æ„ï¼šuserId/sessionId/ï¼ˆæ‰å¹³åŒ–ï¼Œé¿å…å¤šå±‚åµŒå¥—ï¼‰
// agentId æ ¼å¼: userId:sessionId:agentType (ä¾‹å¦‚: user1:concurrent_test_1:schedule-assistant)
// JSONStore ä¼šåœ¨ baseDir åè‡ªåŠ¨æ·»åŠ  agentId ä½œä¸ºå­ç›®å½•
// æ‰€ä»¥ï¼šbaseDir=.kode/userId, agentId=sessionId
// æœ€ç»ˆè·¯å¾„ï¼š.kode/userId/sessionId/runtime/ å’Œ .kode/userId/sessionId/events/
const parts = agentId.split(':');
let storePath: string;
let storeAgentId: string;

if (parts.length === 3) {
  // å¤šç”¨æˆ·å¤šä¼šè¯æ¨¡å¼: user1:session1:agent-type
  const [userId, sessionId, agentType] = parts;
  storePath = `./.kode/${userId}`;  // baseDir åªåˆ°ç”¨æˆ·å±‚
  storeAgentId = sessionId;  // sessionId ä½œä¸º agentIdï¼ŒJSONStore ä¼šè‡ªåŠ¨æ·»åŠ è¿™ä¸€å±‚
  console.log(`ğŸ“ [å­˜å‚¨] ç”¨æˆ·: ${userId}, ä¼šè¯: ${sessionId}, æœ€ç»ˆè·¯å¾„: ${storePath}/${storeAgentId}/`);
} else {
  // å…¼å®¹æ¨¡å¼: åŸå§‹å•å±‚ agentId
  storePath = `./.kode`;
  storeAgentId = agentId;
  console.log(`ğŸ“ [å­˜å‚¨] å…¼å®¹æ¨¡å¼ï¼ŒAgent: ${agentId}, æœ€ç»ˆè·¯å¾„: ${storePath}/${agentId}/`);
}

const store = new JSONStore(storePath);
```

**å…³é”®æ”¹åŠ¨**:

| é¡¹ç›® | ä¿®æ”¹å‰ | ä¿®æ”¹å |
|------|--------|--------|
| storePath | `.kode/user1/session1/agent-type` | `.kode/user1` |
| storeAgentId | `runtime` (å›ºå®šå€¼) | `session1` (ä¼šè¯ID) |
| æœ€ç»ˆè·¯å¾„ | `.kode/user1/session1/agent-type/runtime/runtime/` âŒ | `.kode/user1/session1/runtime/` âœ… |

### åŒæ­¥ä¿®æ”¹ Agent åˆ›å»º

```typescript
// æ£€æŸ¥æ˜¯å¦å­˜åœ¨å†å²æ•°æ®ï¼ˆä½¿ç”¨å†…éƒ¨å­˜å‚¨IDï¼‰
const exists = await deps.store.exists(storeAgentId);
let agent: Agent;

if (exists) {
  console.log(`ğŸ“‚ [æ¢å¤] ä» Store æ¢å¤ Agent: ${agentId} (å­˜å‚¨ID: ${storeAgentId})`);
  agent = await Agent.resumeFromStore(storeAgentId, deps);
  console.log(`âœ… [æ¢å¤] Agent æ¢å¤æˆåŠŸï¼Œæ¶ˆæ¯å†å²å·²åŠ è½½`);
} else {
  console.log(`ğŸ”§ [åˆ›å»º] åˆ›å»ºæ–° Agent: ${agentId} (å­˜å‚¨ID: ${storeAgentId})`);
  agent = await Agent.create(
    {
      agentId: storeAgentId, // ä½¿ç”¨ç®€åŒ–çš„å­˜å‚¨ID
      templateId: agentConfig.templateId,
      sandbox: { kind: 'local', workDir: config.agent.workDir },
      exposeThinking: true,
      metadata: {
        toolTimeoutMs: config.agent.toolTimeoutMs,
        maxToolConcurrency: config.agent.maxToolConcurrency,
      },
    },
    deps
  );
  console.log(`âœ… [åˆ›å»º] Agent åˆ›å»ºå®Œæˆ`);
}
```

---

## å››ã€æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **æ¸…é™¤æ—§æ•°æ®**
   ```bash
   cd /Users/yeya/FlutterProjects/kode-sdk/kode-sdk
   rm -rf .kode/user*
   ```

2. **é‡å¯æœåŠ¡å™¨**
   ```bash
   bash restart-backend.sh
   ```

3. **è¿è¡Œæµ‹è¯•è„šæœ¬**
   ```bash
   node /Users/yeya/FlutterProjects/kode-sdk/å¤šç”¨æˆ·å­¦ä¹ ç¬”è®°/concurrent-test-1.js
   node /Users/yeya/FlutterProjects/kode-sdk/å¤šç”¨æˆ·å­¦ä¹ ç¬”è®°/concurrent-test-2.js
   ```

### æµ‹è¯•ç»“æœ

#### âœ… ç›®å½•ç»“æ„éªŒè¯

```bash
$ find .kode -type d | grep -E "(user1|user2)" | sort

.kode/user1
.kode/user1/concurrent_test_1
.kode/user1/concurrent_test_1/events
.kode/user1/concurrent_test_1/runtime
.kode/user2
.kode/user2/concurrent_test_2
.kode/user2/concurrent_test_2/events
.kode/user2/concurrent_test_2/runtime
```

**ç»“æ„å›¾**:
```
.kode/
â”œâ”€â”€ user1/
â”‚   â””â”€â”€ concurrent_test_1/        âœ… ä¼šè¯1
â”‚       â”œâ”€â”€ events/
â”‚       â”‚   â”œâ”€â”€ monitor.log
â”‚       â”‚   â””â”€â”€ progress.log
â”‚       â”œâ”€â”€ runtime/
â”‚       â”‚   â”œâ”€â”€ messages.json
â”‚       â”‚   â””â”€â”€ tool-calls.json
â”‚       â””â”€â”€ meta.json
â””â”€â”€ user2/
    â””â”€â”€ concurrent_test_2/        âœ… ä¼šè¯2
        â”œâ”€â”€ events/
        â”‚   â”œâ”€â”€ monitor.log
        â”‚   â””â”€â”€ progress.log
        â”œâ”€â”€ runtime/
        â”‚   â”œâ”€â”€ messages.json
        â”‚   â””â”€â”€ tool-calls.json
        â””â”€â”€ meta.json
```

#### âœ… åŠŸèƒ½éªŒè¯

| æµ‹è¯•é¡¹ | ç»“æœ | è¯´æ˜ |
|-------|------|------|
| æµ‹è¯•1 (user1åˆ›å»ºæ—¥ç¨‹) | âœ… æˆåŠŸ | 13ç§’ï¼Œåˆ›å»ºè®°å½•#13066 |
| æµ‹è¯•2 (user2æŸ¥è¯¢æ—¥ç¨‹) | âœ… æˆåŠŸ | 11ç§’ï¼Œæ™ºèƒ½æŸ¥è¯¢æ˜æ—¥æ—¥ç¨‹ |
| ç”¨æˆ·éš”ç¦» | âœ… æ­£å¸¸ | user1 å’Œ user2 æ•°æ®å®Œå…¨éš”ç¦» |
| ä¼šè¯éš”ç¦» | âœ… æ­£å¸¸ | ä¸åŒ sessionId ç‹¬ç«‹å­˜å‚¨ |
| æ•°æ®æŒä¹…åŒ– | âœ… æ­£å¸¸ | messages å’Œ tool-calls æ­£ç¡®ä¿å­˜ |
| äº‹ä»¶æµ | âœ… æ­£å¸¸ | progress å’Œ monitor äº‹ä»¶æ­£å¸¸è®°å½• |

#### âœ… æœåŠ¡å™¨æ—¥å¿—éªŒè¯

**ç”¨æˆ·1åˆ›å»ºä¼šè¯**:
```
ğŸ†• [åˆ›å»º] åˆå§‹åŒ– Agent: user1:concurrent_test_1:schedule-assistant
ğŸ“ [å­˜å‚¨] ç”¨æˆ·: user1, ä¼šè¯: concurrent_test_1, æœ€ç»ˆè·¯å¾„: ./.kode/user1/concurrent_test_1/
ğŸ”§ [åˆ›å»º] åˆ›å»ºæ–° Agent: user1:concurrent_test_1:schedule-assistant (å­˜å‚¨ID: concurrent_test_1)
âœ… [åˆ›å»º] Agent åˆ›å»ºå®Œæˆ
```

**ç”¨æˆ·2åˆ›å»ºä¼šè¯**:
```
ğŸ†• [åˆ›å»º] åˆå§‹åŒ– Agent: user2:concurrent_test_2:schedule-assistant
ğŸ“ [å­˜å‚¨] ç”¨æˆ·: user2, ä¼šè¯: concurrent_test_2, æœ€ç»ˆè·¯å¾„: ./.kode/user2/concurrent_test_2/
ğŸ”§ [åˆ›å»º] åˆ›å»ºæ–° Agent: user2:concurrent_test_2:schedule-assistant (å­˜å‚¨ID: concurrent_test_2)
âœ… [åˆ›å»º] Agent åˆ›å»ºå®Œæˆ
```

---

## äº”ã€å…³é”®ä¼˜åŠ¿

### 1. æ¸…æ™°çš„å±‚çº§ç»“æ„

```
ç”¨æˆ·å±‚ â†’ ä¼šè¯å±‚ â†’ æ•°æ®ç±»å‹å±‚
 â†“        â†“          â†“
user1  session1   runtime/events
```

### 2. æ˜“äºç®¡ç†

- **æŸ¥çœ‹æŸç”¨æˆ·çš„æ‰€æœ‰ä¼šè¯**: `ls .kode/user1/`
- **æŸ¥çœ‹æŸä¼šè¯çš„æ¶ˆæ¯**: `cat .kode/user1/session1/runtime/messages.json`
- **åˆ é™¤æŸä¼šè¯**: `rm -rf .kode/user1/session1/`
- **å¤‡ä»½æŸç”¨æˆ·**: `tar -czf user1.tar.gz .kode/user1/`

### 3. æ”¯æŒå¤šåœºæ™¯

| åœºæ™¯ | agentId æ ¼å¼ | å­˜å‚¨è·¯å¾„ |
|------|-------------|---------|
| å¤šç”¨æˆ·å¤šä¼šè¯ | `user1:session1:agent-type` | `.kode/user1/session1/` âœ… |
| å•ç”¨æˆ·å¤šä¼šè¯ | `user1:session2:agent-type` | `.kode/user1/session2/` âœ… |
| å…¼å®¹æ¨¡å¼ | `simple-agent-id` | `.kode/simple-agent-id/` âœ… |

### 4. æ€§èƒ½å‹å¥½

- âœ… å‡å°‘ç›®å½•åµŒå¥—æ·±åº¦
- âœ… æ–‡ä»¶ç³»ç»Ÿæ›´é«˜æ•ˆ
- âœ… æ›´å®¹æ˜“ç´¢å¼•å’Œæœç´¢

---

## å…­ã€è¿ç§»æŒ‡å—

### å¦‚æœæœ‰æ—§æ•°æ®éœ€è¦è¿ç§»

**æ­¥éª¤ 1**: å¤‡ä»½æ—§æ•°æ®
```bash
cd /Users/yeya/FlutterProjects/kode-sdk/kode-sdk
tar -czf kode-backup-$(date +%Y%m%d).tar.gz .kode/
```

**æ­¥éª¤ 2**: æ‰‹åŠ¨è¿ç§»ï¼ˆå¦‚æœéœ€è¦ï¼‰
```bash
# æ—§è·¯å¾„ç¤ºä¾‹
.kode/user1/session1/agent-type/user1:session1:agent-type/runtime/messages.json

# è¿ç§»åˆ°æ–°è·¯å¾„
mkdir -p .kode/user1/session1/runtime/
cp .kode/user1/session1/agent-type/user1:session1:agent-type/runtime/messages.json \
   .kode/user1/session1/runtime/messages.json
```

**æ­¥éª¤ 3**: éªŒè¯æ•°æ®
```bash
# æ£€æŸ¥æ–°è·¯å¾„ä¸‹çš„æ–‡ä»¶
find .kode/user1 -type f
```

**æ­¥éª¤ 4**: æ¸…ç†æ—§æ•°æ®
```bash
# ç¡®è®¤æ— è¯¯ååˆ é™¤æ—§ç›®å½•
rm -rf .kode/user1/session1/agent-type/
```

### è‡ªåŠ¨è¿ç§»è„šæœ¬ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦æ‰¹é‡è¿ç§»ï¼Œå¯ä»¥åˆ›å»ºè„šæœ¬ï¼š

```bash
#!/bin/bash
# migrate-storage.sh

for user_dir in .kode/*/; do
  user=$(basename "$user_dir")
  for session_dir in "$user_dir"*/; do
    session=$(basename "$session_dir")
    for agent_dir in "$session_dir"*/; do
      # æŸ¥æ‰¾æ·±å±‚åµŒå¥—çš„æ•°æ®
      old_runtime="$agent_dir"*/runtime/
      old_events="$agent_dir"*/events/
      
      if [ -d "$old_runtime" ]; then
        echo "è¿ç§»: $old_runtime â†’ $session_dir/runtime/"
        mkdir -p "$session_dir/runtime/"
        cp -r "$old_runtime"* "$session_dir/runtime/"
      fi
      
      if [ -d "$old_events" ]; then
        echo "è¿ç§»: $old_events â†’ $session_dir/events/"
        mkdir -p "$session_dir/events/"
        cp -r "$old_events"* "$session_dir/events/"
      fi
    done
  done
done
```

---

## ä¸ƒã€æœ€ä½³å®è·µ

### 1. å‘½åè§„èŒƒ

- **ç”¨æˆ·ID**: ä½¿ç”¨å°å†™å­—æ¯å’Œæ•°å­—ï¼Œå¦‚ `user1`, `alice`, `bob123`
- **ä¼šè¯ID**: æœ‰æ„ä¹‰çš„æ ‡è¯†ç¬¦ï¼Œå¦‚ `morning_chat`, `project_discussion`, `session_20251021`
- **é¿å…**: ç‰¹æ®Šå­—ç¬¦ã€ç©ºæ ¼ã€ä¸­æ–‡ï¼ˆå¯èƒ½å¯¼è‡´è·¨å¹³å°é—®é¢˜ï¼‰

### 2. ä¼šè¯ç®¡ç†

```typescript
// âœ… æ¨èï¼šä½¿ç”¨æ—¶é—´æˆ³+æè¿°
const sessionId = `chat_${Date.now()}_project`;

// âœ… æ¨èï¼šä½¿ç”¨ UUID
const sessionId = `session_${crypto.randomUUID().slice(0, 8)}`;

// âŒ é¿å…ï¼šè¿‡é•¿çš„ID
const sessionId = `very-long-session-id-with-lots-of-information`;
```

### 3. å®šæœŸæ¸…ç†

```bash
# æ¸…ç†30å¤©å‰çš„æ—§ä¼šè¯
find .kode -type d -name "session_*" -mtime +30 -exec rm -rf {} \;

# å½’æ¡£é‡è¦ä¼šè¯
tar -czf archive/user1_important_session.tar.gz .kode/user1/important_session/
```

### 4. ç›‘æ§å­˜å‚¨ç©ºé—´

```bash
# æŸ¥çœ‹å„ç”¨æˆ·å ç”¨ç©ºé—´
du -sh .kode/*/

# æŸ¥çœ‹æ€»å ç”¨
du -sh .kode/
```

---

## å…«ã€ç›¸å…³æ–‡æ¡£

- [01å¤šç”¨æˆ·å­¦ä¹ ç¬”è®°.md](./01å¤šç”¨æˆ·å­¦ä¹ ç¬”è®°.md)
- [02yeyaä¸nuoç”¨æˆ·å¹¶å‘è°ƒç”¨å®æˆ˜.md](./02yeyaä¸nuoç”¨æˆ·å¹¶å‘è°ƒç”¨å®æˆ˜.md)
- [05æœåŠ¡å™¨å¯åŠ¨ä¸å¹¶å‘æµ‹è¯•æˆåŠŸè®°å½•.md](./05æœåŠ¡å™¨å¯åŠ¨ä¸å¹¶å‘æµ‹è¯•æˆåŠŸè®°å½•.md)

---

## ä¹ã€æ€»ç»“

é€šè¿‡è¿™æ¬¡å­˜å‚¨ç»“æ„ä¼˜åŒ–ï¼Œæˆ‘ä»¬æˆåŠŸåœ°ï¼š

âœ… **ç®€åŒ–äº†ç›®å½•ç»“æ„** - ä» 5 å±‚å‡å°‘åˆ° 3 å±‚  
âœ… **æé«˜äº†å¯è¯»æ€§** - æ¸…æ™°çš„ç”¨æˆ·/ä¼šè¯/æ•°æ®åˆ†å±‚  
âœ… **ä¿æŒäº†åŠŸèƒ½** - æ‰€æœ‰å¤šç”¨æˆ·å¤šä¼šè¯åŠŸèƒ½æ­£å¸¸  
âœ… **æå‡äº†æ€§èƒ½** - æ›´æ‰å¹³çš„ç»“æ„ï¼Œæ›´å¿«çš„è®¿é—®  
âœ… **æ˜“äºç»´æŠ¤** - æ›´ç›´è§‚çš„ç®¡ç†å’Œå¤‡ä»½  

è¿™æ˜¯ä¸€æ¬¡éå¸¸æˆåŠŸçš„é‡æ„ï¼ğŸ‰

**ä¿®æ”¹æ–‡ä»¶**: 
- `/Users/yeya/FlutterProjects/kode-sdk/kode-sdk/server/services/agent-service.ts`

**å½±å“èŒƒå›´**:
- æ‰€æœ‰æ–°åˆ›å»ºçš„ç”¨æˆ·ä¼šè¯
- å…¼å®¹æ—§çš„å•å±‚ agentId æ¨¡å¼

**ä¸‹ä¸€æ­¥å»ºè®®**:
- å¯ä»¥è€ƒè™‘æ·»åŠ ä¼šè¯åˆ—è¡¨ç®¡ç†åŠŸèƒ½
- å®ç°ä¼šè¯å½’æ¡£å’Œæ¢å¤
- æ·»åŠ å­˜å‚¨ç©ºé—´ç›‘æ§å‘Šè­¦

