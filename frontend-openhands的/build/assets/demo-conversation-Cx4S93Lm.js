import{w as H,G as K,v as W,R as o,p as s}from"./chunk-NISHYRIK-CKdEls7F.js";import{s as E}from"./chunk-MSDKUXDP-Cfu5rKGn.js";import"./chunk-TX3FPB7D-DZsJI2yo.js";import"./bundle-mjs-0JNfDbnS.js";const $="http://localhost:3000",q="你好",te=H(function(){const{conversationId:m}=K(),v=W(),[l,g]=o.useState(m??null),[T,c]=o.useState([]),[j,O]=o.useState(q),[f,w]=o.useState(!1),[y,P]=o.useState(!1),[L,d]=o.useState(null),N=o.useRef(null),C=o.useRef(null),F=o.useRef({}),D=o.useRef(0),S=o.useRef(!1),z=o.useCallback(e=>{e&&c(t=>{const n=C.current;if(n)return t.map(a=>a.id===n&&a.type==="text"?{...a,content:a.content+e}:a);const r=`assistant-${Date.now()}`;return C.current=r,[...t,{id:r,type:"text",role:"assistant",content:e,streaming:!0}]})},[]),I=o.useCallback(()=>{const e=C.current;e&&(c(t=>t.map(n=>n.id===e&&n.type==="text"?{...n,streaming:!1}:n)),C.current=null)},[]),u=o.useCallback((e,t)=>{const n=`event-${Date.now()}-${D.current++}`;c(r=>[...r,{id:n,type:"event",title:e,details:t}])},[]),x=o.useCallback(e=>{if(e==null)return"（无内容）";if(typeof e=="string")return e.trim().length>0?e:"（空字符串）";try{return JSON.stringify(e,null,2)}catch{return String(e)}},[]),B=o.useCallback(e=>{const t=e.event.call??{},n=t.id||`${t.name??"tool"}-${Date.now()}-${Math.random()}`;F.current[n]=n,c(r=>[...r,{id:n,type:"tool",name:t.name??"未命名工具",status:"running",input:t.inputPreview?x(JSON.parse(t.inputPreview)):x(t.input??{})}])},[x]),_=o.useCallback(e=>{const t=e.event.call??{},n=Object.keys(F.current),r=t.id&&F.current[t.id]?t.id:n.find(i=>i.startsWith(t.name??""))||`tool-${Date.now()}-${Math.random()}`;F.current[r]=r;const a=t.output??e.event.content??t.result??{};c(i=>i.some(p=>p.type==="tool"&&p.id===r)?i.map(p=>p.type==="tool"&&p.id===r?{...p,status:t.state==="COMPLETED"?"completed":t.state==="ERROR"?"error":"completed",output:x(a),durationMs:t.durationMs??p.durationMs}:p):[...i,{id:r,type:"tool",name:t.name??"未命名工具",status:t.state==="COMPLETED"?"completed":t.state==="ERROR"?"error":"completed",input:t.inputPreview?x(JSON.parse(t.inputPreview)):x(t.input??{}),output:x(a),durationMs:t.durationMs}])},[x]),h=o.useCallback(e=>{try{return JSON.parse(e.data)}catch(t){return console.error("Failed to parse SSE payload",t,e.data),u("错误","无法解析事件数据。"),null}},[u]),k=o.useCallback(e=>{N.current&&N.current.close();const t=`${$}/api/conversations/${e}/events`,n=new EventSource(t);N.current=n,S.current=!1,n.addEventListener("text_chunk",r=>{const a=h(r);if(!a)return;const i=a.event.delta??(typeof a.event.content=="string"?a.event.content:"");z(i)}),n.addEventListener("text_chunk_end",()=>{I()}),n.addEventListener("tool:start",r=>{const a=h(r);a&&B(a)}),n.addEventListener("tool:end",r=>{const a=h(r);a&&_(a)}),n.addEventListener("token_usage",r=>{const a=h(r);if(!a)return;const i=a.event.inputTokens??0,U=a.event.outputTokens??0;u("Token 使用",`输入 ${i} · 输出 ${U}`)}),n.addEventListener("error",r=>{const a=h(r);a?.event?.message?u("错误",String(a.event.message)):u("错误","事件流发生未知错误。")}),n.addEventListener("done",()=>{S.current=!0,I(),u("对话完成","模型已结束本轮回复。")}),n.onerror=r=>{const a=r.currentTarget;S.current&&a&&a.readyState===EventSource.CLOSED||(console.error("EventSource error",r),d("事件流连接中断，请检查后端服务。"),u("错误","事件流发生未知错误。"))}},[z,u,I,_,B,h]),A=o.useCallback(async e=>{try{const t=await fetch(`${$}/api/conversations/${e}/history`);if(!t.ok)throw new Error(`加载历史失败：${t.status}`);const n=await t.json();c(n.messages??[])}catch(t){console.error(t),c([])}},[]),J=o.useCallback(async e=>{w(!0),d(null),D.current=0;try{await A(e),g(e),k(e)}catch(t){console.error(t),d(t instanceof Error?t.message:"初始化会话时发生未知错误。")}finally{w(!1)}},[A,k]),R=o.useCallback(async()=>{w(!0),d(null),D.current=0;try{const e=await fetch(`${$}/api/conversations`,{method:"POST"});if(!e.ok)throw new Error(`创建会话失败：${e.status}`);const n=(await e.json()).conversationId;g(n),await A(n),k(n),v(`/demo/conversations/${n}`,{replace:!0})}catch(e){console.error(e),d(e instanceof Error?e.message:"创建会话时发生未知错误。")}finally{w(!1)}},[A,v,k]);o.useEffect(()=>(m?J(m):l||R(),()=>{N.current?.close()}),[l,m,R,J]);const G=o.useCallback(async e=>{if(e.preventDefault(),!l){d("会话尚未初始化，无法发送消息。");return}const t=j.trim();if(!t)return;P(!0),d(null),S.current=!1;const n=`user-${Date.now()}`;c(r=>[...r,{id:n,type:"text",role:"user",content:t}]),O("");try{const r=await fetch(`${$}/api/conversations/${l}/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:t})});if(!r.ok)throw new Error(`发送消息失败：${r.status}`)}catch(r){console.error(r),d(r instanceof Error?r.message:"发送消息时发生未知错误。"),c(a=>a.map(i=>i.id===n&&i.type==="text"?{...i,content:`${i.content}
（发送失败）`}:i))}finally{P(!1)}},[l,j]),M=l!==null&&!f;return s.jsxs("div",{className:"h-full flex flex-col bg-base",children:[s.jsxs("header",{className:"px-6 py-4 border-b border-divider flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-lg font-semibold text-white",children:"Demo Conversation"}),s.jsxs("p",{className:"text-sm text-[#A5A8AE]",children:[f&&"正在连接后端事件流...",!f&&l?`会话 ID：${l}`:null]})]}),s.jsx("button",{type:"button",onClick:()=>R(),className:"text-sm text-[#5F6CFF] hover:underline",disabled:f,children:"重新开始"})]}),s.jsxs("main",{className:"flex-1 overflow-y-auto px-6 py-6 custom-scrollbar-always",children:[L&&s.jsx("div",{className:"max-w-3xl mx-auto mb-4 rounded-lg border border-[#ff6b6b33] bg-[#ff6b6b11] px-4 py-3 text-sm text-[#ffb3b3]",children:L}),f&&s.jsxs("div",{className:"h-full flex items-center justify-center text-[#A5A8AE] text-sm gap-2",children:[s.jsx(E,{size:"sm",color:"secondary"})," 正在等待后端事件流..."]}),!f&&T.length===0&&s.jsxs("div",{className:"h-full flex flex-col items-center justify-center text-[#A5A8AE] text-sm gap-2",children:[s.jsx(E,{size:"sm",color:"secondary"}),"等待后端返回事件..."]}),s.jsx("div",{className:"flex flex-col gap-4 max-w-3xl mx-auto",children:T.map(e=>{if(e.type==="text"){const t=e.role==="user";return s.jsx("div",{className:`flex ${t?"justify-end":"justify-start"} w-full`,children:s.jsxs("div",{className:`max-w-[75%] rounded-2xl px-4 py-3 text-sm leading-relaxed ${t?"bg-[#5F6CFF] text-white rounded-br-sm":"bg-[#1F2229] text-[#EDEFF5] rounded-bl-sm"}`,children:[s.jsx("pre",{className:"whitespace-pre-wrap break-words font-sans text-sm",children:e.content}),!t&&e.streaming&&s.jsxs("div",{className:"flex items-center gap-1 mt-2 text-xs text-[#A5A8AE]",children:[s.jsx(E,{size:"xs"})," 生成中..."]})]})},e.id)}return e.type==="tool"?s.jsxs("div",{className:"border border-[#2E3138] bg-[#1B1D23] rounded-xl px-4 py-3 text-sm text-[#EDEFF5]",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx("span",{className:"text-xs uppercase tracking-wide text-[#5F6CFF]",children:"工具调用"}),s.jsx("span",{className:"font-semibold",children:e.name}),s.jsx(Q,{status:e.status}),typeof e.durationMs=="number"&&s.jsxs("span",{className:"text-xs text-[#A5A8AE]",children:[e.durationMs," ms"]})]}),e.input&&s.jsx(V,{title:"输入",value:e.input}),e.output&&s.jsx(V,{title:"输出",value:e.output}),!e.output&&e.status==="running"&&s.jsxs("div",{className:"flex items-center gap-2 text-xs text-[#A5A8AE]",children:[s.jsx(E,{size:"xs"})," 正在执行..."]})]},e.id):s.jsxs("div",{className:"rounded-lg border border-[#2E3138] bg-[#1B1D23] px-4 py-3 text-sm text-[#C6C9D2]",children:[s.jsx("div",{className:"font-semibold text-[#5F6CFF]",children:e.title}),s.jsx("pre",{className:"mt-1 whitespace-pre-wrap break-words",children:e.details})]},e.id)})})]}),s.jsx("footer",{className:"px-6 py-4 border-t border-divider",children:s.jsxs("form",{onSubmit:G,className:"max-w-3xl mx-auto flex flex-col gap-3",children:[s.jsx("label",{htmlFor:"demo-chat-input",className:"text-sm text-[#A5A8AE] font-medium",children:"发送一条演示消息"}),s.jsx("textarea",{id:"demo-chat-input",value:j,onChange:e=>O(e.target.value),placeholder:"输入消息后按 Enter 或点击发送。",className:"bg-[#1B1D23] border border-[#2E3138] rounded-lg text-sm text-white resize-none h-20 px-3 py-2 outline-none focus:border-[#5F6CFF] focus:ring-2 focus:ring-[#5F6CFF33]",disabled:!M||y}),s.jsx("div",{className:"flex justify-end",children:s.jsx("button",{type:"submit",className:`px-4 py-2 rounded-lg text-sm font-semibold transition-colors ${j.trim().length>0&&M&&!y?"bg-[#5F6CFF] text-white hover:bg-[#4A55E0]":"bg-[#2E3138] text-[#6B6F78] cursor-not-allowed"}`,disabled:!M||y||j.trim().length===0,children:y?"发送中...":"发送"})})]})})]})});function Q({status:b}){return b==="running"?s.jsxs("span",{className:"flex items-center gap-1 text-xs text-[#5F6CFF]",children:[s.jsx(E,{size:"xs"})," 执行中"]}):b==="completed"?s.jsx("span",{className:"text-xs text-[#5FDC63]",children:"已完成"}):s.jsx("span",{className:"text-xs text-[#ff6b6b]",children:"出错"})}function V({title:b,value:m}){const[v,l]=o.useState(!1);return s.jsxs("div",{className:"mt-2 rounded-lg border border-[#2E3138] bg-[#111217]",children:[s.jsxs("button",{type:"button",className:"flex w-full items-center justify-between px-3 py-2 text-xs text-[#A5A8AE]",onClick:()=>l(g=>!g),children:[s.jsx("span",{className:"font-semibold",children:b}),s.jsx("span",{children:v?"收起":"展开"})]}),v&&s.jsx("pre",{className:"px-3 pb-3 whitespace-pre-wrap break-words text-xs text-[#EDEFF5]",children:m})]})}export{te as default};
