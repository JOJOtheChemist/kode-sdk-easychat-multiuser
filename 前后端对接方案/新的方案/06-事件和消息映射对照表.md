# äº‹ä»¶å’Œæ¶ˆæ¯æ˜ å°„å¯¹ç…§è¡¨

æœ¬æ–‡æ¡£æä¾› **Kode-SDK äº‹ä»¶** ä¸ **Frontend ç»„ä»¶** ä¹‹é—´çš„è¯¦ç»†æ˜ å°„å…³ç³»ï¼Œä¾›å¼€å‘æ—¶å¿«é€ŸæŸ¥é˜…ã€‚

## 1. æ ¸å¿ƒæ˜ å°„å…³ç³»æ€»è¡¨

| Kode-SDK | Frontend | æ˜ å°„å¤æ‚åº¦ | ä¼˜å…ˆçº§ |
|----------|----------|-----------|-------|
| `Message` | `OpenHandsAction/Observation` | â­ ç®€å• | ğŸ”´ é«˜ |
| `ContentBlock` | `content` å­—æ®µ | â­ ç®€å• | ğŸ”´ é«˜ |
| `text_chunk` | `UserAssistantEventMessage` | â­â­ ä¸­ç­‰ | ğŸ”´ é«˜ |
| `tool:start` | `ObservationPairEventMessage` | â­â­â­ å¤æ‚ | ğŸ”´ é«˜ |
| `tool:end` | `McpEventMessage` | â­â­â­ å¤æ‚ | ğŸ”´ é«˜ |
| `permission_required` | å®¡æ‰¹ UI (éœ€æ–°å¢) | â­â­â­ å¤æ‚ | ğŸŸ¡ ä¸­ |
| `done` | å¯¹è¯å®ŒæˆçŠ¶æ€ | â­ ç®€å• | ğŸ”´ é«˜ |

## 2. æ¶ˆæ¯æ ¼å¼æ˜ å°„

### 2.1 ç”¨æˆ·æ¶ˆæ¯

#### Kode-SDK æ ¼å¼

```typescript
{
  role: 'user',
  content: [
    { type: 'text', text: 'å¸®æˆ‘è¯»å– README.md' }
  ]
}
```

#### Frontend æ ¼å¼

```typescript
{
  action: 'message',
  source: 'user',
  args: {
    content: 'å¸®æˆ‘è¯»å– README.md'
  }
}
```

#### è½¬æ¢å‡½æ•°

```typescript
function convertUserMessage(kodeMessage: Message) {
  const textContent = kodeMessage.content
    .filter(b => b.type === 'text')
    .map(b => b.text)
    .join('');
    
  return {
    action: 'message',
    source: 'user',
    args: { content: textContent }
  };
}
```

### 2.2 åŠ©æ‰‹æ¶ˆæ¯ï¼ˆçº¯æ–‡æœ¬ï¼‰

#### Kode-SDK æ ¼å¼

```typescript
{
  role: 'assistant',
  content: [
    { type: 'text', text: 'å¥½çš„ï¼Œæˆ‘æ¥å¸®ä½ è¯»å–æ–‡ä»¶ã€‚' }
  ]
}
```

#### Frontend æ ¼å¼

```typescript
{
  action: 'message',
  source: 'agent',
  args: {
    content: 'å¥½çš„ï¼Œæˆ‘æ¥å¸®ä½ è¯»å–æ–‡ä»¶ã€‚'
  }
}
```

#### å¯¹åº”ç»„ä»¶

```typescript
<UserAssistantEventMessage 
  event={{
    action: 'message',
    source: 'agent',
    args: { content: '...' }
  }}
/>
  â†“ æ¸²æŸ“ä¸º
<ChatMessage 
  type="agent" 
  message="å¥½çš„ï¼Œæˆ‘æ¥å¸®ä½ è¯»å–æ–‡ä»¶ã€‚" 
/>
```

### 2.3 åŠ©æ‰‹æ¶ˆæ¯ï¼ˆå«å·¥å…·è°ƒç”¨ï¼‰

#### Kode-SDK æ ¼å¼

```typescript
{
  role: 'assistant',
  content: [
    { type: 'text', text: 'æˆ‘æ¥è¯»å–æ–‡ä»¶' },
    { 
      type: 'tool_use', 
      id: 'toolu_01ABC', 
      name: 'fs_read', 
      input: { path: 'README.md' } 
    }
  ]
}
```

#### Frontend æ ¼å¼ï¼ˆæ‹†åˆ†ä¸ºä¸¤ä¸ªäº‹ä»¶ï¼‰

```typescript
// äº‹ä»¶ 1: æ–‡æœ¬æ¶ˆæ¯
{
  action: 'message',
  source: 'agent',
  args: { content: 'æˆ‘æ¥è¯»å–æ–‡ä»¶' }
}

// äº‹ä»¶ 2: å·¥å…·è°ƒç”¨
{
  action: 'call_tool_mcp',
  source: 'agent',
  id: 'toolu_01ABC',
  args: {
    name: 'fs_read',
    arguments: { path: 'README.md' }
  }
}
```

#### å¯¹åº”ç»„ä»¶

```typescript
// æ–‡æœ¬éƒ¨åˆ†
<UserAssistantEventMessage event={textEvent} />

// å·¥å…·è°ƒç”¨éƒ¨åˆ†
<ObservationPairEventMessage event={toolEvent} />
```

## 3. å·¥å…·è°ƒç”¨æ˜ å°„

### 3.1 å·¥å…·è°ƒç”¨å¼€å§‹ (tool:start)

#### Kode-SDK Progress äº‹ä»¶

```typescript
{
  type: 'tool:start',
  channel: 'progress',
  call: {
    id: 'tool_abc123',
    name: 'fs_read',
    state: 'EXECUTING',
    inputPreview: { path: 'README.md' },
    startedAt: 1234567890
  }
}
```

#### è½¬æ¢ä¸º Frontend Action

```typescript
{
  action: 'call_tool_mcp',  // æˆ–æ ¹æ®å·¥å…·ç±»å‹æ˜ å°„
  source: 'agent',
  id: 'tool_abc123',
  args: {
    name: 'fs_read',
    arguments: { path: 'README.md' },
    thought: ''  // å¯é€‰
  }
}
```

#### å‰ç«¯ç»„ä»¶æ¸²æŸ“

```typescript
<ObservationPairEventMessage 
  event={toolAction}
  hasObservationPair={true}
/>
  â†“
<MicroagentStatusWrapper>
  æ˜¾ç¤º"æ­£åœ¨æ‰§è¡Œ fs_read..."
</MicroagentStatusWrapper>
```

### 3.2 å·¥å…·è°ƒç”¨å®Œæˆ (tool:end)

#### Kode-SDK Progress äº‹ä»¶

```typescript
{
  type: 'tool:end',
  channel: 'progress',
  call: {
    id: 'tool_abc123',
    name: 'fs_read',
    state: 'COMPLETED',
    result: '# My Project\n\nThis is a demo project...',
    durationMs: 15,
    completedAt: 1234567905
  }
}
```

#### è½¬æ¢ä¸º Frontend Observation

```typescript
{
  observation: 'mcp',
  source: 'agent',
  content: '# My Project\n\nThis is a demo project...',
  extras: {
    name: 'fs_read',
    arguments: { path: 'README.md' },
    duration: 15,
    success: true
  }
}
```

#### å‰ç«¯ç»„ä»¶æ¸²æŸ“

```typescript
<McpEventMessage 
  event={observation}
/>
  â†“
<GenericEventMessage
  title="CALL_TOOL_MCP: fs_read"
  details={<MCPObservationContent event={observation} />}
  success="success"
/>
  â†“
<MCPObservationContent>
  <div>
    <h3>Arguments</h3>
    <ReactJsonView src={{ path: 'README.md' }} />
    
    <h3>Output</h3>
    <pre># My Project...</pre>
  </div>
</MCPObservationContent>
```

### 3.3 å·¥å…·è°ƒç”¨å¤±è´¥

#### Kode-SDK äº‹ä»¶

```typescript
{
  type: 'tool:error',
  channel: 'progress',
  call: {
    id: 'tool_xyz',
    name: 'fs_read',
    state: 'FAILED',
    error: 'File not found: /nonexistent.txt',
    isError: true
  }
}

// æˆ– tool:end with error
{
  type: 'tool:end',
  call: {
    id: 'tool_xyz',
    state: 'FAILED',
    error: 'File not found',
    isError: true
  }
}
```

#### Frontend Observation

```typescript
{
  observation: 'error',
  source: 'agent',
  content: 'File not found: /nonexistent.txt',
  extras: {
    name: 'fs_read',
    arguments: { path: '/nonexistent.txt' }
  }
}
```

#### å‰ç«¯ç»„ä»¶

```typescript
<ErrorEventMessage 
  event={errorEvent}
/>
  â†“
<GenericEventMessage
  title="ERROR: fs_read"
  details={errorMessage}
  success="error"
/>
```

## 4. æµå¼äº‹ä»¶æ˜ å°„

### 4.1 æ–‡æœ¬æµå¼è¾“å‡º

#### Kode-SDK äº‹ä»¶åºåˆ—

```typescript
// 1. å¼€å§‹
{ type: 'text_chunk_start', step: 1 }

// 2. å¢é‡æ–‡æœ¬
{ type: 'text_chunk', step: 1, delta: 'æˆ‘' }
{ type: 'text_chunk', step: 1, delta: 'æ¥' }
{ type: 'text_chunk', step: 1, delta: 'å¸®' }
{ type: 'text_chunk', step: 1, delta: 'ä½ ' }

// 3. ç»“æŸ
{ type: 'text_chunk_end', step: 1, text: 'æˆ‘æ¥å¸®ä½ ' }
```

#### Frontend å¤„ç†æµç¨‹

```typescript
// 1. æ”¶åˆ° text_chunk_start
ui.createMessageBubble({ role: 'assistant' });

// 2. ç´¯åŠ æ¯ä¸ª text_chunk
let accumulated = '';
onTextChunk((delta) => {
  accumulated += delta;
  ui.updateMessage(accumulated);  // å®æ—¶æ›´æ–°
});

// 3. æ”¶åˆ° text_chunk_end
ui.finalizeMessage(event.text);
addToHistory({
  action: 'message',
  source: 'agent',
  args: { content: event.text }
});
```

### 4.2 æ€è€ƒè¿‡ç¨‹æµå¼è¾“å‡ºï¼ˆå¯é€‰ï¼‰

#### Kode-SDK äº‹ä»¶

```typescript
// éœ€å¼€å¯ exposeThinking: true

{ type: 'think_chunk_start', step: 1 }
{ type: 'think_chunk', step: 1, delta: 'ç”¨æˆ·æƒ³è¦...' }
{ type: 'think_chunk', step: 1, delta: 'æˆ‘åº”è¯¥å…ˆ...' }
{ type: 'think_chunk_end', step: 1 }
```

#### Frontend æ˜¾ç¤º

```typescript
// å¯ä»¥æ·»åŠ "æ€è€ƒä¸­"çš„ UI
<div className="thinking-indicator">
  <span>AI æ€è€ƒä¸­...</span>
  <div className="thinking-text">{thinkingText}</div>
</div>
```

## 5. ç‰¹æ®Šåœºæ™¯æ˜ å°„

### 5.1 å¹¶å‘å·¥å…·è°ƒç”¨

#### Kode-SDK äº‹ä»¶

```typescript
// åŒæ—¶å‘èµ· 3 ä¸ªå·¥å…·è°ƒç”¨
{ type: 'tool:start', call: { id: 'tool_1', name: 'fs_read' } }
{ type: 'tool:start', call: { id: 'tool_2', name: 'fs_glob' } }
{ type: 'tool:start', call: { id: 'tool_3', name: 'bash_run' } }

// æŒ‰å®Œæˆé¡ºåºè¿”å›
{ type: 'tool:end', call: { id: 'tool_2', result: [...] } }
{ type: 'tool:end', call: { id: 'tool_1', result: '...' } }
{ type: 'tool:end', call: { id: 'tool_3', result: {...} } }
```

#### Frontend å¤„ç†

```typescript
// ä½¿ç”¨ Map è·Ÿè¸ªå¤šä¸ªå·¥å…·è°ƒç”¨
const toolCalls = new Map<string, ToolCallUI>();

onToolStart((call) => {
  toolCalls.set(call.id, {
    id: call.id,
    name: call.name,
    status: 'executing',
    startedAt: Date.now()
  });
  ui.renderToolCard(call.id);
});

onToolEnd((call) => {
  const toolUI = toolCalls.get(call.id);
  if (toolUI) {
    toolUI.status = 'completed';
    toolUI.result = call.result;
    ui.updateToolCard(call.id, toolUI);
  }
});
```

#### å‰ç«¯æ¸²æŸ“

```typescript
// æ˜¾ç¤ºå¤šä¸ªå·¥å…·æ‰§è¡Œå¡ç‰‡
<div className="tool-calls-container">
  <ObservationPairEventMessage event={tool1} />
  <ObservationPairEventMessage event={tool2} />
  <ObservationPairEventMessage event={tool3} />
</div>
```

### 5.2 å®¡æ‰¹æµç¨‹

#### Kode-SDK Control äº‹ä»¶

```typescript
{
  type: 'permission_required',
  channel: 'control',
  call: {
    id: 'tool_dangerous',
    name: 'bash_run',
    state: 'APPROVAL_REQUIRED',
    inputPreview: { command: 'rm -rf /tmp/*' },
    approval: {
      required: true,
      meta: { risk: 'high' }
    }
  },
  respond: async (decision, opts) => { ... }
}
```

#### Frontend UI æµç¨‹

```typescript
// 1. æ¥æ”¶å®¡æ‰¹è¯·æ±‚
socket.on('approval_required', ({ callId, toolName, input, meta }) => {
  showApprovalDialog({
    callId,
    title: `Approve ${toolName}?`,
    input: input,
    risk: meta.risk,
    onApprove: (note) => {
      socket.emit('approve', { callId, decision: 'allow', note });
      closeDialog();
    },
    onDeny: (note) => {
      socket.emit('approve', { callId, decision: 'deny', note });
      closeDialog();
    }
  });
});

// 2. æ˜¾ç¤ºå®¡æ‰¹çŠ¶æ€
<div className="approval-status">
  <span className="risk-badge risk-high">High Risk</span>
  <div>Tool: bash_run</div>
  <div>Command: rm -rf /tmp/*</div>
  <button onClick={handleApprove}>Approve</button>
  <button onClick={handleDeny}>Deny</button>
</div>
```

#### å®¡æ‰¹ç»“æœäº‹ä»¶

```typescript
// Kode-SDK
{
  type: 'permission_decided',
  channel: 'control',
  callId: 'tool_dangerous',
  decision: 'allow',
  decidedBy: 'user123',
  note: 'Reviewed and approved'
}

// Frontend æ˜¾ç¤º
<div className="approval-result">
  âœ… Approved by user123
  <span>Note: Reviewed and approved</span>
</div>
```

## 3. å·¥å…·ç±»å‹æ˜ å°„

### 3.1 æ–‡ä»¶ç³»ç»Ÿå·¥å…·

| Kode Tool | Frontend Action | Frontend Observation | ç‰¹æ®Šå¤„ç† |
|-----------|----------------|---------------------|---------|
| `fs_read` | `call_tool_mcp` | `mcp` | å¤§æ–‡ä»¶æˆªæ–­ |
| `fs_write` | `call_tool_mcp` | `mcp` | æ˜¾ç¤ºå†™å…¥è·¯å¾„ |
| `fs_edit` | `call_tool_mcp` | `edit` | æ˜¾ç¤º diff |
| `fs_glob` | `call_tool_mcp` | `mcp` | åˆ—è¡¨æ¸²æŸ“ |
| `fs_grep` | `call_tool_mcp` | `mcp` | é«˜äº®åŒ¹é… |

#### fs_read ç¤ºä¾‹

```typescript
// Kode-SDK
{
  type: 'tool:end',
  call: {
    name: 'fs_read',
    result: '# README\n\nContent...',
    durationMs: 10
  }
}

// Frontend
{
  observation: 'read',
  content: '```\n# README\n\nContent...\n```',
  extras: {
    path: 'README.md'
  }
}

// æ¸²æŸ“ä¸º
<GenericEventMessage
  title={<Trans i18nKey="OBSERVATION_MESSAGE$READ" values={{ path: 'README.md' }} />}
  details={'```\n# README\n\nContent...\n```'}
  success="success"
/>
```

#### fs_edit ç¤ºä¾‹

```typescript
// Kode-SDK
{
  type: 'tool:end',
  call: {
    name: 'fs_edit',
    result: {
      success: true,
      diff: '--- a/file.ts\n+++ b/file.ts\n...'
    }
  }
}

// Frontend
{
  observation: 'edit',
  content: 'Edit completed',
  extras: {
    path: 'file.ts',
    diff: '--- a/file.ts\n+++ b/file.ts\n...'
  }
}

// æ¸²æŸ“
<GenericEventMessage
  title="EDIT: file.ts"
  details={'```diff\n' + diff + '\n```'}
  success="success"
/>
```

### 3.2 å‘½ä»¤æ‰§è¡Œå·¥å…·

| Kode Tool | Frontend Action | Frontend Observation |
|-----------|----------------|---------------------|
| `bash_run` | `call_tool_mcp` / `run` | `run` / `mcp` |
| `bash_logs` | `call_tool_mcp` | `mcp` |
| `bash_kill` | `call_tool_mcp` | `mcp` |

#### bash_run ç¤ºä¾‹

```typescript
// Kode-SDK
{
  type: 'tool:end',
  call: {
    name: 'bash_run',
    result: {
      stdout: 'Hello World\n',
      stderr: '',
      exitCode: 0
    },
    durationMs: 250
  }
}

// Frontend
{
  observation: 'run',
  content: 'Hello World\n',
  extras: {
    command: 'echo "Hello World"',
    exitCode: 0,
    duration: 250
  }
}

// æ¸²æŸ“
<GenericEventMessage
  title={<Trans i18nKey="OBSERVATION_MESSAGE$RUN" values={{ command: 'echo ...' }} />}
  details={'Output:\n```sh\nHello World\n```'}
  success="success"
/>
```

### 3.3 Todo å·¥å…·

| Kode Tool | Frontend å¤„ç† |
|-----------|--------------|
| `todo_read` | ç‰¹æ®Šï¼šæ˜¾ç¤º Todo åˆ—è¡¨ |
| `todo_write` | ç‰¹æ®Šï¼šæ›´æ–° Todo åˆ—è¡¨ |

#### todo_read ç¤ºä¾‹

```typescript
// Kode-SDK
{
  type: 'tool:end',
  call: {
    name: 'todo_read',
    result: [
      { id: '1', title: 'å®ç°ç™»å½•', status: 'done' },
      { id: '2', title: 'ä¼˜åŒ–æ€§èƒ½', status: 'in_progress' }
    ]
  }
}

// Frontend å¯ä»¥æ¸²æŸ“ä¸ºç‰¹æ®Šçš„ Todo åˆ—è¡¨ç»„ä»¶
<TodoListDisplay todos={result} />
```

## 4. é”™è¯¯å¤„ç†æ˜ å°„

### 4.1 å·¥å…·æ‰§è¡Œé”™è¯¯

#### Kode-SDK

```typescript
{
  type: 'tool:error',
  call: {
    id: 'tool_err',
    name: 'fs_read',
    state: 'FAILED',
    error: 'ENOENT: no such file or directory',
    isError: true
  }
}
```

#### Frontend

```typescript
{
  observation: 'error',
  content: 'ENOENT: no such file or directory',
  extras: {
    name: 'fs_read',
    arguments: { path: '/nonexistent' }
  }
}

// æ¸²æŸ“
<ErrorEventMessage event={errorEvent} />
  â†“
<div className="error-message">
  âŒ Error: fs_read failed
  <div>ENOENT: no such file or directory</div>
</div>
```

### 4.2 æ¨¡å‹é”™è¯¯

#### Kode-SDK Monitor äº‹ä»¶

```typescript
{
  type: 'error',
  channel: 'monitor',
  severity: 'error',
  phase: 'model',
  message: 'API rate limit exceeded',
  detail: { status: 429, retryAfter: 60 }
}
```

#### Frontend å¤„ç†

```typescript
// ä½¿ç”¨ ErrorMessageBanner
useErrorMessageStore.getState().setErrorMessage({
  message: 'API rate limit exceeded. Please try again in 1 minute.',
  detail: event.detail
});

// æ¸²æŸ“
<ErrorMessageBanner message={errorMessage} />
```

## 5. çŠ¶æ€æ˜ å°„

### 5.1 Agent çŠ¶æ€

| Kode State | Frontend UI | è¯´æ˜ |
|-----------|------------|------|
| `READY` | å¾…æœºçŠ¶æ€ | å¯ä»¥å‘é€æ¶ˆæ¯ |
| `WORKING` | åŠ è½½ä¸­ | æ˜¾ç¤º TypingIndicator |
| `PAUSED` | æš‚åœ | æ˜¾ç¤º"å·²æš‚åœ" |

#### Monitor äº‹ä»¶

```typescript
{
  type: 'state_changed',
  channel: 'monitor',
  state: 'WORKING'
}
```

#### Frontend æ›´æ–°

```typescript
<div className="agent-status">
  {state === 'WORKING' && <TypingIndicator />}
  {state === 'PAUSED' && <div>â¸ï¸ Paused</div>}
  {state === 'READY' && <div>âœ… Ready</div>}
</div>
```

### 5.2 å·¥å…·çŠ¶æ€

| Kode ToolCallState | Frontend æ˜¾ç¤º |
|-------------------|--------------|
| `PENDING` | â³ ç­‰å¾…æ‰§è¡Œ |
| `EXECUTING` | ğŸ”„ æ‰§è¡Œä¸­... |
| `COMPLETED` | âœ… å®Œæˆ |
| `FAILED` | âŒ å¤±è´¥ |
| `APPROVAL_REQUIRED` | âš ï¸ éœ€è¦å®¡æ‰¹ |
| `DENIED` | ğŸš« å·²æ‹’ç» |

## 6. ç»„ä»¶å¯¹åº”å…³ç³»

### 6.1 Frontend ç»„ä»¶ â†’ Kode äº‹ä»¶

| Frontend ç»„ä»¶ | å¤„ç†çš„ Kode äº‹ä»¶ | è¯´æ˜ |
|--------------|-----------------|------|
| `ChatInterface` | `done`, `state_changed` | ä¸»ç•Œé¢æ§åˆ¶ |
| `Messages` | æ‰€æœ‰ Progress äº‹ä»¶ | æ¶ˆæ¯åˆ—è¡¨æ¸²æŸ“ |
| `EventMessage` | æ‰€æœ‰äº‹ä»¶ | äº‹ä»¶åˆ†å‘å™¨ |
| `UserAssistantEventMessage` | `text_chunk_end` | æ–‡æœ¬æ¶ˆæ¯ |
| `ObservationPairEventMessage` | `tool:start` | å·¥å…·è°ƒç”¨ï¼ˆActionï¼‰ |
| `McpEventMessage` | `tool:end` | MCP å·¥å…·ç»“æœ |
| `GenericEventMessage` | å…¶ä»–æ‰€æœ‰äº‹ä»¶ | é€šç”¨äº‹ä»¶æ˜¾ç¤º |
| `MCPObservationContent` | `tool:end` (MCP) | å·¥å…·å‚æ•°å’Œç»“æœ |
| `TypingIndicator` | `text_chunk_start` | è¾“å…¥ä¸­æŒ‡ç¤ºå™¨ |
| `ErrorMessageBanner` | `error` | é”™è¯¯æç¤º |

### 6.2 äº‹ä»¶åˆ°ç»„ä»¶çš„å†³ç­–æ ‘

```
æ”¶åˆ° Kode äº‹ä»¶
  â†“
æ˜¯ text_chunk?
  â†’ æ˜¯ â†’ TextAccumulator â†’ UserAssistantEventMessage
  â†“
æ˜¯ tool:start?
  â†’ æ˜¯ â†’ ObservationPairEventMessage
  â†“
æ˜¯ tool:end?
  â†’ æ˜¯ â†’ å·¥å…·ç±»å‹?
      â†’ MCP â†’ McpEventMessage
      â†’ å…¶ä»– â†’ GenericEventMessage
  â†“
æ˜¯ error?
  â†’ æ˜¯ â†’ ErrorEventMessage
  â†“
æ˜¯ done?
  â†’ æ˜¯ â†’ æ›´æ–°å¯¹è¯çŠ¶æ€
  â†“
å…¶ä»–
  â†’ GenericEventMessage (å…œåº•)
```

## 7. å®ç°æ£€æŸ¥æ¸…å•

### 7.1 åç«¯å®ç°

- [ ] Agent åˆ›å»ºå’Œç®¡ç†
- [ ] MessageQueue é›†æˆ
- [ ] Progress äº‹ä»¶è®¢é˜…
- [ ] Control äº‹ä»¶ç›‘å¬ï¼ˆå®¡æ‰¹ï¼‰
- [ ] Monitor äº‹ä»¶ç›‘å¬ï¼ˆæ—¥å¿—ï¼‰
- [ ] SSE/WebSocket å®ç°
- [ ] äº‹ä»¶æ ¼å¼è½¬æ¢
- [ ] æ¶ˆæ¯æŒä¹…åŒ–
- [ ] æ–­ç‚¹ç»­æ’­æ”¯æŒ

### 7.2 å‰ç«¯å®ç°

- [ ] SSE/WebSocket å®¢æˆ·ç«¯
- [ ] äº‹ä»¶ Store é›†æˆ
- [ ] TextAccumulator å®ç°
- [ ] å·¥å…·è°ƒç”¨ UI
- [ ] å®¡æ‰¹å¯¹è¯æ¡†
- [ ] é”™è¯¯å¤„ç†
- [ ] å†å²æ¶ˆæ¯åŠ è½½
- [ ] æ–­ç‚¹æ¢å¤

### 7.3 æµ‹è¯•éªŒè¯

- [ ] çº¯æ–‡æœ¬å¯¹è¯
- [ ] å•ä¸ªå·¥å…·è°ƒç”¨
- [ ] å¹¶å‘å·¥å…·è°ƒç”¨
- [ ] å·¥å…·æ‰§è¡Œå¤±è´¥
- [ ] äººå·¥å®¡æ‰¹æµç¨‹
- [ ] æ–­çº¿é‡è¿
- [ ] å†å²æ¶ˆæ¯åŠ è½½
- [ ] å¤šç”¨æˆ·éš”ç¦»

## 8. è½¬æ¢å‡½æ•°å‚è€ƒå®ç°

### 8.1 åç«¯è½¬æ¢å™¨

```typescript
// adapters/kode-to-frontend.ts

export class KodeToFrontendAdapter {
  
  convertProgressEvent(envelope: AgentEventEnvelope<ProgressEvent>) {
    const { event } = envelope;
    
    switch (event.type) {
      case 'text_chunk':
        return {
          type: 'assistant_message_delta',
          data: {
            delta: event.delta,
            step: event.step
          }
        };
        
      case 'text_chunk_end':
        return {
          type: 'assistant_message_completed',
          data: {
            content: event.text,
            step: event.step
          }
        };
        
      case 'tool:start':
        return {
          type: 'tool_call_started',
          data: {
            id: event.call.id,
            name: event.call.name,
            input: event.call.inputPreview,
            state: event.call.state
          }
        };
        
      case 'tool:end':
        return {
          type: 'tool_call_completed',
          data: {
            id: event.call.id,
            name: event.call.name,
            result: event.call.result,
            error: event.call.error,
            isError: event.call.isError,
            duration: event.call.durationMs
          }
        };
        
      case 'done':
        return {
          type: 'conversation_completed',
          data: {
            step: event.step,
            reason: event.reason,
            bookmark: envelope.bookmark
          }
        };
        
      default:
        return null;
    }
  }
  
  convertMessage(kodeMessage: Message) {
    const events: any[] = [];
    
    kodeMessage.content.forEach(block => {
      if (block.type === 'text') {
        events.push({
          action: 'message',
          source: kodeMessage.role === 'user' ? 'user' : 'agent',
          args: { content: block.text }
        });
      }
      
      if (block.type === 'tool_use') {
        events.push({
          action: 'call_tool_mcp',
          source: 'agent',
          id: block.id,
          args: {
            name: block.name,
            arguments: block.input
          }
        });
      }
      
      if (block.type === 'tool_result') {
        events.push({
          observation: 'mcp',
          source: 'agent',
          content: typeof block.content === 'string' 
            ? block.content 
            : JSON.stringify(block.content),
          extras: {
            tool_use_id: block.tool_use_id,
            is_error: block.is_error
          }
        });
      }
    });
    
    return events;
  }
}
```

### 8.2 å‰ç«¯è½¬æ¢å™¨

```typescript
// utils/event-converter.ts

export class FrontendEventConverter {
  
  private textAccumulator = new Map<number, string>();
  
  handleKodeEvent(envelope: any, eventStore: any) {
    const { event } = envelope;
    
    switch (event.type) {
      case 'text_chunk_start':
        this.textAccumulator.set(event.step, '');
        eventStore.startMessage({ role: 'assistant' });
        break;
        
      case 'text_chunk':
        const current = this.textAccumulator.get(event.step) || '';
        this.textAccumulator.set(event.step, current + event.delta);
        eventStore.updateCurrentMessage({
          content: this.textAccumulator.get(event.step)
        });
        break;
        
      case 'text_chunk_end':
        eventStore.finalizeMessage({
          action: 'message',
          source: 'agent',
          args: { content: event.text }
        });
        this.textAccumulator.delete(event.step);
        break;
        
      case 'tool:start':
        eventStore.addEvent({
          action: 'call_tool_mcp',
          source: 'agent',
          id: event.call.id,
          args: {
            name: event.call.name,
            arguments: event.call.inputPreview
          }
        });
        break;
        
      case 'tool:end':
        eventStore.addEvent({
          observation: 'mcp',
          source: 'agent',
          content: JSON.stringify(event.call.result),
          extras: {
            name: event.call.name,
            arguments: event.call.inputPreview,
            duration: event.call.durationMs
          }
        });
        break;
        
      case 'done':
        eventStore.setLastBookmark(envelope.bookmark.seq);
        eventStore.markConversationComplete();
        break;
    }
  }
}
```

## 9. å®Œæ•´ç¤ºä¾‹ï¼šç«¯åˆ°ç«¯æµç¨‹

### 9.1 ç”¨æˆ·å‘é€ "è¯»å– README.md"

```typescript
// 1. å‰ç«¯å‘é€
handleSendMessage('è¯»å– README.md');
  â†“
POST /api/conversations/conv_1/messages
  { content: 'è¯»å– README.md' }

// 2. åç«¯å¤„ç†
await agent.send('è¯»å– README.md');
  â†“
MessageQueue.send('è¯»å– README.md', { kind: 'user' })
  â†“
Agent.processLoop()

// 3. æ¨¡å‹å“åº”
Model returns:
{
  role: 'assistant',
  content: [
    { type: 'text', text: 'å¥½çš„ï¼Œæˆ‘æ¥è¯»å–æ–‡ä»¶' },
    { type: 'tool_use', id: 'tool_1', name: 'fs_read', input: { path: 'README.md' } }
  ]
}

// 4. äº‹ä»¶æµ
[text_chunk_start]
[text_chunk] "å¥½"
[text_chunk] "çš„"
[text_chunk] "ï¼Œ"
[text_chunk] "æˆ‘"
[text_chunk] "æ¥"
[text_chunk] "è¯»"
[text_chunk] "å–"
[text_chunk] "æ–‡"
[text_chunk] "ä»¶"
[text_chunk_end] "å¥½çš„ï¼Œæˆ‘æ¥è¯»å–æ–‡ä»¶"
[tool:start] { call: { name: 'fs_read', ... } }
[tool:end] { call: { result: '# README...', ... } }
[text_chunk_start]
[text_chunk] "æ–‡"
[text_chunk] "ä»¶"
[text_chunk] "å†…"
[text_chunk] "å®¹"
[text_chunk] "å¦‚"
[text_chunk] "ä¸‹"
[text_chunk] "ï¼š"
[text_chunk_end] "æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š"
[done]

// 5. å‰ç«¯æ¥æ”¶å’Œæ¸²æŸ“
EventSource receives events
  â†“
TextAccumulator accumulates text
  â†“
UI updates in real-time:
  - "å¥½çš„ï¼Œæˆ‘æ¥è¯»å–æ–‡ä»¶" (UserAssistantEventMessage)
  - [Tool Executing: fs_read] (ObservationPairEventMessage)
  - [Tool Result: # README...] (McpEventMessage)
  - "æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š" (UserAssistantEventMessage)
  â†“
Conversation marked complete
```

## æ€»ç»“

æœ¬å¯¹ç…§è¡¨æä¾›äº†æ‰€æœ‰å…³é”®æ˜ å°„å…³ç³»çš„å¿«é€Ÿå‚è€ƒï¼š

âœ… **æ¶ˆæ¯æ ¼å¼**: Kode Message â†” Frontend Event  
âœ… **äº‹ä»¶ç±»å‹**: Progress/Control/Monitor â†” UI ç»„ä»¶  
âœ… **å·¥å…·è°ƒç”¨**: tool:start/end â†” ObservationPair/Mcp  
âœ… **é”™è¯¯å¤„ç†**: error äº‹ä»¶ â†” ErrorMessage ç»„ä»¶  
âœ… **çŠ¶æ€åŒæ­¥**: Agent state â†” UI state  

**å¼€å‘å»ºè®®**: å°†æœ¬æ–‡æ¡£ä½œä¸ºå®ç°æ—¶çš„é€ŸæŸ¥æ‰‹å†Œï¼Œé…åˆè¯¦ç»†æ–‡æ¡£æ·±å…¥ç†è§£ã€‚

