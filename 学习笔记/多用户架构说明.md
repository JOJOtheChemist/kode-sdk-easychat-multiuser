# Kode-SDK å¤šç”¨æˆ·æ¶æ„è¯´æ˜

## ğŸ¯ æ ¸å¿ƒæ¶æ„åŸç†

### å…³é”®è®¾è®¡ï¼šå• Runtimeï¼Œå¤š Agent

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          åº”ç”¨å¯åŠ¨æ—¶åˆ›å»ºï¼ˆå•ä¾‹ï¼‰                          â”‚
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         AgentDependencies (Runtime)          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  Store (JSONStore/RedisStore)          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - æ‰€æœ‰ Agent çš„æŒä¹…åŒ–æ•°æ®              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - æŒ‰ agentId éš”ç¦»                      â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  TemplateRegistry                      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - æ¨¡æ¿å®šä¹‰ï¼ˆç³»ç»Ÿæç¤ºã€å·¥å…·åˆ—è¡¨ï¼‰         â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  ToolRegistry                          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - å·¥å…·æ³¨å†Œè¡¨                           â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  SandboxFactory                        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - æ²™ç®±å·¥å‚                             â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  ModelFactory (GLM-4.5-air)            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - æ¨¡å‹åˆ›å»ºå·¥å‚                         â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ æ¯ä¸ªè¯·æ±‚åŸºäº userId/sessionId
                           â”‚ åˆ›å»ºæˆ–æ¢å¤å¯¹åº”çš„ Agent
                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           å¤šä¸ª Agent å®ä¾‹                      â”‚
    â”‚                                                â”‚
    â”‚  Agent(agentId: 'user:123')  â† ç”¨æˆ· 123       â”‚
    â”‚  Agent(agentId: 'user:456')  â† ç”¨æˆ· 456       â”‚
    â”‚  Agent(agentId: 'session:abc') â† ä¼šè¯ abc     â”‚
    â”‚  Agent(agentId: 'session:xyz') â† ä¼šè¯ xyz     â”‚
    â”‚                                                â”‚
    â”‚  æ¯ä¸ª Agent æœ‰ç‹¬ç«‹çš„ï¼š                          â”‚
    â”‚  - æ¶ˆæ¯é˜Ÿåˆ—                                     â”‚
    â”‚  - å·¥å…·è°ƒç”¨è®°å½•                                 â”‚
    â”‚  - Todo åˆ—è¡¨                                   â”‚
    â”‚  - ä¸Šä¸‹æ–‡çŠ¶æ€                                   â”‚
    â”‚  - æ²™ç®±ç¯å¢ƒ                                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ¨ æ ¸å¿ƒæ¦‚å¿µ

### 1. Runtimeï¼ˆä¾èµ–å®¹å™¨ï¼‰- å•ä¾‹

**Runtime åªéœ€è¦ä¸€ä¸ª**ï¼Œåœ¨åº”ç”¨å¯åŠ¨æ—¶åˆ›å»ºï¼š

```typescript
// server.ts (åº”ç”¨å¯åŠ¨å…¥å£)
import { createRuntime } from './examples/shared/runtime';
import { GLMProvider } from './src';

// âœ… å…¨å±€å•ä¾‹ - æ•´ä¸ªåº”ç”¨å…±äº«
const deps = createRuntime(({ templates, registerBuiltin }) => {
  registerBuiltin('fs', 'bash', 'todo');

  templates.register({
    id: 'repo-assistant',
    systemPrompt: 'ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„åŠ©æ‰‹',
    tools: ['fs_read', 'fs_write', 'todo_read', 'todo_write'],
    model: 'glm-4-air',
  });
}, {
  storeDir: './.kode',  // æ‰€æœ‰ç”¨æˆ·æ•°æ®å­˜å‚¨åœ¨è¿™é‡Œ
});

// âœ… é…ç½® GLM æ¨¡å‹å·¥å‚
deps.modelFactory = (config) => new GLMProvider(
  'ef22d69d218e4cad8ae3c15bcc77d30d.eULl6aqOo8YEDKzG',
  'glm-4-air',
  'https://open.bigmodel.cn/api/paas/v4'
);
```

### 2. Agent å®ä¾‹ - æ¯ä¸ªç”¨æˆ·/ä¼šè¯ä¸€ä¸ª

**æ¯ä¸ªç”¨æˆ·æˆ–ä¼šè¯æœ‰ç‹¬ç«‹çš„ Agent å®ä¾‹**ï¼š

```typescript
// api/chat.ts
import { Agent } from './src';

// âœ… Resume or Create æ¨¡å¼
async function getAgentForUser(userId: string) {
  const agentId = `user:${userId}`;  // ç”¨ userId ä½œä¸º agentId
  
  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
  const exists = await deps.store.exists(agentId);
  
  if (exists) {
    // æ¢å¤å·²æœ‰çš„ Agent
    return Agent.resumeFromStore(agentId, deps);
  }
  
  // åˆ›å»ºæ–° Agent
  return Agent.create({
    agentId,
    templateId: 'repo-assistant',
    sandbox: { 
      kind: 'local', 
      workDir: `./workspace/${userId}`,  // æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹å·¥ä½œç›®å½•
      enforceBoundary: true 
    },
  }, deps);
}
```

## ğŸ“‹ API è°ƒç”¨æ–¹å¼

### æ–¹å¼ 1: Express API ç¤ºä¾‹ï¼ˆæ¨èï¼‰

```typescript
import express from 'express';
import { Agent } from './src';

const app = express();
app.use(express.json());

// ===== åˆå§‹åŒ– Runtimeï¼ˆå•ä¾‹ï¼‰=====
const deps = createRuntime(/* ... */);

// ===== Resume or Create Helper =====
async function resumeOrCreate(agentId: string) {
  const exists = await deps.store.exists(agentId);
  if (exists) {
    return Agent.resumeFromStore(agentId, deps);
  }
  
  return Agent.create({
    agentId,
    templateId: 'repo-assistant',
    sandbox: { kind: 'local', workDir: `./workspace/${agentId}` },
  }, deps);
}

// ===== API ç«¯ç‚¹ =====

// 1. å‘é€æ¶ˆæ¯
app.post('/api/agents/:agentId/messages', async (req, res) => {
  const { agentId } = req.params;
  const { text } = req.body;
  
  const agent = await resumeOrCreate(agentId);
  
  // ç»‘å®šç›‘æ§ï¼ˆå¯é€‰ï¼‰
  agent.on('error', (event) => {
    console.error('Agent error:', event.message);
  });
  
  await agent.send(text);
  
  res.status(202).json({ status: 'queued' });
});

// 2. è·å– Progress æµï¼ˆSSEï¼‰
app.get('/api/agents/:agentId/stream', async (req, res) => {
  const { agentId } = req.params;
  const agent = await resumeOrCreate(agentId);
  
  // è®¾ç½® SSE headers
  res.setHeader('Content-Type', 'text/event-stream');
  res.setHeader('Cache-Control', 'no-cache');
  res.setHeader('Connection', 'keep-alive');
  res.flushHeaders();
  
  // è®¢é˜…äº‹ä»¶æµ
  const iterator = agent.subscribe(['progress', 'monitor'])[Symbol.asyncIterator]();
  
  try {
    for await (const envelope of { [Symbol.asyncIterator]: () => iterator }) {
      // å‘é€ SSE äº‹ä»¶
      res.write(`data: ${JSON.stringify(envelope)}\n\n`);
      
      // å¯¹è¯å®Œæˆæ—¶ç»“æŸæµ
      if (envelope.event.type === 'done') {
        break;
      }
    }
  } catch (error) {
    console.error('Stream error:', error);
  } finally {
    res.end();
  }
  
  // å®¢æˆ·ç«¯æ–­å¼€æ—¶æ¸…ç†
  req.on('close', () => {
    iterator.return?.();
  });
});

// 3. è·å– Agent çŠ¶æ€
app.get('/api/agents/:agentId/status', async (req, res) => {
  const { agentId } = req.params;
  const agent = await resumeOrCreate(agentId);
  
  const status = await agent.status();
  res.json(status);
});

// 4. å®¡æ‰¹å†³ç­–
app.post('/api/agents/:agentId/approve', async (req, res) => {
  const { agentId } = req.params;
  const { callId, decision, note } = req.body;
  
  const agent = await resumeOrCreate(agentId);
  await agent.decide(callId, decision, note);
  
  res.status(204).end();
});

app.listen(3000, () => {
  console.log('API server running on http://localhost:3000');
});
```

### æ–¹å¼ 2: Next.js API Route

```typescript
// pages/api/agents/[agentId]/stream.ts
import type { NextApiRequest, NextApiResponse } from 'next';
import { Agent } from '@/lib/kode-sdk';
import { deps } from '@/lib/runtime';

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  const agentId = req.query.agentId as string;
  
  // Resume or Create
  const agent = await resumeOrCreate(agentId);
  
  // ç»‘å®šæ§åˆ¶å’Œç›‘æ§
  agent.on('permission_required', (event) => {
    console.log('[Control] Approval needed:', event.call.name);
  });
  
  agent.on('tool_executed', (event) => {
    console.log('[Monitor] Tool executed:', event.call.name);
  });
  
  if (req.method === 'POST') {
    // å‘é€æ¶ˆæ¯
    const { prompt } = req.body;
    await agent.send(prompt);
    res.status(202).json({ status: 'queued' });
    return;
  }
  
  if (req.method === 'GET') {
    // SSE æµ
    res.setHeader('Content-Type', 'text/event-stream');
    res.setHeader('Cache-Control', 'no-cache');
    res.flushHeaders();
    
    for await (const envelope of agent.subscribe(['progress'])) {
      res.write(`data: ${JSON.stringify(envelope)}\n\n`);
      if (envelope.event.type === 'done') break;
    }
    
    res.end();
    return;
  }
  
  res.status(405).end();
}
```

## ğŸ”‘ å¤šç”¨æˆ·éš”ç¦»ç­–ç•¥

### ç­–ç•¥ 1: ç”¨æˆ·çº§éš”ç¦»

```typescript
// æ¯ä¸ªç”¨æˆ·ä¸€ä¸ª Agent
const agentId = `user:${userId}`;

// ä¼˜ç‚¹ï¼š
// - ä¿æŒé•¿æœŸå¯¹è¯ä¸Šä¸‹æ–‡
// - ç”¨æˆ·æ•°æ®å®Œå…¨éš”ç¦»
// - Todoã€æ–‡ä»¶æ“ä½œæŒä¹…åŒ–

// ç¼ºç‚¹ï¼š
// - ä¸Šä¸‹æ–‡å¯èƒ½è¿‡é•¿
// - éœ€è¦å®šæœŸæ¸…ç†æˆ–å‹ç¼©
```

### ç­–ç•¥ 2: ä¼šè¯çº§éš”ç¦»

```typescript
// æ¯ä¸ªä¼šè¯ä¸€ä¸ª Agent
const agentId = `session:${sessionId}`;

// ä¼˜ç‚¹ï¼š
// - ä¸Šä¸‹æ–‡æ›´æ¸…æ™°
// - ä¾¿äºåˆ†å‰å’Œå®éªŒ
// - èµ„æºéš”ç¦»æ›´å¥½

// ç¼ºç‚¹ï¼š
// - è·¨ä¼šè¯æ— æ³•å…±äº«ä¸Šä¸‹æ–‡
// - éœ€è¦ç®¡ç†ä¼šè¯ç”Ÿå‘½å‘¨æœŸ
```

### ç­–ç•¥ 3: æ··åˆæ¨¡å¼

```typescript
// ç”¨æˆ· + ä¼šè¯ç»„åˆ
const agentId = `user:${userId}:session:${sessionId}`;

// æˆ–è€…åŸºäºä¸šåŠ¡åœºæ™¯
const agentId = `project:${projectId}:task:${taskId}`;

// ä¼˜ç‚¹ï¼š
// - çµæ´»æ€§æœ€é«˜
// - å¯ä»¥æŒ‰éœ€ç»„ç»‡
// - æ”¯æŒå¤æ‚ä¸šåŠ¡åœºæ™¯
```

## ğŸ“Š å¤šç”¨æˆ·åœºæ™¯å®Œæ•´ç¤ºä¾‹

### å®Œæ•´çš„ Express æœåŠ¡å™¨

```typescript
// server.ts
import express from 'express';
import cors from 'cors';
import { Agent, AgentConfig, GLMProvider } from './src';
import { createRuntime } from './examples/shared/runtime';

// ===== 1. åˆ›å»ºå…¨å±€ Runtimeï¼ˆå•ä¾‹ï¼‰=====
const deps = createRuntime(({ templates, registerBuiltin }) => {
  registerBuiltin('fs', 'bash', 'todo');

  templates.register({
    id: 'chat-assistant',
    systemPrompt: 'ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„AIåŠ©æ‰‹ï¼Œç”¨ä¸­æ–‡å›ç­”é—®é¢˜ã€‚',
    tools: ['todo_read', 'todo_write', 'fs_read', 'fs_write'],
    model: 'glm-4-air',
    runtime: { 
      todo: { enabled: true, reminderOnStart: false } 
    },
  });
});

// é…ç½® GLM æ¨¡å‹
deps.modelFactory = (config) => new GLMProvider(
  'ef22d69d218e4cad8ae3c15bcc77d30d.eULl6aqOo8YEDKzG',
  'glm-4-air',
  'https://open.bigmodel.cn/api/paas/v4'
);

// ===== 2. Resume or Create Helper =====
async function resumeOrCreate(agentId: string): Promise<Agent> {
  const exists = await deps.store.exists(agentId);
  
  if (exists) {
    // æ¢å¤å·²æœ‰ Agent
    const agent = await Agent.resumeFromStore(agentId, deps);
    bindMonitoring(agent);  // é‡æ–°ç»‘å®šç›‘æ§
    return agent;
  }
  
  // åˆ›å»ºæ–° Agent
  const agent = await Agent.create({
    agentId,
    templateId: 'chat-assistant',
    sandbox: { 
      kind: 'local', 
      workDir: `./workspace/${agentId}`,
      enforceBoundary: true 
    },
  }, deps);
  
  bindMonitoring(agent);
  return agent;
}

// ===== 3. ç»‘å®šç›‘æ§å’Œå®¡æ‰¹ =====
function bindMonitoring(agent: Agent) {
  // ç›‘æ§å·¥å…·æ‰§è¡Œ
  agent.on('tool_executed', (event) => {
    console.log(`[${agent.agentId}] Tool executed:`, {
      tool: event.call.name,
      duration: event.call.durationMs,
      success: !event.call.isError,
    });
  });
  
  // ç›‘æ§é”™è¯¯
  agent.on('error', (event) => {
    console.error(`[${agent.agentId}] Error:`, {
      phase: event.phase,
      message: event.message,
    });
  });
  
  // å¤„ç†å®¡æ‰¹è¯·æ±‚
  agent.on('permission_required', (event) => {
    console.log(`[${agent.agentId}] Approval needed:`, event.call.name);
    // è¿™é‡Œå¯ä»¥æ¨é€åˆ°å®¡æ‰¹ç³»ç»Ÿ
  });
}

// ===== 4. åˆ›å»º API è·¯ç”± =====
const app = express();
app.use(cors());
app.use(express.json());

// æ´»è·ƒçš„ Agent ç¼“å­˜ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰
const activeAgents = new Map<string, Agent>();

// API: å‘é€æ¶ˆæ¯
app.post('/api/chat/:userId', async (req, res) => {
  try {
    const userId = req.params.userId;
    const { message, sessionId } = req.body;
    
    // æ„å»º agentId
    const agentId = sessionId 
      ? `user:${userId}:session:${sessionId}`
      : `user:${userId}`;
    
    // è·å–æˆ–åˆ›å»º Agent
    let agent = activeAgents.get(agentId);
    if (!agent) {
      agent = await resumeOrCreate(agentId);
      activeAgents.set(agentId, agent);
    }
    
    // å‘é€æ¶ˆæ¯
    await agent.send(message);
    
    res.json({ 
      success: true, 
      agentId,
      message: 'æ¶ˆæ¯å·²å‘é€' 
    });
  } catch (error) {
    res.status(500).json({ 
      success: false, 
      error: error.message 
    });
  }
});

// API: è·å–æµå¼å“åº”ï¼ˆSSEï¼‰
app.get('/api/chat/:userId/stream', async (req, res) => {
  try {
    const userId = req.params.userId;
    const sessionId = req.query.sessionId as string;
    
    const agentId = sessionId 
      ? `user:${userId}:session:${sessionId}`
      : `user:${userId}`;
    
    // è·å–æˆ–åˆ›å»º Agent
    let agent = activeAgents.get(agentId);
    if (!agent) {
      agent = await resumeOrCreate(agentId);
      activeAgents.set(agentId, agent);
    }
    
    // è®¾ç½® SSE
    res.setHeader('Content-Type', 'text/event-stream');
    res.setHeader('Cache-Control', 'no-cache');
    res.setHeader('Connection', 'keep-alive');
    res.flushHeaders();
    
    // è®¢é˜…äº‹ä»¶
    const iterator = agent.subscribe(['progress', 'monitor'])[Symbol.asyncIterator]();
    
    for await (const envelope of { [Symbol.asyncIterator]: () => iterator }) {
      res.write(`data: ${JSON.stringify(envelope)}\n\n`);
      
      if (envelope.event.type === 'done') {
        break;
      }
    }
    
    res.end();
    
    // æ¸…ç†è¿æ¥æ—¶çš„å›è°ƒ
    req.on('close', () => {
      iterator.return?.();
    });
  } catch (error) {
    console.error('Stream error:', error);
    res.status(500).end();
  }
});

// API: è·å–ç”¨æˆ·çš„ Agent çŠ¶æ€
app.get('/api/chat/:userId/status', async (req, res) => {
  try {
    const userId = req.params.userId;
    const agentId = `user:${userId}`;
    
    const agent = await resumeOrCreate(agentId);
    const status = await agent.status();
    
    res.json({
      agentId,
      status,
      todos: await agent.getTodos(),
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// API: å®¡æ‰¹å·¥å…·è°ƒç”¨
app.post('/api/chat/:userId/approve', async (req, res) => {
  try {
    const userId = req.params.userId;
    const { callId, decision, note } = req.body;
    
    const agentId = `user:${userId}`;
    const agent = activeAgents.get(agentId) || await resumeOrCreate(agentId);
    
    await agent.decide(callId, decision, note);
    
    res.json({ success: true });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// å¯åŠ¨æœåŠ¡å™¨
app.listen(3000, () => {
  console.log('âœ… å¤šç”¨æˆ· Kode-SDK æœåŠ¡è¿è¡Œåœ¨ http://localhost:3000');
  console.log('ğŸ“Š Runtime: 1 ä¸ªï¼ˆå…±äº«ï¼‰');
  console.log('ğŸ‘¥ Agent: æŒ‰éœ€åˆ›å»ºï¼ˆæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ï¼‰');
});
```

## ğŸ¯ å¸¸è§åœºæ™¯

### åœºæ™¯ 1: èŠå¤©åº”ç”¨ï¼ˆå¤šç”¨æˆ·ï¼‰

```typescript
// ç”¨æˆ· A å‘æ¶ˆæ¯
POST /api/chat/user-a/messages
Body: { "message": "ä½ å¥½" }

// ç”¨æˆ· B å‘æ¶ˆæ¯
POST /api/chat/user-b/messages
Body: { "message": "å¸®æˆ‘å†™ä»£ç " }

// ä¸¤ä¸ªç”¨æˆ·å„è‡ªæœ‰ç‹¬ç«‹çš„ Agent å®ä¾‹
// Agent(agentId: 'user:user-a')
// Agent(agentId: 'user:user-b')
```

### åœºæ™¯ 2: å¤šä¼šè¯æ”¯æŒ

```typescript
// ç”¨æˆ· A çš„ä¼šè¯ 1
const agentId1 = 'user:alice:session:session-1';

// ç”¨æˆ· A çš„ä¼šè¯ 2
const agentId2 = 'user:alice:session:session-2';

// åŒä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªç‹¬ç«‹ä¼šè¯
// æ¯ä¸ªä¼šè¯æœ‰ç‹¬ç«‹çš„ä¸Šä¸‹æ–‡å’Œ Todo
```

### åœºæ™¯ 3: é¡¹ç›®/ä»»åŠ¡çº§éš”ç¦»

```typescript
// é¡¹ç›® A çš„ä»£ç å®¡æŸ¥ Agent
const agentId1 = 'project:proj-a:code-review';

// é¡¹ç›® B çš„æ–‡æ¡£ç”Ÿæˆ Agent
const agentId2 = 'project:proj-b:doc-gen';

// åŸºäºä¸šåŠ¡é€»è¾‘ç»„ç»‡ Agent
```

## ğŸ” æ•°æ®éš”ç¦»å’Œå®‰å…¨

### Store å±‚éš”ç¦»

```typescript
// JSONStore ä¼šä¸ºæ¯ä¸ª agentId åˆ›å»ºç‹¬ç«‹æ–‡ä»¶
.kode/
â”œâ”€â”€ user:123/
â”‚   â”œâ”€â”€ messages.json
â”‚   â”œâ”€â”€ tools.json
â”‚   â”œâ”€â”€ todos.json
â”‚   â””â”€â”€ metadata.json
â”œâ”€â”€ user:456/
â”‚   â”œâ”€â”€ messages.json
â”‚   â””â”€â”€ ...
â””â”€â”€ session:abc/
    â””â”€â”€ ...
```

### Sandbox éš”ç¦»

```typescript
// æ¯ä¸ª Agent ç‹¬ç«‹çš„å·¥ä½œç›®å½•
workspace/
â”œâ”€â”€ user:123/       # ç”¨æˆ· 123 çš„æ–‡ä»¶
â”œâ”€â”€ user:456/       # ç”¨æˆ· 456 çš„æ–‡ä»¶
â””â”€â”€ session:abc/    # ä¼šè¯ abc çš„æ–‡ä»¶

// é…ç½®æ—¶æŒ‡å®š
Agent.create({
  sandbox: {
    kind: 'local',
    workDir: `./workspace/${agentId}`,
    enforceBoundary: true,  // å¼ºåˆ¶è¾¹ç•Œï¼Œé˜²æ­¢è·¨ç›®å½•è®¿é—®
  },
}, deps);
```

## ğŸ’¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. Agent å®ä¾‹ç¼“å­˜

```typescript
// ç¼“å­˜æ´»è·ƒçš„ Agent å®ä¾‹ï¼Œé¿å…é¢‘ç¹ä» Store åŠ è½½
const agentCache = new Map<string, { agent: Agent, lastAccess: number }>();

async function getAgent(agentId: string): Promise<Agent> {
  const cached = agentCache.get(agentId);
  
  if (cached) {
    cached.lastAccess = Date.now();
    return cached.agent;
  }
  
  const agent = await resumeOrCreate(agentId);
  agentCache.set(agentId, { agent, lastAccess: Date.now() });
  
  return agent;
}

// å®šæœŸæ¸…ç†ä¸æ´»è·ƒçš„ Agent
setInterval(() => {
  const now = Date.now();
  const timeout = 30 * 60 * 1000;  // 30 åˆ†é’Ÿ
  
  for (const [agentId, { lastAccess }] of agentCache.entries()) {
    if (now - lastAccess > timeout) {
      agentCache.delete(agentId);
      console.log(`Cleaned inactive agent: ${agentId}`);
    }
  }
}, 5 * 60 * 1000);  // æ¯ 5 åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
```

### 2. ä½¿ç”¨ AgentPool

```typescript
import { AgentPool } from './src';

// AgentPool å†…ç½®äº†ç”Ÿå‘½å‘¨æœŸç®¡ç†
const pool = new AgentPool({
  dependencies: deps,
  maxAgents: 100,  // æœ€å¤§å¹¶å‘ Agent æ•°
});

// ä½¿ç”¨ Pool
const agent = await pool.create({
  agentId: `user:${userId}`,
  templateId: 'chat-assistant',
  sandbox: { kind: 'local', workDir: `./workspace/user-${userId}` },
});

// Pool ä¼šè‡ªåŠ¨ç®¡ç† Agent ç”Ÿå‘½å‘¨æœŸ
```

### 3. Store ä¼˜åŒ–

```typescript
// å¯¹äºé«˜å¹¶å‘åœºæ™¯ï¼Œä½¿ç”¨ Redis Store
import { RedisCheckpointer } from './src';

const deps = createRuntime(/* ... */, {
  storeDir: './.kode',
  // æœªæ¥å¯åˆ‡æ¢åˆ° Redis
});

// æˆ–å®ç°è‡ªå®šä¹‰ Store
class PostgresStore implements Store {
  // å®ç° Store æ¥å£
  // æ•°æ®å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œæ”¯æŒæ›´å¥½çš„å¹¶å‘å’ŒæŸ¥è¯¢
}
```

## ğŸ“ˆ æ‰©å±•æ€§è€ƒè™‘

### æ°´å¹³æ‰©å±•

```typescript
// å¤šä¸ªæœåŠ¡å™¨å®ä¾‹å…±äº«åŒä¸€ä¸ª Store
// ä½¿ç”¨ Redis/PostgreSQL ä½œä¸ºå…±äº«å­˜å‚¨

Server 1 â”€â”€â”
Server 2 â”€â”€â”¼â”€â”€â–¶ Redis/PostgreSQL Store
Server 3 â”€â”€â”˜

// æ³¨æ„äº‹é¡¹ï¼š
// 1. Store éœ€è¦æ”¯æŒå¹¶å‘å†™å…¥
// 2. åŒä¸€ä¸ª agentId åŒæ—¶åªèƒ½åœ¨ä¸€ä¸ªå®ä¾‹ä¸­æ´»è·ƒ
// 3. ä½¿ç”¨åˆ†å¸ƒå¼é”é¿å…ç«æ€
```

### è´Ÿè½½å‡è¡¡

```typescript
// åŸºäº agentId åšä¸€è‡´æ€§å“ˆå¸Œ
function getServerForAgent(agentId: string): string {
  const hash = hashCode(agentId);
  const serverIndex = hash % serverCount;
  return servers[serverIndex];
}

// æˆ–ä½¿ç”¨ç²˜æ€§ä¼šè¯ï¼ˆSticky Sessionï¼‰
// Nginx/HAProxy é…ç½®ï¼š
// - åŸºäº userId è·¯ç”±åˆ°å›ºå®šæœåŠ¡å™¨
// - é¿å…è·¨æœåŠ¡å™¨è¿ç§» Agent
```

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### ç›‘æ§æŒ‡æ ‡

```typescript
// ç»Ÿè®¡æ´»è·ƒ Agent æ•°é‡
app.get('/api/metrics', (req, res) => {
  res.json({
    activeAgents: activeAgents.size,
    totalUsers: getUserCount(),
    runtime: {
      storeType: 'JSONStore',
      templateCount: deps.templateRegistry.list().length,
      toolCount: deps.toolRegistry.list().length,
    },
  });
});
```

### è°ƒè¯•æ—¥å¿—

```typescript
// ä¸ºæ¯ä¸ª Agent æ·»åŠ è¯¦ç»†æ—¥å¿—
agent.on('state_changed', (event) => {
  console.log(`[${agent.agentId}] State: ${event.old} â†’ ${event.new}`);
});

agent.on('token_usage', (event) => {
  console.log(`[${agent.agentId}] Tokens:`, {
    input: event.inputTokens,
    output: event.outputTokens,
  });
});
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### âœ… æ­£ç¡®åšæ³•

1. **Runtime å•ä¾‹**: å…¨å±€åªåˆ›å»ºä¸€æ¬¡ `AgentDependencies`
2. **agentId éš”ç¦»**: æ¯ä¸ªç”¨æˆ·/ä¼šè¯ä½¿ç”¨å”¯ä¸€ agentId
3. **Resume or Create**: æ¯æ¬¡è¯·æ±‚æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
4. **é‡æ–°ç»‘å®šäº‹ä»¶**: Resume åå¿…é¡»é‡æ–°ç»‘å®š Control/Monitor å›è°ƒ
5. **æ¸…ç†ä¸æ´»è·ƒ Agent**: å®šæœŸæ¸…ç†ç¼“å­˜ï¼Œé¿å…å†…å­˜æ³„æ¼

### âŒ é”™è¯¯åšæ³•

1. âŒ **æ¯ä¸ªç”¨æˆ·åˆ›å»ºä¸€ä¸ª Runtime**: ä¼šå¯¼è‡´èµ„æºæµªè´¹å’Œæ•°æ®å†²çª
2. âŒ **ä¸ä½¿ç”¨ agentId éš”ç¦»**: ä¼šå¯¼è‡´ç”¨æˆ·æ•°æ®æ··ä¹±
3. âŒ **ä¸é‡æ–°ç»‘å®šäº‹ä»¶**: Resume åäº‹ä»¶ç›‘å¬ä¼šä¸¢å¤±
4. âŒ **å…±äº«åŒä¸€ä¸ª Agent**: å¤šä¸ªç”¨æˆ·ä½¿ç”¨åŒä¸€ä¸ª agentId ä¼šå†²çª
5. âŒ **å¿˜è®°æ¸…ç†**: Agent ç¼“å­˜æ— é™å¢é•¿å¯¼è‡´å†…å­˜é—®é¢˜

## ğŸ¯ æœ€ä½³å®è·µæ€»ç»“

### æ¶æ„åŸåˆ™

```
âœ… å• Runtimeï¼Œå¤š Agent
âœ… æ¯ä¸ªç”¨æˆ·/ä¼šè¯ç‹¬ç«‹ agentId
âœ… Resume or Create æ¨¡å¼
âœ… çŠ¶æ€æŒä¹…åŒ–åˆ° Store
âœ… äº‹ä»¶é©±åŠ¨çš„å¼‚æ­¥æ¶æ„
```

### ä»£ç ç»„ç»‡

```typescript
// âœ… æ¨èç»“æ„
server.ts
â”œâ”€â”€ åˆ›å»º Runtimeï¼ˆå•ä¾‹ï¼‰
â”œâ”€â”€ å®šä¹‰ resumeOrCreate helper
â”œâ”€â”€ å®ç° API è·¯ç”±
â””â”€â”€ å¯åŠ¨æœåŠ¡å™¨

// æ¯ä¸ªè¯·æ±‚ï¼š
1. è§£æ userId/sessionId
2. æ„å»º agentId
3. resumeOrCreate(agentId)
4. å‘é€æ¶ˆæ¯æˆ–è®¢é˜…äº‹ä»¶
5. è¿”å›å“åº”
```

### èµ„æºç®¡ç†

```typescript
// âœ… ç”Ÿå‘½å‘¨æœŸç®¡ç†
- å¯åŠ¨: åˆ›å»º Runtimeï¼ˆ1æ¬¡ï¼‰
- è¯·æ±‚: åˆ›å»º/æ¢å¤ Agentï¼ˆæŒ‰éœ€ï¼‰
- æ¸…ç†: å®šæœŸæ¸…ç†ä¸æ´»è·ƒ Agent
- å…³é—­: ä¼˜é›…å…³é—­æ‰€æœ‰ Agent
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [docs/api.md](./docs/api.md) - å®Œæ•´ API å‚è€ƒ
- [docs/quickstart.md](./docs/quickstart.md) - å¿«é€Ÿå¼€å§‹æŒ‡å—
- [docs/resume.md](./docs/resume.md) - Resume/Fork è¯¦ç»†è¯´æ˜
- [docs/playbooks.md](./docs/playbooks.md) - å…¸å‹åœºæ™¯è„šæœ¬
- [examples/nextjs-api-route.ts](./examples/nextjs-api-route.ts) - Next.js ç¤ºä¾‹

## ğŸŠ æ€»ç»“

### æ ¸å¿ƒç­”æ¡ˆ

**å¤šç”¨æˆ·åœºæ™¯ä¸‹ï¼š**

1. âœ… **åªéœ€è¦ 1 ä¸ª Runtimeï¼ˆä¾èµ–å®¹å™¨ï¼‰** - å…¨å±€å•ä¾‹
2. âœ… **æ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„ Agent å®ä¾‹** - é€šè¿‡ agentId åŒºåˆ†
3. âœ… **æ•°æ®è‡ªåŠ¨éš”ç¦»** - Store æŒ‰ agentId åˆ†ç›®å½•å­˜å‚¨
4. âœ… **Resume or Create æ¨¡å¼** - è‡ªåŠ¨æ¢å¤å·²æœ‰ä¼šè¯

### è°ƒç”¨æµç¨‹

```
ç”¨æˆ·è¯·æ±‚ â†’ æå– userId/sessionId 
         â†’ æ„å»º agentId 
         â†’ resumeOrCreate(agentId) 
         â†’ å‘é€æ¶ˆæ¯/è®¢é˜…äº‹ä»¶ 
         â†’ è¿”å›å“åº”
```

### æ€§èƒ½ç‰¹ç‚¹

- ğŸš€ **é«˜æ•ˆ**: Runtime å•ä¾‹é¿å…é‡å¤åˆå§‹åŒ–
- ğŸ”’ **å®‰å…¨**: agentId éš”ç¦»ä¿è¯æ•°æ®å®‰å…¨
- ğŸ“ˆ **å¯æ‰©å±•**: æ”¯æŒæ°´å¹³æ‰©å±•ï¼ˆå…±äº« Storeï¼‰
- ğŸ’¾ **æŒä¹…åŒ–**: Agent çŠ¶æ€è‡ªåŠ¨ä¿å­˜å’Œæ¢å¤

**ç»“è®ºï¼šKode-SDK çš„è®¾è®¡éå¸¸é€‚åˆå¤šç”¨æˆ·åœºæ™¯ï¼** âœ¨

