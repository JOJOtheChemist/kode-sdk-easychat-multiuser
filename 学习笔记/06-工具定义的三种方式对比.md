# å·¥å…·å®šä¹‰çš„ä¸‰ç§æ–¹å¼å¯¹æ¯”

## æ¦‚è¿°

KODE SDK æä¾›äº†ä¸‰ç§å·¥å…·å®šä¹‰æ–¹å¼ï¼Œä»ç®€å•åˆ°å¤æ‚ä¾æ¬¡ä¸ºï¼š`defineTool`ï¼ˆç®€åŒ–å‡½æ•°ï¼‰ã€`tool`ï¼ˆZod Schemaï¼‰ã€ç›´æ¥æ„é€  `ToolInstance`ï¼ˆåº•å±‚æ–¹å¼ï¼‰ã€‚æœ¬æ–‡æ¡£è¯¦ç»†å¯¹æ¯”è¿™ä¸‰ç§æ–¹å¼çš„åŸç†ã€ä½¿ç”¨åœºæ™¯å’Œè½¬æ¢æµç¨‹ã€‚

---

## ä¸€ã€ä¸‰ç§å®šä¹‰æ–¹å¼æ¦‚è§ˆ

### 1.1 å¿«é€Ÿå¯¹æ¯”è¡¨

| æ–¹å¼ | å‡½æ•°/API | Schema ç±»å‹ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|-----|---------|------------|------|---------|
| **ç®€åŒ–å®šä¹‰** | `defineTool` | ç®€åŒ–å‚æ•° â†’ JSON Schema | âœ… æœ€ç®€å•<br>âœ… è‡ªåŠ¨ç”Ÿæˆ Schema<br>âŒ åŠŸèƒ½æœ‰é™ | å¿«é€Ÿå¼€å‘ã€ç®€å•å·¥å…· |
| **Zod Schema** | `tool` | Zod â†’ JSON Schema | âœ… ç±»å‹å®‰å…¨<br>âœ… å¼ºå¤§éªŒè¯<br>âœ… è‡ªåŠ¨æ¨æ–­ | å¤æ‚å·¥å…·ã€ç±»å‹ä¸¥æ ¼ |
| **åº•å±‚æ–¹å¼** | ç›´æ¥æ„é€  | æ‰‹å†™ JSON Schema | âœ… å®Œå…¨æ§åˆ¶<br>âŒ æœ€ç¹ç | ç‰¹æ®Šéœ€æ±‚ã€åº•å±‚å¼€å‘ |

---

## äºŒã€æ–¹å¼ä¸€ï¼š`defineTool` ç®€åŒ–å®šä¹‰ï¼ˆæ¨èå…¥é—¨ï¼‰

### 2.1 æ ¸å¿ƒåŸç†

**è¿™ä¸æ˜¯æ¨¡æ¿ï¼Œè€Œæ˜¯ä¸€ä¸ªå°è£…å‡½æ•°ï¼**

`defineTool` æ˜¯å®šä¹‰åœ¨ `src/tools/define.ts` çš„è¾…åŠ©å‡½æ•°ï¼Œå®ƒæ¥æ”¶ç®€åŒ–çš„å‚æ•°å®šä¹‰ï¼Œç„¶åï¼š
1. è‡ªåŠ¨è½¬æ¢ä¸ºæ ‡å‡† JSON Schema
2. ä½¿ç”¨ AJV è¿›è¡Œå‚æ•°æ ¡éªŒ
3. è¿”å›æ ‡å‡†çš„ `ToolInstance` å¯¹è±¡

**ä½ç½®ï¼š** `src/tools/define.ts` ç¬¬ 144-217 è¡Œ

### 2.2 ä½¿ç”¨ç¤ºä¾‹ï¼ˆæ¥è‡ª demo-server.tsï¼‰

```typescript
const calculatorTool = defineTool({
  name: 'calculator',
  description: 'æ‰§è¡Œæ•°å­¦è®¡ç®—ï¼Œæ”¯æŒåŠ å‡ä¹˜é™¤',
  
  // ğŸ”‘ ç®€åŒ–çš„å‚æ•°å®šä¹‰
  params: {
    operation: {
      type: 'string',
      enum: ['add', 'subtract', 'multiply', 'divide'],
      description: 'è¿ç®—ç±»å‹',
    },
    a: { type: 'number', description: 'ç¬¬ä¸€ä¸ªæ•°å­—' },
    b: { type: 'number', description: 'ç¬¬äºŒä¸ªæ•°å­—' },
  },
  
  attributes: { readonly: true, noEffect: true },
  
  async exec(args: { operation: string; a: number; b: number }) {
    // å·¥å…·æ‰§è¡Œé€»è¾‘
    switch (args.operation) {
      case 'add': return { ok: true, result: args.a + args.b };
      // ...
    }
  }
});
```

### 2.3 å†…éƒ¨è½¬æ¢æµç¨‹

#### æ­¥éª¤ 1ï¼šå®šä¹‰ç®€åŒ–çš„ params

```typescript
// ä½ å†™çš„ç®€åŒ–å®šä¹‰
params: {
  operation: {
    type: 'string',
    enum: ['add', 'subtract', 'multiply', 'divide'],
    description: 'è¿ç®—ç±»å‹',
  },
  a: { type: 'number', description: 'ç¬¬ä¸€ä¸ªæ•°å­—' },
  b: { type: 'number', description: 'ç¬¬äºŒä¸ªæ•°å­—' },
}
```

#### æ­¥éª¤ 2ï¼šè‡ªåŠ¨ç”Ÿæˆ JSON Schema

**ä½ç½®ï¼š** `src/tools/define.ts` ç¬¬ 59-98 è¡Œ

```typescript
function generateSchema(params?: Record<string, ParamDef>): any {
  if (!params) {
    return { type: 'object', properties: {} };
  }

  const properties: Record<string, any> = {};
  const required: string[] = [];

  for (const [key, def] of Object.entries(params)) {
    const prop: any = { type: def.type };

    if (def.description) prop.description = def.description;
    if (def.enum) prop.enum = def.enum;
    if (def.default !== undefined) prop.default = def.default;

    // å¤„ç†åµŒå¥—ç±»å‹ï¼ˆarrayã€objectï¼‰
    if (def.type === 'array' && def.items) {
      prop.items = generateSchemaProp(def.items);
    }
    if (def.type === 'object' && def.properties) {
      const nested = generateSchema(def.properties);
      prop.properties = nested.properties;
      if (nested.required?.length > 0) {
        prop.required = nested.required;
      }
    }

    properties[key] = prop;

    // ğŸ”‘ é»˜è®¤æ‰€æœ‰å­—æ®µéƒ½æ˜¯ requiredï¼ˆé™¤éæ˜ç¡®è®¾ç½® required: falseï¼‰
    if (def.required !== false) {
      required.push(key);
    }
  }

  return {
    type: 'object',
    properties,
    ...(required.length > 0 ? { required } : {}),
  };
}
```

#### æ­¥éª¤ 3ï¼šç”Ÿæˆçš„ JSON Schema

```json
{
  "type": "object",
  "properties": {
    "operation": {
      "type": "string",
      "enum": ["add", "subtract", "multiply", "divide"],
      "description": "è¿ç®—ç±»å‹"
    },
    "a": {
      "type": "number",
      "description": "ç¬¬ä¸€ä¸ªæ•°å­—"
    },
    "b": {
      "type": "number",
      "description": "ç¬¬äºŒä¸ªæ•°å­—"
    }
  },
  "required": ["operation", "a", "b"]
}
```

#### æ­¥éª¤ 4ï¼šåˆ›å»º ToolInstance

**ä½ç½®ï¼š** `src/tools/define.ts` ç¬¬ 149-205 è¡Œ

```typescript
export function defineTool<TArgs = any, TResult = any>(
  def: SimpleToolDef<TArgs, TResult>,
  options?: { autoRegister?: boolean }
): ToolInstance {
  // ğŸ”‘ å…³é”®ï¼šè‡ªåŠ¨ç”Ÿæˆ schema æˆ–ä½¿ç”¨æä¾›çš„
  const input_schema = def.input_schema || generateSchema(def.params);

  const toolInstance: ToolInstance = {
    name: def.name,
    description: def.description,
    input_schema,  // ç”Ÿæˆçš„ JSON Schema
    prompt: def.prompt,

    async exec(args: any, ctx: ToolContext): Promise<any> {
      // å¢å¼ºä¸Šä¸‹æ–‡ï¼Œæ·»åŠ  emit æ–¹æ³•
      const enhancedCtx: EnhancedToolContext = {
        ...ctx,
        emit(eventType: string, data?: any) {
          ctx.agent?.events?.emitMonitor({
            type: 'tool_custom_event' as any,
            toolName: def.name,
            eventType,
            data,
            timestamp: Date.now(),
          } as any);
        },
      };

      return await def.exec(args, enhancedCtx);
    },

    toDescriptor(): ToolDescriptor {
      // è½¬æ¢ attributes ä¸ºå†…éƒ¨ metadata
      const metadata: Record<string, any> = { tuned: false };
      
      if (def.attributes?.readonly) {
        metadata.access = 'read';
        metadata.mutates = false;
      } else {
        metadata.access = 'write';
        metadata.mutates = true;
      }
      
      if (def.attributes?.noEffect !== undefined) {
        metadata.safe = def.attributes.noEffect;
      }

      return {
        source: 'registered',
        name: def.name,
        registryId: def.name,
        metadata,
      };
    },
  };

  // ğŸ”‘ è‡ªåŠ¨æ³¨å†Œåˆ°å…¨å±€ registryï¼ˆæ”¯æŒ Resumeï¼‰
  if (options?.autoRegister !== false) {
    globalToolRegistry.register(def.name, (_config) => {
      return defineTool(def, { autoRegister: false });
    });
  }

  return toolInstance;
}
```

### 2.4 ç®€åŒ–å‚æ•°å®šä¹‰æ¥å£

**ä½ç½®ï¼š** `src/tools/define.ts` ç¬¬ 22-30 è¡Œ

```typescript
export interface ParamDef {
  type: 'string' | 'number' | 'boolean' | 'object' | 'array';
  description?: string;
  required?: boolean;      // é»˜è®¤ true
  default?: any;
  enum?: any[];            // æšä¸¾å€¼
  items?: ParamDef;        // æ•°ç»„å…ƒç´ ç±»å‹ï¼ˆtype ä¸º array æ—¶ï¼‰
  properties?: Record<string, ParamDef>;  // å¯¹è±¡å±æ€§ï¼ˆtype ä¸º object æ—¶ï¼‰
}
```

### 2.5 æ”¯æŒçš„åŠŸèƒ½ç‰¹æ€§

#### âœ… åŸºæœ¬ç±»å‹
```typescript
params: {
  name: { type: 'string', description: 'åç§°' },
  age: { type: 'number', description: 'å¹´é¾„' },
  active: { type: 'boolean', description: 'æ˜¯å¦æ¿€æ´»' },
}
```

#### âœ… æšä¸¾å€¼
```typescript
params: {
  status: { 
    type: 'string', 
    enum: ['pending', 'active', 'completed'],
    description: 'çŠ¶æ€'
  },
}
```

#### âœ… å¯é€‰å‚æ•°
```typescript
params: {
  required_field: { type: 'string' },  // é»˜è®¤ required
  optional_field: { type: 'string', required: false },
}
```

#### âœ… é»˜è®¤å€¼
```typescript
params: {
  timeout: { 
    type: 'number', 
    default: 3000,
    description: 'è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰'
  },
}
```

#### âœ… æ•°ç»„ç±»å‹
```typescript
params: {
  tags: {
    type: 'array',
    items: { type: 'string' },
    description: 'æ ‡ç­¾åˆ—è¡¨',
  },
}
```

#### âœ… åµŒå¥—å¯¹è±¡
```typescript
params: {
  user: {
    type: 'object',
    properties: {
      name: { type: 'string' },
      email: { type: 'string' },
      age: { type: 'number', required: false },
    },
    description: 'ç”¨æˆ·ä¿¡æ¯',
  },
}
```

---

## ä¸‰ã€æ–¹å¼äºŒï¼š`tool` å‡½æ•°ï¼ˆZod Schemaï¼‰

### 3.1 æ ¸å¿ƒåŸç†

**ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä½†ä½¿ç”¨ Zod è¿›è¡Œç±»å‹å®‰å…¨çš„å‚æ•°å®šä¹‰ï¼**

`tool` å‡½æ•°å®šä¹‰åœ¨ `src/tools/tool.ts`ï¼Œå®ƒï¼š
1. æ¥æ”¶ Zod Schema ä½œä¸ºå‚æ•°å®šä¹‰
2. è‡ªåŠ¨è½¬æ¢ Zod â†’ JSON Schemaï¼ˆä½¿ç”¨ `zod-to-json-schema`ï¼‰
3. åœ¨æ‰§è¡Œå‰ä½¿ç”¨ Zod æ ¡éªŒå‚æ•°
4. æä¾›å®Œæ•´çš„ TypeScript ç±»å‹æ¨æ–­

**ä½ç½®ï¼š** `src/tools/tool.ts` ç¬¬ 54-153 è¡Œ

### 3.2 ä½¿ç”¨ç¤ºä¾‹

```typescript
import { z } from 'zod';
import { tool } from '../src/tools/tool';

const calculatorTool = tool({
  name: 'calculator',
  description: 'æ‰§è¡Œæ•°å­¦è®¡ç®—',
  
  // ğŸ”‘ ä½¿ç”¨ Zod Schema
  parameters: z.object({
    operation: z.enum(['add', 'subtract', 'multiply', 'divide'])
      .describe('è¿ç®—ç±»å‹'),
    a: z.number().describe('ç¬¬ä¸€ä¸ªæ•°å­—'),
    b: z.number().describe('ç¬¬äºŒä¸ªæ•°å­—'),
  }),
  
  async execute(args, ctx) {
    // args å·²ç»è¿‡ Zod æ ¡éªŒï¼Œç±»å‹å®‰å…¨ï¼
    // TypeScript èƒ½è‡ªåŠ¨æ¨æ–­ args çš„ç±»å‹
    const { operation, a, b } = args;
    
    switch (operation) {
      case 'add': return a + b;
      case 'subtract': return a - b;
      case 'multiply': return a * b;
      case 'divide':
        if (b === 0) throw new Error('é™¤æ•°ä¸èƒ½ä¸º0');
        return a / b;
    }
  }
});
```

### 3.3 Zod â†’ JSON Schema è½¬æ¢

**ä½ç½®ï¼š** `src/tools/tool.ts` ç¬¬ 69-72 è¡Œ

```typescript
// ç”Ÿæˆ JSON Schema
const input_schema = def.parameters
  ? zodToJsonSchema(def.parameters, { 
      target: 'openApi3',      // ç›®æ ‡æ ¼å¼ï¼šOpenAPI 3.0
      $refStrategy: 'none'     // ä¸ä½¿ç”¨ $ref å¼•ç”¨
    })
  : { type: 'object', properties: {} };
```

### 3.4 Zod æ ¡éªŒæµç¨‹

**ä½ç½®ï¼š** `src/tools/tool.ts` ç¬¬ 81-94 è¡Œ

```typescript
async exec(args: any, ctx: ToolContext): Promise<any> {
  try {
    // å‚æ•°éªŒè¯
    if (def.parameters) {
      const parseResult = def.parameters.safeParse(args);
      if (!parseResult.success) {
        return {
          ok: false,
          error: `Invalid parameters: ${parseResult.error.message}`,
          _validationError: true,  // æ ‡è®°ä¸ºæ ¡éªŒé”™è¯¯
        };
      }
      args = parseResult.data;  // ä½¿ç”¨æ ¡éªŒåçš„æ•°æ®ï¼ˆå¯èƒ½åŒ…å«è½¬æ¢ï¼‰
    }

    // æ‰§è¡Œå·¥å…·
    const result = await def.execute(args, enhancedCtx);
    
    // å¤„ç†è¿”å›å€¼...
  } catch (error: any) {
    return {
      ok: false,
      error: error?.message || String(error),
      _thrownError: true,
    };
  }
}
```

### 3.5 Zod çš„é«˜çº§åŠŸèƒ½

#### âœ… ç±»å‹è½¬æ¢
```typescript
parameters: z.object({
  port: z.string().transform(val => parseInt(val, 10)),  // å­—ç¬¦ä¸² â†’ æ•°å­—
  enabled: z.union([z.boolean(), z.string()]).transform(val => {
    if (typeof val === 'string') return val === 'true';
    return val;
  }),
}),
```

#### âœ… è‡ªå®šä¹‰éªŒè¯
```typescript
parameters: z.object({
  email: z.string().email('æ— æ•ˆçš„é‚®ç®±åœ°å€'),
  age: z.number().min(0).max(150, 'å¹´é¾„å¿…é¡»åœ¨ 0-150 ä¹‹é—´'),
  url: z.string().url('æ— æ•ˆçš„ URL'),
}),
```

#### âœ… æ¡ä»¶éªŒè¯
```typescript
parameters: z.object({
  type: z.enum(['local', 'remote']),
  path: z.string().optional(),
  url: z.string().optional(),
}).refine(data => {
  // å¦‚æœæ˜¯ remote ç±»å‹ï¼Œå¿…é¡»æä¾› url
  if (data.type === 'remote' && !data.url) {
    return false;
  }
  // å¦‚æœæ˜¯ local ç±»å‹ï¼Œå¿…é¡»æä¾› path
  if (data.type === 'local' && !data.path) {
    return false;
  }
  return true;
}, {
  message: 'local éœ€è¦ path, remote éœ€è¦ url',
}),
```

#### âœ… å¤æ‚åµŒå¥—ç»“æ„
```typescript
parameters: z.object({
  users: z.array(z.object({
    name: z.string().min(1),
    email: z.string().email(),
    roles: z.array(z.enum(['admin', 'user', 'guest'])),
    metadata: z.record(z.string(), z.any()).optional(),
  })),
}),
```

---

## å››ã€æ–¹å¼ä¸‰ï¼šç›´æ¥æ„é€  ToolInstanceï¼ˆåº•å±‚æ–¹å¼ï¼‰

### 4.1 æ ¸å¿ƒåŸç†

ç›´æ¥åˆ›å»ºç¬¦åˆ `ToolInstance` æ¥å£çš„å¯¹è±¡ï¼Œå®Œå…¨æ‰‹åŠ¨æ§åˆ¶ã€‚

**ä½ç½®ï¼š** `src/tools/registry.ts`

### 4.2 ä½¿ç”¨ç¤ºä¾‹

```typescript
import { ToolInstance } from '../src/tools/registry';

const calculatorTool: ToolInstance = {
  name: 'calculator',
  description: 'æ‰§è¡Œæ•°å­¦è®¡ç®—',
  
  // ğŸ”‘ æ‰‹å†™ JSON Schema
  input_schema: {
    type: 'object',
    properties: {
      operation: {
        type: 'string',
        enum: ['add', 'subtract', 'multiply', 'divide'],
        description: 'è¿ç®—ç±»å‹',
      },
      a: {
        type: 'number',
        description: 'ç¬¬ä¸€ä¸ªæ•°å­—',
      },
      b: {
        type: 'number',
        description: 'ç¬¬äºŒä¸ªæ•°å­—',
      },
    },
    required: ['operation', 'a', 'b'],
  },
  
  async exec(args: any, ctx: ToolContext): Promise<any> {
    // éœ€è¦æ‰‹åŠ¨å¤„ç†æ‰€æœ‰é€»è¾‘
    const { operation, a, b } = args;
    
    // æ‰‹åŠ¨æ ¡éªŒï¼ˆå¦‚æœéœ€è¦ï¼‰
    if (typeof a !== 'number' || typeof b !== 'number') {
      return { ok: false, error: 'å‚æ•°ç±»å‹é”™è¯¯' };
    }
    
    // æ‰§è¡Œé€»è¾‘
    switch (operation) {
      case 'add': return { ok: true, result: a + b };
      case 'subtract': return { ok: true, result: a - b };
      case 'multiply': return { ok: true, result: a * b };
      case 'divide':
        if (b === 0) return { ok: false, error: 'é™¤æ•°ä¸èƒ½ä¸º0' };
        return { ok: true, result: a / b };
      default:
        return { ok: false, error: 'ä¸æ”¯æŒçš„è¿ç®—' };
    }
  },
  
  toDescriptor() {
    return {
      source: 'registered' as const,
      name: 'calculator',
      registryId: 'calculator',
      metadata: {
        access: 'read',
        mutates: false,
        safe: true,
      },
    };
  },
};
```

---

## äº”ã€ä¸‰ç§æ–¹å¼çš„è¯¦ç»†å¯¹æ¯”

### 5.1 Schema å®šä¹‰å¯¹æ¯”

#### defineToolï¼ˆç®€åŒ–ï¼‰
```typescript
params: {
  name: { type: 'string', description: 'åç§°' },
  age: { type: 'number', required: false },
}
```

#### toolï¼ˆZodï¼‰
```typescript
parameters: z.object({
  name: z.string().describe('åç§°'),
  age: z.number().optional(),
}),
```

#### ç›´æ¥æ„é€ ï¼ˆJSON Schemaï¼‰
```typescript
input_schema: {
  type: 'object',
  properties: {
    name: { type: 'string', description: 'åç§°' },
    age: { type: 'number' },
  },
  required: ['name'],
}
```

### 5.2 æ ¡éªŒæ–¹å¼å¯¹æ¯”

| æ–¹å¼ | æ ¡éªŒå™¨ | æ ¡éªŒæ—¶æœº | é”™è¯¯ä¿¡æ¯ |
|-----|-------|---------|---------|
| `defineTool` | AJVï¼ˆè‡ªåŠ¨ç”Ÿæˆçš„ Schemaï¼‰ | Agent æ‰§è¡Œæ—¶ | JSON Schema é”™è¯¯ |
| `tool` | Zodï¼ˆ`.safeParse()`ï¼‰ | å·¥å…·æ‰§è¡Œå‰ | Zod é”™è¯¯ï¼ˆæ›´å‹å¥½ï¼‰ |
| ç›´æ¥æ„é€  | AJVï¼ˆæ‰‹å†™çš„ Schemaï¼‰ | Agent æ‰§è¡Œæ—¶ | JSON Schema é”™è¯¯ |

### 5.3 ç±»å‹å®‰å…¨å¯¹æ¯”

```typescript
// defineToolï¼šéœ€è¦æ‰‹åŠ¨æŒ‡å®šç±»å‹
async exec(args: { name: string; age: number }) {
  args.name  // stringï¼ˆæ‰‹åŠ¨æŒ‡å®šï¼‰
}

// toolï¼šè‡ªåŠ¨æ¨æ–­ç±»å‹
parameters: z.object({
  name: z.string(),
  age: z.number(),
}),
async execute(args, ctx) {
  args.name  // stringï¼ˆè‡ªåŠ¨æ¨æ–­ï¼ï¼‰
  args.age   // numberï¼ˆè‡ªåŠ¨æ¨æ–­ï¼ï¼‰
}

// ç›´æ¥æ„é€ ï¼šæ— ç±»å‹å®‰å…¨
async exec(args: any, ctx: ToolContext) {
  args.name  // anyï¼ˆéœ€è¦æ‰‹åŠ¨æ–­è¨€ï¼‰
}
```

### 5.4 åŠŸèƒ½å®Œæ•´æ€§å¯¹æ¯”

| åŠŸèƒ½ | defineTool | tool (Zod) | ç›´æ¥æ„é€  |
|-----|-----------|-----------|---------|
| åŸºæœ¬ç±»å‹ | âœ… | âœ… | âœ… |
| æšä¸¾ | âœ… | âœ… | âœ… |
| å¯é€‰å‚æ•° | âœ… | âœ… | âœ… |
| é»˜è®¤å€¼ | âœ… | âœ… | âœ… |
| åµŒå¥—å¯¹è±¡ | âœ… | âœ… | âœ… |
| æ•°ç»„ | âœ… | âœ… | âœ… |
| ç±»å‹è½¬æ¢ | âŒ | âœ… | âŒ |
| è‡ªå®šä¹‰éªŒè¯ | âŒ | âœ… | éœ€æ‰‹åŠ¨å®ç° |
| æ¡ä»¶éªŒè¯ | âŒ | âœ… | éœ€æ‰‹åŠ¨å®ç° |
| ç±»å‹æ¨æ–­ | âŒ | âœ… | âŒ |
| è‡ªåŠ¨æ³¨å†Œ | âœ… | âœ… | éœ€æ‰‹åŠ¨æ³¨å†Œ |

---

## å…­ã€é€‰æ‹©æŒ‡å—

### 6.1 æ¨èä½¿ç”¨åœºæ™¯

#### ä½¿ç”¨ `defineTool` å¦‚æœï¼š
- âœ… å¿«é€Ÿå¼€å‘åŸå‹
- âœ… å·¥å…·å‚æ•°ç®€å•
- âœ… ä¸éœ€è¦å¤æ‚çš„ç±»å‹è½¬æ¢
- âœ… æƒ³è¦æœ€å°‘çš„æ ·æ¿ä»£ç 

**ç¤ºä¾‹åœºæ™¯ï¼š** ç®€å•çš„è®¡ç®—å™¨ã€å¤©æ°”æŸ¥è¯¢ã€æ—¶é—´å·¥å…·

#### ä½¿ç”¨ `tool` (Zod) å¦‚æœï¼š
- âœ… éœ€è¦ç±»å‹å®‰å…¨
- âœ… å‚æ•°éœ€è¦å¤æ‚éªŒè¯
- âœ… éœ€è¦ç±»å‹è½¬æ¢
- âœ… å¤§å‹é¡¹ç›®æˆ–å›¢é˜Ÿåä½œ

**ç¤ºä¾‹åœºæ™¯ï¼š** æ–‡ä»¶æ“ä½œã€API è°ƒç”¨ã€æ•°æ®åº“æ“ä½œã€å¤æ‚ä¸šåŠ¡é€»è¾‘

#### ä½¿ç”¨ç›´æ¥æ„é€ å¦‚æœï¼š
- âœ… éœ€è¦å®Œå…¨æ§åˆ¶
- âœ… ç‰¹æ®Šçš„å·¥å…·å®ç°éœ€æ±‚
- âœ… åº•å±‚æ¡†æ¶å¼€å‘

**ç¤ºä¾‹åœºæ™¯ï¼š** SDK å†…éƒ¨å·¥å…·ã€ç‰¹æ®Šåè®®æ”¯æŒã€æ€§èƒ½ä¼˜åŒ–

### 6.2 è¿ç§»è·¯å¾„

```
å¼€å§‹å¼€å‘ï¼ˆå¿«é€ŸåŸå‹ï¼‰
    â†“
ä½¿ç”¨ defineTool
    â†“
éœ€è¦æ›´å¼ºç±»å‹å®‰å…¨ / å¤æ‚éªŒè¯
    â†“
è¿ç§»åˆ° tool (Zod)
    â†“
éœ€è¦ç‰¹æ®Šæ§åˆ¶
    â†“
ä½¿ç”¨ç›´æ¥æ„é€ 
```

---

## ä¸ƒã€å®æˆ˜ç¤ºä¾‹å¯¹æ¯”

### 7.1 åŒä¸€ä¸ªå·¥å…·çš„ä¸‰ç§å®ç°

#### åœºæ™¯ï¼šæ–‡ä»¶è¯»å–å·¥å…·

**æ–¹å¼ 1ï¼šdefineTool**
```typescript
const readFileTool = defineTool({
  name: 'read_file',
  description: 'è¯»å–æ–‡ä»¶å†…å®¹',
  params: {
    path: { type: 'string', description: 'æ–‡ä»¶è·¯å¾„' },
    encoding: { 
      type: 'string', 
      enum: ['utf8', 'ascii', 'base64'],
      default: 'utf8',
      required: false,
    },
  },
  async exec(args, ctx) {
    const content = await ctx.sandbox.fs.read(args.path, args.encoding);
    return { ok: true, content };
  },
});
```

**æ–¹å¼ 2ï¼štool (Zod)**
```typescript
const readFileTool = tool({
  name: 'read_file',
  description: 'è¯»å–æ–‡ä»¶å†…å®¹',
  parameters: z.object({
    path: z.string()
      .min(1, 'è·¯å¾„ä¸èƒ½ä¸ºç©º')
      .refine(p => !p.includes('..'), 'è·¯å¾„ä¸èƒ½åŒ…å« ..')
      .describe('æ–‡ä»¶è·¯å¾„'),
    encoding: z.enum(['utf8', 'ascii', 'base64'])
      .default('utf8')
      .describe('ç¼–ç æ ¼å¼'),
  }),
  async execute(args, ctx) {
    // args ç±»å‹è‡ªåŠ¨æ¨æ–­ï¼
    const content = await ctx.sandbox.fs.read(args.path, args.encoding);
    return { content };
  },
});
```

**æ–¹å¼ 3ï¼šç›´æ¥æ„é€ **
```typescript
const readFileTool: ToolInstance = {
  name: 'read_file',
  description: 'è¯»å–æ–‡ä»¶å†…å®¹',
  input_schema: {
    type: 'object',
    properties: {
      path: {
        type: 'string',
        description: 'æ–‡ä»¶è·¯å¾„',
      },
      encoding: {
        type: 'string',
        enum: ['utf8', 'ascii', 'base64'],
        default: 'utf8',
        description: 'ç¼–ç æ ¼å¼',
      },
    },
    required: ['path'],
  },
  async exec(args: any, ctx: ToolContext) {
    // æ‰‹åŠ¨éªŒè¯
    if (typeof args.path !== 'string' || args.path.length === 0) {
      return { ok: false, error: 'è·¯å¾„ä¸èƒ½ä¸ºç©º' };
    }
    if (args.path.includes('..')) {
      return { ok: false, error: 'è·¯å¾„ä¸èƒ½åŒ…å« ..' };
    }
    
    const encoding = args.encoding || 'utf8';
    const content = await ctx.sandbox.fs.read(args.path, encoding);
    return { ok: true, content };
  },
  toDescriptor() {
    return {
      source: 'registered',
      name: 'read_file',
      registryId: 'read_file',
      metadata: { access: 'read', mutates: false },
    };
  },
};
```

---

## å…«ã€æ€»ç»“

### 8.1 æ ¸å¿ƒè¦ç‚¹

1. **`defineTool` æ˜¯å°è£…å‡½æ•°ï¼Œä¸æ˜¯æ¨¡æ¿**
   - æä¾›ç®€åŒ–çš„å‚æ•°å®šä¹‰æ¥å£
   - è‡ªåŠ¨è½¬æ¢ä¸º JSON Schema
   - ä½¿ç”¨ AJV è¿›è¡Œæ ¡éªŒ

2. **`tool` ä½¿ç”¨ Zod æä¾›ç±»å‹å®‰å…¨**
   - å¼ºå¤§çš„éªŒè¯åŠŸèƒ½
   - è‡ªåŠ¨ç±»å‹æ¨æ–­
   - æ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯

3. **æ‰€æœ‰æ–¹å¼æœ€ç»ˆéƒ½ç”Ÿæˆ ToolInstance**
   - åŒ…å« `input_schema`ï¼ˆJSON Schemaï¼‰
   - åŒ…å« `exec` æ‰§è¡Œå‡½æ•°
   - åŒ…å« `toDescriptor` æè¿°å‡½æ•°

### 8.2 é€‰æ‹©å»ºè®®

```
ç®€å•å·¥å…· â†’ defineTool
   â†“
å¤æ‚å·¥å…· â†’ tool (Zod)
   â†“
ç‰¹æ®Šéœ€æ±‚ â†’ ç›´æ¥æ„é€ 
```

### 8.3 æœ€ä½³å®è·µ

- âœ… æ–°æ‰‹å…¥é—¨ä½¿ç”¨ `defineTool`
- âœ… ç”Ÿäº§ç¯å¢ƒæ¨è `tool` (Zod)
- âœ… å§‹ç»ˆæä¾›æ¸…æ™°çš„ description
- âœ… ä¸ºæšä¸¾å€¼æ·»åŠ æ³¨é‡Š
- âœ… åˆç†è®¾ç½® required å’Œ default
- âœ… ä½¿ç”¨ TypeScript ç±»å‹æ³¨è§£æé«˜ä»£ç è´¨é‡

### 8.4 ä»£ç ä½ç½®é€ŸæŸ¥

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œå· | è¯´æ˜ |
|-----|------|------|------|
| defineTool å‡½æ•° | `src/tools/define.ts` | 144-217 | ç®€åŒ–å®šä¹‰å…¥å£ |
| generateSchema | `src/tools/define.ts` | 59-98 | JSON Schema ç”Ÿæˆ |
| ParamDef æ¥å£ | `src/tools/define.ts` | 22-30 | å‚æ•°å®šä¹‰æ¥å£ |
| tool å‡½æ•° | `src/tools/tool.ts` | 54-153 | Zod Schema æ–¹å¼ |
| Zod æ ¡éªŒ | `src/tools/tool.ts` | 84-94 | å‚æ•°æ ¡éªŒé€»è¾‘ |
| Zod â†’ JSON Schema | `src/tools/tool.ts` | 69-72 | Schema è½¬æ¢ |
| ToolInstance æ¥å£ | `src/tools/registry.ts` | - | å·¥å…·å®ä¾‹æ¥å£ |

---

## ä¹ã€è°ƒè¯•æŠ€å·§

### 9.1 æŸ¥çœ‹ç”Ÿæˆçš„ Schema

```typescript
// æŸ¥çœ‹ defineTool ç”Ÿæˆçš„ Schema
const tool = defineTool({ /* ... */ });
console.log('Schema:', JSON.stringify(tool.input_schema, null, 2));

// æŸ¥çœ‹ tool (Zod) ç”Ÿæˆçš„ Schema
const zodTool = tool({ /* ... */ });
console.log('Schema:', JSON.stringify(zodTool.input_schema, null, 2));
```

### 9.2 æµ‹è¯•å‚æ•°æ ¡éªŒ

```typescript
// æ‰‹åŠ¨æµ‹è¯•æ ¡éªŒ
const testArgs = { operation: 'add', a: 1, b: 2 };
const result = await calculatorTool.exec(testArgs, ctx);
console.log('Result:', result);
```

### 9.3 å¯¹æ¯”ä¸‰ç§æ–¹å¼çš„è¾“å‡º

```typescript
// åˆ›å»ºç›¸åŒåŠŸèƒ½çš„ä¸‰ä¸ªå·¥å…·
const tool1 = defineTool({ /* ... */ });
const tool2 = tool({ /* ... */ });
const tool3 = /* ç›´æ¥æ„é€  */;

// å¯¹æ¯”å®ƒä»¬çš„ Schema
console.log('defineTool Schema:', tool1.input_schema);
console.log('tool (Zod) Schema:', tool2.input_schema);
console.log('Direct Schema:', tool3.input_schema);
```

è¿™æ ·ä½ å°±å®Œå…¨ç†è§£äº†å·¥å…·å®šä¹‰çš„æœ¬è´¨ï¼š**å®ƒä»¬éƒ½æ˜¯å‡½æ•°/æ„é€ æ–¹å¼ï¼Œä¸æ˜¯æ¨¡æ¿ï¼Œæœ€ç»ˆéƒ½ç”Ÿæˆæ ‡å‡†çš„ ToolInstance å¯¹è±¡**ï¼

