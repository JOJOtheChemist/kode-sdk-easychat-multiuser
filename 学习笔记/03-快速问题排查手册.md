# Kode-SDK å¿«é€Ÿé—®é¢˜æ’æŸ¥æ‰‹å†Œ

## ğŸš¨ å¸¸è§é—®é¢˜é€ŸæŸ¥è¡¨

### é—®é¢˜1: ä»»åŠ¡çœ‹èµ·æ¥"å¡ä½"äº†

**ç°è±¡**:
- å·¥å…·æ‰§è¡Œå®Œæˆäº†
- ä½†æ²¡æœ‰æœ€ç»ˆå›å¤
- å‰ç«¯ä¸€ç›´åœ¨ç­‰å¾…

**åŸå› **: æ²¡æœ‰ç›‘å¬ `done` äº‹ä»¶

**è§£å†³**:
```typescript
// âŒ é”™è¯¯
agent.on('tool_executed', handler);  // Monitoré€šé“ï¼Œæ— doneäº‹ä»¶

// âœ… æ­£ç¡®
for await (const envelope of agent.subscribe(['progress'])) {
  if (envelope.event.type === 'done') {
    res.end();  // â† è¿™é‡Œæ‰èƒ½ç»“æŸ
    break;
  }
}
```

**éªŒè¯**: 
```bash
npx tsx examples/03-test-event-differences.ts
# åº”è¯¥çœ‹åˆ° done äº‹ä»¶è§¦å‘
```

---

### é—®é¢˜2: é‡å¯åå¿˜è®°å†å²å¯¹è¯

**ç°è±¡**:
```
ç¬¬ä¸€æ¬¡: "æˆ‘æ˜¯å°ç¾" â†’ "ä½ å¥½å°ç¾"
[é‡å¯]
ç¬¬äºŒæ¬¡: "æˆ‘æ˜¯è°ï¼Ÿ" â†’ "æˆ‘ä¸çŸ¥é“" âŒ
```

**åŸå› **: Agent ID æ¯æ¬¡éšæœºç”Ÿæˆ

**è§£å†³**:
```typescript
// âŒ é”™è¯¯
await Agent.create({
  templateId: 'my-template',
  // ç¼ºå°‘ agentIdï¼Œæ¯æ¬¡ç”ŸæˆéšæœºID
}, deps);

// âœ… æ­£ç¡® - å›ºå®šID + Resumeæ¨¡å¼
const AGENT_ID = 'my-agent-persistent';
const exists = await deps.store.exists(AGENT_ID);

const agent = exists
  ? await Agent.resumeFromStore(AGENT_ID, deps)
  : await Agent.create({ agentId: AGENT_ID, ... }, deps);
```

**éªŒè¯**:
```bash
# 1. å‘é€æ¶ˆæ¯
curl -X POST http://localhost:2500/api/chat -d '{"message":"æˆ‘æ˜¯å°ç¾"}'

# 2. æ£€æŸ¥Store
ls .kode/
# åº”è¯¥çœ‹åˆ°å›ºå®šçš„ç›®å½•åï¼Œè€Œä¸æ˜¯éšæœºID

# 3. é‡å¯æœåŠ¡å™¨
pkill -f demo-server && npx ts-node demo-server.ts

# 4. å†æ¬¡æµ‹è¯•
curl -X POST http://localhost:2500/api/chat -d '{"message":"æˆ‘æ˜¯è°ï¼Ÿ"}'
# åº”è¯¥å›ç­” "ä½ æ˜¯å°ç¾"
```

---

### é—®é¢˜3: å‰ç«¯æ— æ³•è¿æ¥åç«¯

**ç°è±¡**:
```
[Error] Failed to load resource: æ— æ³•è¿æ¥æœåŠ¡å™¨
[Error] Fetch API cannot load http://localhost:1500
```

**åŸå› **: ç«¯å£é…ç½®ä¸åŒ¹é…

**è§£å†³**:
```bash
# 1. æ£€æŸ¥å‰ç«¯é…ç½®
grep "localhost:" public/index.html
# è¾“å‡º: http://localhost:1500  â† å‰ç«¯ç«¯å£

# 2. æ£€æŸ¥åç«¯ç«¯å£
ps aux | grep -E "(demo-server|server/index)"
curl http://localhost:2500/api/health  # æµ‹è¯•2500
curl http://localhost:1500/api/health  # æµ‹è¯•1500

# 3. ä¿®æ”¹å‰ç«¯é…ç½®åŒ¹é…åç«¯
# å¦‚æœåç«¯åœ¨2500ï¼Œä¿®æ”¹ public/index.html:
http://localhost:1500 â†’ http://localhost:2500
```

**å¿«é€Ÿä¿®å¤**:
```bash
# æ–¹æ¡ˆA: ä¿®æ”¹å‰ç«¯ï¼ˆæ¨èï¼‰
sed -i '' 's/localhost:1500/localhost:2500/g' public/index.html

# æ–¹æ¡ˆB: ä¿®æ”¹åç«¯ç«¯å£
# åœ¨ demo-server.ts ä¸­:
const PORT = 1500;  // æ”¹ä¸º1500
```

---

### é—®é¢˜4: å·¥å…·è°ƒç”¨åæ²¡æœ‰ç»§ç»­å¤„ç†

**ç°è±¡**:
- å·¥å…·æ‰§è¡ŒæˆåŠŸ
- `tool:end` è§¦å‘
- ä½†æ¨¡å‹æ²¡æœ‰åŸºäºç»“æœç»§ç»­

**åŸå› **: `setImmediate` bugï¼ˆå·²åœ¨v2.7+ä¿®å¤ï¼‰

**æ£€æŸ¥æ˜¯å¦å·²ä¿®å¤**:
```typescript
// src/core/agent.ts ç¬¬960è¡Œå·¦å³
// âœ… åº”è¯¥æ˜¯è¿™æ ·:
setImmediate(() => this.ensureProcessing());

// âŒ å¦‚æœæ˜¯è¿™æ ·åˆ™æœªä¿®å¤:
this.ensureProcessing();
```

**æµ‹è¯•**:
```bash
npx tsx examples/test-tool-continue.ts
# åº”è¯¥çœ‹åˆ°å·¥å…·æ‰§è¡Œåè‡ªåŠ¨ç»§ç»­ï¼Œå¹¶æ”¶åˆ°doneäº‹ä»¶
```

---

### é—®é¢˜5: CORS é”™è¯¯

**ç°è±¡**:
```
Access-Control-Allow-Origin error
```

**è§£å†³**:
```typescript
// demo-server.ts æˆ– server/index.ts
import cors from 'cors';

app.use(cors());  // â† å¿…é¡»åœ¨è·¯ç”±ä¹‹å‰
```

---

## ğŸ”§ è°ƒè¯•å·¥å…·ç®±

### 1. å¿«é€Ÿæ£€æŸ¥AgentçŠ¶æ€
```typescript
const status = await agent.status();
console.log({
  state: status.state,              // READY/WORKING/PAUSED
  step: status.stepCount,           // å·²æ‰§è¡Œæ­¥æ•°
  messages: status.lastSfpIndex + 1,// æ¶ˆæ¯æ•°é‡
  bookmark: status.lastBookmark,    // æœ€æ–°bookmark
});
```

### 2. æŸ¥çœ‹æ¶ˆæ¯å†å²
```typescript
console.log('æ¶ˆæ¯å†å²:', (agent as any).messages);
```

### 3. ç›‘æ§æ‰€æœ‰äº‹ä»¶
```typescript
for await (const envelope of agent.subscribe(['progress', 'control', 'monitor'])) {
  console.log(
    `[${envelope.event.channel}] ${envelope.event.type}`,
    envelope.event
  );
}
```

### 4. æŸ¥çœ‹Storeå†…å®¹
```bash
# åˆ—å‡ºæ‰€æœ‰Agent
ls -la .kode/

# æŸ¥çœ‹æ¶ˆæ¯å†å²
cat .kode/demo-agent-persistent/messages.jsonl | jq .

# æŸ¥çœ‹å…ƒæ•°æ®
cat .kode/demo-agent-persistent/metadata.json | jq .
```

---

## âœ… å¥åº·æ£€æŸ¥æ¸…å•

è¿è¡Œä»¥ä¸‹å‘½ä»¤ç¡®è®¤ç³»ç»Ÿæ­£å¸¸ï¼š

```bash
# 1. åç«¯å¥åº·æ£€æŸ¥
curl http://localhost:2500/api/health
# âœ… åº”è¿”å›: {"status":"ok","model":"glm-4.5-air"}

# 2. æ£€æŸ¥Agent Store
ls .kode/ | grep -v "agt:"
# âœ… åº”çœ‹åˆ°å›ºå®šçš„Agentç›®å½•å

# 3. æµ‹è¯•å¯¹è¯æµç¨‹
curl -X POST http://localhost:2500/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"æµ‹è¯•æ¶ˆæ¯"}' | grep "event: complete"
# âœ… åº”çœ‹åˆ° complete äº‹ä»¶

# 4. å‰ç«¯è®¿é—®æµ‹è¯•
open http://localhost:2500
# âœ… æµè§ˆå™¨èƒ½æ‰“å¼€ï¼Œæ— CORSé”™è¯¯
```

---

## ğŸ“‹ é…ç½®æ£€æŸ¥è¡¨

### demo-server.ts å¿…å¤‡é…ç½®

```typescript
// âœ… 1. å›ºå®šAgent ID
const AGENT_ID = 'demo-agent-persistent';

// âœ… 2. Resume or Create
const exists = await deps.store.exists(AGENT_ID);
const agent = exists 
  ? await Agent.resumeFromStore(AGENT_ID, deps)
  : await Agent.create({ agentId: AGENT_ID, ... }, deps);

// âœ… 3. Progressäº‹ä»¶æµç›‘å¬
for await (const envelope of agent.subscribe(['progress'])) {
  switch (envelope.event.type) {
    case 'tool:start': /* ... */ break;
    case 'tool:end': /* ... */ break;
    case 'done':
      res.end();  // â† å…³é”®ï¼
      return;
  }
}

// âœ… 4. CORSé…ç½®
app.use(cors());

// âœ… 5. ç«¯å£é…ç½®
const PORT = 2500;  // ä¸å‰ç«¯ä¸€è‡´
```

### public/index.html å¿…å¤‡é…ç½®

```javascript
// âœ… 1. APIç«¯ç‚¹é…ç½®
const API_URL = 'http://localhost:2500';  // ä¸åç«¯ç«¯å£ä¸€è‡´

// âœ… 2. SSEäº‹ä»¶å¤„ç†
eventSource.addEventListener('text', handler);
eventSource.addEventListener('tool_start', handler);
eventSource.addEventListener('complete', handler);  // â† doneäº‹ä»¶çš„å‰ç«¯æ˜ å°„
```

---

## ğŸš€ ä¸€é”®å¯åŠ¨è„šæœ¬

åˆ›å»º `start-demo.sh`:

```bash
#!/bin/bash

echo "ğŸš€ å¯åŠ¨ Kode-SDK Demo"

# æ£€æŸ¥ç¯å¢ƒ
if [ ! -f .env ]; then
  echo "âŒ .env æ–‡ä»¶ä¸å­˜åœ¨"
  exit 1
fi

# å¯åŠ¨åç«¯
echo "ğŸ“¡ å¯åŠ¨åç«¯æœåŠ¡..."
npx ts-node demo-server.ts &
BACKEND_PID=$!

# ç­‰å¾…å¯åŠ¨
sleep 3

# å¥åº·æ£€æŸ¥
echo "ğŸ” å¥åº·æ£€æŸ¥..."
if curl -s http://localhost:2500/api/health | grep -q "ok"; then
  echo "âœ… åç«¯æ­£å¸¸è¿è¡Œ (PID: $BACKEND_PID)"
  echo "ğŸŒ æ‰“å¼€æµè§ˆå™¨: http://localhost:2500"
  
  # macOSè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨
  open http://localhost:2500
else
  echo "âŒ åç«¯å¯åŠ¨å¤±è´¥"
  kill $BACKEND_PID
  exit 1
fi
```

ä½¿ç”¨æ–¹æ³•:
```bash
chmod +x start-demo.sh
./start-demo.sh
```

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

1. **æŸ¥çœ‹å®Œæ•´æ–‡æ¡£**: `å­¦ä¹ ç¬”è®°/03-Progressäº‹ä»¶æµä¸å†å²æŒä¹…åŒ–å®Œæ•´æŒ‡å—.md`

2. **è¿è¡Œæµ‹è¯•**:
   ```bash
   npx tsx examples/03-test-event-differences.ts
   ```

3. **æŸ¥çœ‹æ—¥å¿—**:
   ```bash
   tail -f demo-server.log
   ```

4. **é‡ç½®Agent** (æ¸…é™¤å†å²):
   ```bash
   rm -rf .kode/demo-agent-persistent/
   ```

---

**æœ€åæ›´æ–°**: 2024-10-16  
**é€‚ç”¨ç‰ˆæœ¬**: Kode-SDK v2.7+

