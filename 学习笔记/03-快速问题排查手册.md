# Kode-SDK 快速问题排查手册

## 🚨 常见问题速查表

### 问题1: 任务看起来"卡住"了

**现象**:
- 工具执行完成了
- 但没有最终回复
- 前端一直在等待

**原因**: 没有监听 `done` 事件

**解决**:
```typescript
// ❌ 错误
agent.on('tool_executed', handler);  // Monitor通道，无done事件

// ✅ 正确
for await (const envelope of agent.subscribe(['progress'])) {
  if (envelope.event.type === 'done') {
    res.end();  // ← 这里才能结束
    break;
  }
}
```

**验证**: 
```bash
npx tsx examples/03-test-event-differences.ts
# 应该看到 done 事件触发
```

---

### 问题2: 重启后忘记历史对话

**现象**:
```
第一次: "我是小美" → "你好小美"
[重启]
第二次: "我是谁？" → "我不知道" ❌
```

**原因**: Agent ID 每次随机生成

**解决**:
```typescript
// ❌ 错误
await Agent.create({
  templateId: 'my-template',
  // 缺少 agentId，每次生成随机ID
}, deps);

// ✅ 正确 - 固定ID + Resume模式
const AGENT_ID = 'my-agent-persistent';
const exists = await deps.store.exists(AGENT_ID);

const agent = exists
  ? await Agent.resumeFromStore(AGENT_ID, deps)
  : await Agent.create({ agentId: AGENT_ID, ... }, deps);
```

**验证**:
```bash
# 1. 发送消息
curl -X POST http://localhost:2500/api/chat -d '{"message":"我是小美"}'

# 2. 检查Store
ls .kode/
# 应该看到固定的目录名，而不是随机ID

# 3. 重启服务器
pkill -f demo-server && npx ts-node demo-server.ts

# 4. 再次测试
curl -X POST http://localhost:2500/api/chat -d '{"message":"我是谁？"}'
# 应该回答 "你是小美"
```

---

### 问题3: 前端无法连接后端

**现象**:
```
[Error] Failed to load resource: 无法连接服务器
[Error] Fetch API cannot load http://localhost:1500
```

**原因**: 端口配置不匹配

**解决**:
```bash
# 1. 检查前端配置
grep "localhost:" public/index.html
# 输出: http://localhost:1500  ← 前端端口

# 2. 检查后端端口
ps aux | grep -E "(demo-server|server/index)"
curl http://localhost:2500/api/health  # 测试2500
curl http://localhost:1500/api/health  # 测试1500

# 3. 修改前端配置匹配后端
# 如果后端在2500，修改 public/index.html:
http://localhost:1500 → http://localhost:2500
```

**快速修复**:
```bash
# 方案A: 修改前端（推荐）
sed -i '' 's/localhost:1500/localhost:2500/g' public/index.html

# 方案B: 修改后端端口
# 在 demo-server.ts 中:
const PORT = 1500;  // 改为1500
```

---

### 问题4: 工具调用后没有继续处理

**现象**:
- 工具执行成功
- `tool:end` 触发
- 但模型没有基于结果继续

**原因**: `setImmediate` bug（已在v2.7+修复）

**检查是否已修复**:
```typescript
// src/core/agent.ts 第960行左右
// ✅ 应该是这样:
setImmediate(() => this.ensureProcessing());

// ❌ 如果是这样则未修复:
this.ensureProcessing();
```

**测试**:
```bash
npx tsx examples/test-tool-continue.ts
# 应该看到工具执行后自动继续，并收到done事件
```

---

### 问题5: CORS 错误

**现象**:
```
Access-Control-Allow-Origin error
```

**解决**:
```typescript
// demo-server.ts 或 server/index.ts
import cors from 'cors';

app.use(cors());  // ← 必须在路由之前
```

---

## 🔧 调试工具箱

### 1. 快速检查Agent状态
```typescript
const status = await agent.status();
console.log({
  state: status.state,              // READY/WORKING/PAUSED
  step: status.stepCount,           // 已执行步数
  messages: status.lastSfpIndex + 1,// 消息数量
  bookmark: status.lastBookmark,    // 最新bookmark
});
```

### 2. 查看消息历史
```typescript
console.log('消息历史:', (agent as any).messages);
```

### 3. 监控所有事件
```typescript
for await (const envelope of agent.subscribe(['progress', 'control', 'monitor'])) {
  console.log(
    `[${envelope.event.channel}] ${envelope.event.type}`,
    envelope.event
  );
}
```

### 4. 查看Store内容
```bash
# 列出所有Agent
ls -la .kode/

# 查看消息历史
cat .kode/demo-agent-persistent/messages.jsonl | jq .

# 查看元数据
cat .kode/demo-agent-persistent/metadata.json | jq .
```

---

## ✅ 健康检查清单

运行以下命令确认系统正常：

```bash
# 1. 后端健康检查
curl http://localhost:2500/api/health
# ✅ 应返回: {"status":"ok","model":"glm-4.5-air"}

# 2. 检查Agent Store
ls .kode/ | grep -v "agt:"
# ✅ 应看到固定的Agent目录名

# 3. 测试对话流程
curl -X POST http://localhost:2500/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"测试消息"}' | grep "event: complete"
# ✅ 应看到 complete 事件

# 4. 前端访问测试
open http://localhost:2500
# ✅ 浏览器能打开，无CORS错误
```

---

## 📋 配置检查表

### demo-server.ts 必备配置

```typescript
// ✅ 1. 固定Agent ID
const AGENT_ID = 'demo-agent-persistent';

// ✅ 2. Resume or Create
const exists = await deps.store.exists(AGENT_ID);
const agent = exists 
  ? await Agent.resumeFromStore(AGENT_ID, deps)
  : await Agent.create({ agentId: AGENT_ID, ... }, deps);

// ✅ 3. Progress事件流监听
for await (const envelope of agent.subscribe(['progress'])) {
  switch (envelope.event.type) {
    case 'tool:start': /* ... */ break;
    case 'tool:end': /* ... */ break;
    case 'done':
      res.end();  // ← 关键！
      return;
  }
}

// ✅ 4. CORS配置
app.use(cors());

// ✅ 5. 端口配置
const PORT = 2500;  // 与前端一致
```

### public/index.html 必备配置

```javascript
// ✅ 1. API端点配置
const API_URL = 'http://localhost:2500';  // 与后端端口一致

// ✅ 2. SSE事件处理
eventSource.addEventListener('text', handler);
eventSource.addEventListener('tool_start', handler);
eventSource.addEventListener('complete', handler);  // ← done事件的前端映射
```

---

## 🚀 一键启动脚本

创建 `start-demo.sh`:

```bash
#!/bin/bash

echo "🚀 启动 Kode-SDK Demo"

# 检查环境
if [ ! -f .env ]; then
  echo "❌ .env 文件不存在"
  exit 1
fi

# 启动后端
echo "📡 启动后端服务..."
npx ts-node demo-server.ts &
BACKEND_PID=$!

# 等待启动
sleep 3

# 健康检查
echo "🔍 健康检查..."
if curl -s http://localhost:2500/api/health | grep -q "ok"; then
  echo "✅ 后端正常运行 (PID: $BACKEND_PID)"
  echo "🌐 打开浏览器: http://localhost:2500"
  
  # macOS自动打开浏览器
  open http://localhost:2500
else
  echo "❌ 后端启动失败"
  kill $BACKEND_PID
  exit 1
fi
```

使用方法:
```bash
chmod +x start-demo.sh
./start-demo.sh
```

---

## 📞 需要帮助？

1. **查看完整文档**: `学习笔记/03-Progress事件流与历史持久化完整指南.md`

2. **运行测试**:
   ```bash
   npx tsx examples/03-test-event-differences.ts
   ```

3. **查看日志**:
   ```bash
   tail -f demo-server.log
   ```

4. **重置Agent** (清除历史):
   ```bash
   rm -rf .kode/demo-agent-persistent/
   ```

---

**最后更新**: 2024-10-16  
**适用版本**: Kode-SDK v2.7+

