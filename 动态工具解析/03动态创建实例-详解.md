# åŠ¨æ€åˆ›å»ºå®ä¾‹ - è¯¦ç»†è§£é‡Š

## 1. ä»€ä¹ˆæ˜¯åŠ¨æ€åˆ›å»ºå®ä¾‹ï¼Ÿ

**åŠ¨æ€åˆ›å»ºå®ä¾‹** = æ ¹æ®ä¸åŒçš„å‚æ•°/é…ç½®ï¼Œåˆ›å»ºå…·æœ‰ä¸åŒè¡Œä¸ºçš„å·¥å…·å®ä¾‹

å¯¹æ¯”ï¼š
- **é™æ€å®ä¾‹**ï¼šä¸€ä¸ªæ¨¡å…·ï¼Œé€ å‡ºçš„æ‰€æœ‰äº§å“éƒ½ä¸€æ ·
- **åŠ¨æ€å®ä¾‹**ï¼šä¸€ä¸ªå¯è°ƒèŠ‚çš„æ¨¡å…·ï¼Œæ ¹æ®è®¾ç½®é€ å‡ºä¸åŒçš„äº§å“

---

## 2. å®é™…åœºæ™¯ç¤ºä¾‹

### åœºæ™¯ 1: é¤å…ç‚¹é¤ç³»ç»Ÿ ğŸ•

#### é™æ€å®ä¾‹ï¼ˆtool()ï¼‰

```typescript
// åªæœ‰ä¸€ä¸ªæŠ«è¨åˆ¶ä½œå™¨ï¼Œé…ç½®å›ºå®š
const pizzaMaker = tool({
  name: 'make_pizza',
  description: 'Make a Margherita pizza',
  parameters: z.object({
    size: z.enum(['small', 'medium', 'large']),
  }),
  async execute(args) {
    // å›ºå®šé…ç½®ï¼šåªèƒ½åš Margherita æŠ«è¨
    return {
      type: 'Margherita',  // å›ºå®š
      toppings: ['tomato', 'mozzarella', 'basil'],  // å›ºå®š
      size: args.size,
    };
  },
});

// é—®é¢˜ï¼šå¦‚æœè¦åšå…¶ä»–ç±»å‹çš„æŠ«è¨æ€ä¹ˆåŠï¼Ÿ
// ç­”ï¼šä¸è¡Œï¼Œé…ç½®æ˜¯å›ºå®šçš„
```

#### åŠ¨æ€å®ä¾‹ï¼ˆdefineTool()ï¼‰

```typescript
// å¯é…ç½®çš„æŠ«è¨åˆ¶ä½œå™¨
const createPizzaMaker = (config: { 
  type: string; 
  toppings: string[]; 
}) => {
  return defineTool({
    name: 'make_pizza',
    description: `Make a ${config.type} pizza`,
    params: {
      size: { type: 'string', enum: ['small', 'medium', 'large'] },
    },
    async exec(args) {
      return {
        type: config.type,      // æ ¹æ®é…ç½®åŠ¨æ€å†³å®š
        toppings: config.toppings,  // æ ¹æ®é…ç½®åŠ¨æ€å†³å®š
        size: args.size,
      };
    },
  });
};

// ä½¿ç”¨ï¼šæ ¹æ®ä¸åŒé…ç½®åˆ›å»ºä¸åŒå®ä¾‹
const margheritaMaker = createPizzaMaker({
  type: 'Margherita',
  toppings: ['tomato', 'mozzarella', 'basil'],
});

const pepperoniMaker = createPizzaMaker({
  type: 'Pepperoni',
  toppings: ['tomato', 'mozzarella', 'pepperoni'],
});

// ä¸¤ä¸ªåˆ¶ä½œå™¨ï¼Œè¡Œä¸ºä¸åŒï¼
```

---

### åœºæ™¯ 2: å¤šè¯­è¨€ç¿»è¯‘å·¥å…· ğŸŒ

#### é™æ€å®ä¾‹

```typescript
// å›ºå®šç¿»è¯‘æˆè‹±è¯­
const translator = tool({
  name: 'translate',
  description: 'Translate to English',
  parameters: z.object({
    text: z.string(),
  }),
  async execute(args) {
    return await translateAPI(args.text, 'en');  // ç›®æ ‡è¯­è¨€å›ºå®š
  },
});
```

#### åŠ¨æ€å®ä¾‹

```typescript
// å¯é…ç½®ç›®æ ‡è¯­è¨€
const createTranslator = (targetLanguage: string) => {
  return defineTool({
    name: `translate_to_${targetLanguage}`,
    description: `Translate to ${targetLanguage}`,
    params: {
      text: { type: 'string' },
    },
    async exec(args) {
      return await translateAPI(args.text, targetLanguage);  // åŠ¨æ€è¯­è¨€
    },
  });
};

// åˆ›å»ºå¤šä¸ªä¸åŒçš„ç¿»è¯‘å™¨
const englishTranslator = createTranslator('en');
const chineseTranslator = createTranslator('zh');
const japaneseTranslator = createTranslator('ja');

// æ¯ä¸ªç¿»è¯‘å™¨çš„è¡Œä¸ºä¸åŒ
```

---

### åœºæ™¯ 3: çœŸå®æ¡ˆä¾‹ - task_run å·¥å…· ğŸ¯

è¿™æ˜¯ Kode SDK ä¸­çš„çœŸå®æ¡ˆä¾‹ï¼š

#### ä¸šåŠ¡éœ€æ±‚

Agent éœ€è¦æŠŠå¤æ‚ä»»åŠ¡å§”æ‰˜ç»™å­ Agentï¼Œä½†ä¸åŒçš„å­ Agent æœ‰ä¸åŒçš„èƒ½åŠ›ï¼š

- **ä»£ç ä¸“å®¶ Agent**: åªèƒ½ç”¨æ–‡ä»¶æ“ä½œå·¥å…·
- **æ•°æ®åˆ†æ Agent**: åªèƒ½ç”¨æ•°æ®åº“å’Œå¯è§†åŒ–å·¥å…·
- **å…¨èƒ½ Agent**: å¯ä»¥ç”¨æ‰€æœ‰å·¥å…·

#### é—®é¢˜

å¦‚æœç”¨é™æ€å®ä¾‹ï¼Œ`task_run` å·¥å…·åªèƒ½åˆ›å»ºä¸€ç§ç±»å‹çš„å­ Agentã€‚

#### è§£å†³æ–¹æ¡ˆï¼šåŠ¨æ€åˆ›å»º

```typescript
// src/tools/task_run/index.ts (ç®€åŒ–ç‰ˆ)

// å®šä¹‰ä¸åŒçš„ Agent æ¨¡æ¿
interface AgentTemplate {
  id: string;
  tools: string[];  // è¿™ä¸ª Agent å¯ä»¥ç”¨å“ªäº›å·¥å…·
  whenToUse: string;
}

// åˆ›å»º task_run å·¥å…·çš„å·¥å‚å‡½æ•°
export function createTaskRunTool(templates: AgentTemplate[]) {
  
  // æ ¹æ® templates ç”Ÿæˆä¸åŒçš„ prompt
  const prompt = generatePrompt(templates);
  
  return tool({
    name: 'task_run',
    description: 'Delegate task to sub-agent',
    parameters: z.object({
      description: z.string(),
      prompt: z.string(),
      agentTemplateId: z.string(),  // é€‰æ‹©å“ªä¸ªæ¨¡æ¿
    }),
    async execute(args, ctx) {
      // æ ¹æ® agentTemplateId æ‰¾åˆ°å¯¹åº”çš„æ¨¡æ¿
      const template = templates.find(t => t.id === args.agentTemplateId);
      
      if (!template) {
        throw new Error(`Template ${args.agentTemplateId} not found`);
      }
      
      // ä½¿ç”¨è¿™ä¸ªæ¨¡æ¿çš„å·¥å…·é›†åˆ›å»ºå­ Agent
      return await ctx.agent.delegateTask({
        templateId: template.id,
        prompt: args.prompt,
        tools: template.tools,  // ä¸åŒæ¨¡æ¿ï¼Œä¸åŒå·¥å…·ï¼
      });
    },
  });
  
  // å·¥å…·çš„ prompt ä¹Ÿæ˜¯åŠ¨æ€çš„
  (tool as any).prompt = prompt;
  return tool;
}

// ä½¿ç”¨åœºæ™¯ 1: ä»£ç é¡¹ç›®
const codeProjectTemplates = [
  {
    id: 'code-expert',
    tools: ['fs_read', 'fs_write', 'fs_edit', 'grep'],
    whenToUse: 'For code editing tasks',
  },
  {
    id: 'test-expert',
    tools: ['fs_read', 'fs_write', 'run_tests'],
    whenToUse: 'For testing tasks',
  },
];

const taskRunForCode = createTaskRunTool(codeProjectTemplates);

// ä½¿ç”¨åœºæ™¯ 2: æ•°æ®åˆ†æé¡¹ç›®
const dataProjectTemplates = [
  {
    id: 'data-analyst',
    tools: ['sql_query', 'data_viz', 'stats'],
    whenToUse: 'For data analysis tasks',
  },
  {
    id: 'ml-expert',
    tools: ['train_model', 'predict', 'evaluate'],
    whenToUse: 'For machine learning tasks',
  },
];

const taskRunForData = createTaskRunTool(dataProjectTemplates);

// ä¸¤ä¸ª task_run å·¥å…·ï¼Œè¡Œä¸ºå®Œå…¨ä¸åŒï¼
```

#### å®é™…ä½¿ç”¨

```typescript
// Agent 1: ä»£ç é¡¹ç›®
const codeAgent = new Agent({
  tools: ['task_run', 'fs_read', 'fs_write'],
  // task_run åªèƒ½åˆ›å»º code-expert æˆ– test-expert
});

await codeAgent.run('å¸®æˆ‘é‡æ„è¿™ä¸ªé¡¹ç›®');
// Agent å†…éƒ¨è°ƒç”¨ï¼š
// task_run({ 
//   agentTemplateId: 'code-expert',  // åªèƒ½é€‰è¿™ä¸¤ä¸ªä¹‹ä¸€
//   prompt: 'é‡æ„ user.ts æ–‡ä»¶' 
// })

// Agent 2: æ•°æ®é¡¹ç›®
const dataAgent = new Agent({
  tools: ['task_run', 'sql_query'],
  // task_run åªèƒ½åˆ›å»º data-analyst æˆ– ml-expert
});

await dataAgent.run('åˆ†æè¿™ä»½æ•°æ®');
// Agent å†…éƒ¨è°ƒç”¨ï¼š
// task_run({ 
//   agentTemplateId: 'data-analyst',  // åªèƒ½é€‰è¿™ä¸¤ä¸ªä¹‹ä¸€
//   prompt: 'åˆ†æç”¨æˆ·è¡Œä¸ºæ•°æ®' 
// })
```

---

## 3. ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€åˆ›å»ºï¼Ÿ

### é—®é¢˜ï¼šé™æ€å®ä¾‹çš„å±€é™

```typescript
// å¦‚æœç”¨é™æ€å®ä¾‹
const taskRun = tool({
  name: 'task_run',
  // é—®é¢˜ï¼štemplates æ˜¯å›ºå®šçš„ï¼Œæ— æ³•æ ¹æ®ä¸åŒé¡¹ç›®è°ƒæ•´
  templates: [/* å›ºå®šé…ç½® */],
  // ...
});

// æ‰€æœ‰ Agent éƒ½ç”¨åŒä¸€ä¸ªé…ç½®
const agent1 = new Agent({ tools: ['task_run'] });  // è¢«è¿«ç”¨å›ºå®šé…ç½®
const agent2 = new Agent({ tools: ['task_run'] });  // è¢«è¿«ç”¨å›ºå®šé…ç½®
```

### è§£å†³ï¼šåŠ¨æ€åˆ›å»ºå®ä¾‹

```typescript
// ä¸åŒé¡¹ç›®åˆ›å»ºä¸åŒé…ç½®çš„ task_run
const taskRunForCode = createTaskRunTool(codeTemplates);
const taskRunForData = createTaskRunTool(dataTemplates);

// ä¸åŒ Agent ç”¨ä¸åŒçš„ task_run
const agent1 = new Agent({ tools: [taskRunForCode] });  // ä»£ç ä¸“ç”¨é…ç½®
const agent2 = new Agent({ tools: [taskRunForData] });  // æ•°æ®ä¸“ç”¨é…ç½®
```

---

## 4. åŠ¨æ€åˆ›å»ºçš„å®ç°åŸç†

### defineTool() çš„å·¥å‚æ¨¡å¼

```typescript
// defineTool() æ³¨å†Œæ—¶
globalToolRegistry.register('tool_name', (config) => {
  // å·¥å‚å‡½æ•°ï¼šæ ¹æ® config åŠ¨æ€åˆ›å»º
  return defineTool(def, { autoRegister: false });
});

// ä½¿ç”¨æ—¶ä¼ å…¥ä¸åŒçš„ config
const tool1 = registry.create('tool_name', { mode: 'simple' });
const tool2 = registry.create('tool_name', { mode: 'advanced' });
// æ¯æ¬¡éƒ½æ˜¯æ–°å®ä¾‹ï¼Œå¯ä»¥æœ‰ä¸åŒçš„è¡Œä¸º
```

### tool() æ— æ³•åŠ¨æ€åˆ›å»º

```typescript
// tool() æ³¨å†Œæ—¶
const toolInstance = { /* å›ºå®šé…ç½® */ };
globalToolRegistry.register('tool_name', () => toolInstance);

// ä½¿ç”¨æ—¶æ— æ³•æ”¹å˜é…ç½®
const tool1 = registry.create('tool_name', { mode: 'simple' });   // config è¢«å¿½ç•¥
const tool2 = registry.create('tool_name', { mode: 'advanced' }); // config è¢«å¿½ç•¥
// æ°¸è¿œè¿”å›åŒä¸€ä¸ªå®ä¾‹ï¼Œé…ç½®å›ºå®š
```

---

## 5. å®Œæ•´å¯¹æ¯”ç¤ºä¾‹

### åœºæ™¯ï¼šæ•°æ®åº“è¿æ¥å·¥å…·

#### éœ€æ±‚

ä¸åŒç¯å¢ƒéœ€è¦è¿æ¥ä¸åŒçš„æ•°æ®åº“ï¼š
- å¼€å‘ç¯å¢ƒï¼šè¿æ¥æœ¬åœ° MySQL
- æµ‹è¯•ç¯å¢ƒï¼šè¿æ¥æµ‹è¯• PostgreSQL  
- ç”Ÿäº§ç¯å¢ƒï¼šè¿æ¥ç”Ÿäº§ PostgreSQL

#### é™æ€å®ä¾‹ï¼ˆä¸çµæ´»ï¼‰

```typescript
const dbQuery = tool({
  name: 'db_query',
  description: 'Query database',
  parameters: z.object({
    sql: z.string(),
  }),
  async execute(args) {
    // é—®é¢˜ï¼šæ•°æ®åº“é…ç½®å†™æ­»äº†
    const connection = await mysql.connect({
      host: 'localhost',
      database: 'dev_db',
    });
    return await connection.query(args.sql);
  },
});

// æ‰€æœ‰ç¯å¢ƒéƒ½è¿æ¥ dev_dbï¼Œæ— æ³•æ”¹å˜
```

#### åŠ¨æ€å®ä¾‹ï¼ˆçµæ´»ï¼‰

```typescript
// å·¥å…·å·¥å‚å‡½æ•°
function createDbQueryTool(dbConfig: {
  type: 'mysql' | 'postgres';
  host: string;
  database: string;
}) {
  return defineTool({
    name: 'db_query',
    description: `Query ${dbConfig.type} database: ${dbConfig.database}`,
    params: {
      sql: { type: 'string' },
    },
    async exec(args) {
      // æ ¹æ®é…ç½®è¿æ¥ä¸åŒçš„æ•°æ®åº“
      const connection = await (dbConfig.type === 'mysql'
        ? mysql.connect(dbConfig)
        : postgres.connect(dbConfig)
      );
      return await connection.query(args.sql);
    },
  });
}

// ä¸åŒç¯å¢ƒåˆ›å»ºä¸åŒçš„å·¥å…·å®ä¾‹
const devDbQuery = createDbQueryTool({
  type: 'mysql',
  host: 'localhost',
  database: 'dev_db',
});

const testDbQuery = createDbQueryTool({
  type: 'postgres',
  host: 'test.example.com',
  database: 'test_db',
});

const prodDbQuery = createDbQueryTool({
  type: 'postgres',
  host: 'prod.example.com',
  database: 'prod_db',
});

// ä½¿ç”¨
const devAgent = new Agent({ tools: [devDbQuery] });    // è¿æ¥å¼€å‘æ•°æ®åº“
const testAgent = new Agent({ tools: [testDbQuery] });  // è¿æ¥æµ‹è¯•æ•°æ®åº“
const prodAgent = new Agent({ tools: [prodDbQuery] });  // è¿æ¥ç”Ÿäº§æ•°æ®åº“
```

---

## 6. æ ¸å¿ƒæ¦‚å¿µæ€»ç»“

### é™æ€å®ä¾‹ = å›ºå®šé…ç½®

```
åˆ›å»º â†’ [å›ºå®šå®ä¾‹] â†’ ä½¿ç”¨
         â†“
      é…ç½® A
      
æ‰€æœ‰ä½¿ç”¨æ–¹éƒ½ç”¨é…ç½® A
```

### åŠ¨æ€å®ä¾‹ = å¯å˜é…ç½®

```
åˆ›å»º â†’ [å·¥å‚å‡½æ•°] â†’ ä½¿ç”¨æ—¶ä¼ å…¥é…ç½® A â†’ [å®ä¾‹ A]
         â†“
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ä½¿ç”¨æ—¶ä¼ å…¥é…ç½® B â†’ [å®ä¾‹ B]
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ä½¿ç”¨æ—¶ä¼ å…¥é…ç½® C â†’ [å®ä¾‹ C]
         
ä¸åŒé…ç½®ï¼Œä¸åŒå®ä¾‹ï¼Œä¸åŒè¡Œä¸º
```

---

## 7. ä½•æ—¶éœ€è¦åŠ¨æ€åˆ›å»ºï¼Ÿ

### âœ… éœ€è¦åŠ¨æ€åˆ›å»ºçš„åœºæ™¯

1. **å¤šç¯å¢ƒéƒ¨ç½²**ï¼šå¼€å‘/æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒé…ç½®ä¸åŒ
2. **å¤šç§Ÿæˆ·ç³»ç»Ÿ**ï¼šä¸åŒç”¨æˆ·/ç»„ç»‡æœ‰ä¸åŒé…ç½®
3. **å¯æ’æ‹”æ¶æ„**ï¼šæ ¹æ®é¡¹ç›®ç±»å‹åŠ è½½ä¸åŒå·¥å…·é›†
4. **A/B æµ‹è¯•**ï¼šåŒä¸€å·¥å…·ä¸åŒç‰ˆæœ¬/ç­–ç•¥
5. **æƒé™æ§åˆ¶**ï¼šä¸åŒè§’è‰²çœ‹åˆ°ä¸åŒçš„å·¥å…·è¡Œä¸º

### âŒ ä¸éœ€è¦åŠ¨æ€åˆ›å»ºçš„åœºæ™¯

1. **ç®€å•å·¥å…·**ï¼šé…ç½®å›ºå®šï¼Œä¸ä¼šæ”¹å˜
2. **å•ä¸€ç”¨é€”**ï¼šåªæœ‰ä¸€ç§ä½¿ç”¨æ–¹å¼
3. **æ— çŠ¶æ€å·¥å…·**ï¼šä¸ä¾èµ–å¤–éƒ¨é…ç½®

---

## 8. å®é™…ä»£ç å¯¹æ¯”

### tool() - é™æ€é…ç½®

```typescript
// æ–‡ä»¶ç³»ç»Ÿå·¥å…· - é…ç½®å›ºå®š
export const FsRead = tool({
  name: 'fs_read',
  description: 'Read file',
  parameters: z.object({
    path: z.string(),
  }),
  async execute(args, ctx) {
    // é…ç½®å›ºå®šï¼šæ€»æ˜¯ä» sandbox è¯»å–
    return await ctx.sandbox.fs.read(args.path);
  },
});

// æ‰€æœ‰ Agent éƒ½ç”¨åŒæ ·çš„æ–¹å¼è¯»æ–‡ä»¶
```

### defineTool() - åŠ¨æ€é…ç½®

```typescript
// API è°ƒç”¨å·¥å…· - é…ç½®åŠ¨æ€
function createApiTool(apiConfig: {
  baseURL: string;
  apiKey: string;
  timeout: number;
}) {
  return defineTool({
    name: 'api_call',
    description: `Call API at ${apiConfig.baseURL}`,
    params: {
      endpoint: { type: 'string' },
      method: { type: 'string' },
      body: { type: 'object', required: false },
    },
    async exec(args) {
      // æ ¹æ®é…ç½®è°ƒç”¨ä¸åŒçš„ API
      return await fetch(`${apiConfig.baseURL}${args.endpoint}`, {
        method: args.method,
        headers: {
          'Authorization': `Bearer ${apiConfig.apiKey}`,
        },
        timeout: apiConfig.timeout,
        body: args.body ? JSON.stringify(args.body) : undefined,
      });
    },
  });
}

// ä¸åŒçš„ API æœåŠ¡
const githubAPI = createApiTool({
  baseURL: 'https://api.github.com',
  apiKey: process.env.GITHUB_TOKEN,
  timeout: 5000,
});

const stripeAPI = createApiTool({
  baseURL: 'https://api.stripe.com',
  apiKey: process.env.STRIPE_KEY,
  timeout: 10000,
});

// ä¸åŒ Agent è°ƒç”¨ä¸åŒçš„ API
```

---

## æ€»ç»“

**åŠ¨æ€åˆ›å»ºå®ä¾‹** = æ ¹æ®ä¸åŒå‚æ•°/é…ç½®åˆ›å»ºå…·æœ‰ä¸åŒè¡Œä¸ºçš„å¯¹è±¡

**å…³é”®ç‰¹å¾**ï¼š
- âœ… åŒä¸€ä¸ªå®šä¹‰ï¼Œä¸åŒçš„é…ç½®
- âœ… åˆ›å»ºå¤šä¸ªå®ä¾‹ï¼Œè¡Œä¸ºå„å¼‚
- âœ… çµæ´»é€‚åº”ä¸åŒåœºæ™¯

**å…¸å‹åº”ç”¨**ï¼š
- å¤šç¯å¢ƒé…ç½®ï¼ˆå¼€å‘/æµ‹è¯•/ç”Ÿäº§ï¼‰
- å¤šç§Ÿæˆ·ç³»ç»Ÿï¼ˆä¸åŒç”¨æˆ·ä¸åŒé…ç½®ï¼‰
- å¯æ’æ‹”æ¶æ„ï¼ˆæ ¹æ®é¡¹ç›®åŠ¨æ€åŠ è½½ï¼‰
- æƒé™æ§åˆ¶ï¼ˆä¸åŒè§’è‰²ä¸åŒæƒé™ï¼‰

**åœ¨ Kode SDK ä¸­**ï¼š
- `tool()` â†’ é™æ€å®ä¾‹ï¼ˆé…ç½®å›ºå®šï¼‰
- `defineTool()` â†’ åŠ¨æ€å®ä¾‹ï¼ˆé…ç½®çµæ´»ï¼‰

