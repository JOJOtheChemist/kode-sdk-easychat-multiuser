# Kode SDK å®˜æ–¹å·¥å…·å®šä¹‰å‡½æ•°è¯¦ç»†å¯¹æ¯”æŠ¥å‘Š

**ç‰ˆæœ¬**: Kode SDK v2.7+  
**ç”Ÿæˆæ—¥æœŸ**: 2025-10-19  
**æ–‡æ¡£ç±»å‹**: æŠ€æœ¯åˆ†ææŠ¥å‘Š

---

## ç›®å½•

1. [å®˜æ–¹å®šä¹‰å‡½æ•°æ¸…å•](#1-å®˜æ–¹å®šä¹‰å‡½æ•°æ¸…å•)
2. [æºç å®šä¹‰ä½ç½®](#2-æºç å®šä¹‰ä½ç½®)
3. [tool() è¯¦ç»†åˆ†æ](#3-tool-è¯¦ç»†åˆ†æ)
4. [defineTool() è¯¦ç»†åˆ†æ](#4-definetool-è¯¦ç»†åˆ†æ)
5. [æ³¨å†Œæœºåˆ¶æ ¸å¿ƒå·®å¼‚](#5-æ³¨å†Œæœºåˆ¶æ ¸å¿ƒå·®å¼‚)
6. [prompt å±æ€§å¤„ç†å·®å¼‚](#6-prompt-å±æ€§å¤„ç†å·®å¼‚)
7. [ä½¿ç”¨åœºæ™¯å»ºè®®](#7-ä½¿ç”¨åœºæ™¯å»ºè®®)
8. [å®é™…ä»£ç ç¤ºä¾‹](#8-å®é™…ä»£ç ç¤ºä¾‹)
9. [æ€»ç»“å¯¹æ¯”è¡¨](#9-æ€»ç»“å¯¹æ¯”è¡¨)

---

## 1. å®˜æ–¹å®šä¹‰å‡½æ•°æ¸…å•

Kode SDK æä¾›ä»¥ä¸‹å®˜æ–¹å·¥å…·å®šä¹‰å‡½æ•°ï¼š

| å‡½æ•° | æ–‡ä»¶ | è¡Œå· | ä½œç”¨ | å¼•å…¥ç‰ˆæœ¬ |
|------|------|------|------|---------|
| `tool()` | `src/tools/tool.ts` | 54-153 | å•ä¸ªå·¥å…·å®šä¹‰ï¼ˆZod å‚æ•°ï¼‰ | v2.0+ |
| `tools()` | `src/tools/tool.ts` | 158-160 | æ‰¹é‡å·¥å…·å®šä¹‰ï¼ˆZod å‚æ•°ï¼‰ | v2.0+ |
| `defineTool()` | `src/tools/define.ts` | 144-217 | å•ä¸ªå·¥å…·å®šä¹‰ï¼ˆç®€åŒ–å‚æ•°ï¼‰ | v2.7+ |
| `defineTools()` | `src/tools/define.ts` | 222-224 | æ‰¹é‡å·¥å…·å®šä¹‰ï¼ˆç®€åŒ–å‚æ•°ï¼‰ | v2.7+ |

### å®˜æ–¹å¯¼å‡ºéªŒè¯

**`src/index.ts` ç¬¬ 80-88 è¡Œ**ï¼š

```typescript
export {
  defineTool,
  defineTools,
  extractTools,
  ToolAttributes,
  ParamDef,
  SimpleToolDef,
} from './tools/define';
export { tool, tools, ToolDefinition, EnhancedToolContext } from './tools/tool';
```

**ç»“è®º**: æ‰€æœ‰å‡½æ•°å‡ä¸ºå®˜æ–¹æä¾›ï¼Œæœ‰å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰å’Œæ–‡æ¡£æ”¯æŒã€‚

---

## 2. æºç å®šä¹‰ä½ç½®

### 2.1 tool() å‡½æ•°æ—

**æ–‡ä»¶**: `src/tools/tool.ts`

**æ¥å£å®šä¹‰** (ç¬¬ 10-25 è¡Œ):

```typescript
export interface ToolDefinition<TArgs = any, TResult = any> {
  name: string;
  description?: string;
  parameters?: ZodType<TArgs>;  // â† ä½¿ç”¨ Zod è¿›è¡Œå‚æ•°éªŒè¯
  execute: (args: TArgs, ctx: EnhancedToolContext) => Promise<TResult> | TResult;
  metadata?: {
    version?: string;
    tags?: string[];
    cacheable?: boolean;
    cacheTTL?: number;
    timeout?: number;
    concurrent?: boolean;
    readonly?: boolean;
  };
  hooks?: Hooks;
}
```

**å‡½æ•°ç­¾å** (ç¬¬ 38-49 è¡Œ):

```typescript
// é‡è½½ 1: é›¶é…ç½®æ¨¡å¼
export function tool<TArgs = any, TResult = any>(
  name: string,
  executeFn: (args: TArgs, ctx?: EnhancedToolContext) => Promise<TResult> | TResult
): ToolInstance;

// é‡è½½ 2: å®Œæ•´é…ç½®æ¨¡å¼
export function tool<TArgs = any, TResult = any>(
  definition: ToolDefinition<TArgs, TResult>
): ToolInstance;
```

**å®ç°** (ç¬¬ 54-153 è¡Œ):

```typescript
export function tool<TArgs = any, TResult = any>(
  nameOrDef: string | ToolDefinition<TArgs, TResult>,
  executeFn?: (args: TArgs, ctx?: EnhancedToolContext) => Promise<TResult> | TResult
): ToolInstance {
  // è§£æå‚æ•°
  const def: ToolDefinition<TArgs, TResult> = /* ... */;
  
  // ç”Ÿæˆ JSON Schema
  const input_schema = def.parameters
    ? zodToJsonSchema(def.parameters, { target: 'openApi3', $refStrategy: 'none' })
    : { type: 'object', properties: {} };

  // åˆ›å»ºå·¥å…·å®ä¾‹
  const toolInstance: ToolInstance = {
    name: def.name,
    description: def.description || `Execute ${def.name}`,
    input_schema,
    hooks: def.hooks,
    async exec(args: any, ctx: ToolContext): Promise<any> { /* ... */ },
    toDescriptor(): ToolDescriptor { /* ... */ },
  };

  // â­ å…³é”®ï¼šæ³¨å†Œå·¥å‚å‡½æ•°è¿”å›åŒä¸€ä¸ªå®ä¾‹
  globalToolRegistry.register(def.name, () => toolInstance);
  
  return toolInstance;
}
```

---

### 2.2 defineTool() å‡½æ•°æ—

**æ–‡ä»¶**: `src/tools/define.ts`

**æ¥å£å®šä¹‰** (ç¬¬ 39-54 è¡Œ):

```typescript
export interface SimpleToolDef<TArgs = any, TResult = any> {
  name: string;
  description: string;
  params?: Record<string, ParamDef>;  // â† è‡ªåŠ¨ç”Ÿæˆ Schema
  input_schema?: any;  // æˆ–ç›´æ¥æä¾› Schema
  attributes?: ToolAttributes;
  prompt?: string;  // â­ æ”¯æŒ prompt å­—æ®µ
  exec(args: TArgs, ctx: EnhancedToolContext): Promise<TResult> | TResult;
}

export interface ToolAttributes {
  readonly?: boolean;
  noEffect?: boolean;
}

export interface ParamDef {
  type: 'string' | 'number' | 'boolean' | 'object' | 'array';
  description?: string;
  required?: boolean;
  default?: any;
  enum?: any[];
  items?: ParamDef;
  properties?: Record<string, ParamDef>;
}
```

**å‡½æ•°å®ç°** (ç¬¬ 144-217 è¡Œ):

```typescript
export function defineTool<TArgs = any, TResult = any>(
  def: SimpleToolDef<TArgs, TResult>,
  options?: { autoRegister?: boolean }
): ToolInstance {
  // è‡ªåŠ¨ç”Ÿæˆ schema æˆ–ä½¿ç”¨æä¾›çš„
  const input_schema = def.input_schema || generateSchema(def.params);

  const toolInstance: ToolInstance = {
    name: def.name,
    description: def.description,
    input_schema,
    prompt: def.prompt,  // â­ ä» def ä¸­è¯»å– prompt
    async exec(args: any, ctx: ToolContext): Promise<any> { /* ... */ },
    toDescriptor(): ToolDescriptor { /* ... */ },
  };

  // â­ å…³é”®ï¼šæ³¨å†Œå·¥å‚å‡½æ•°æ¯æ¬¡é‡å»ºå®ä¾‹
  if (options?.autoRegister !== false) {
    globalToolRegistry.register(def.name, (_config) => {
      return defineTool(def, { autoRegister: false });
    });
  }

  return toolInstance;
}
```

**æ‰¹é‡å®šä¹‰** (ç¬¬ 222-224 è¡Œ):

```typescript
export function defineTools(defs: SimpleToolDef[]): ToolInstance[] {
  return defs.map((def) => defineTool(def));
}
```

---

## 3. tool() è¯¦ç»†åˆ†æ

### 3.1 ç‰¹ç‚¹

- **å‚æ•°éªŒè¯**: ä½¿ç”¨ Zod è¿›è¡Œè¿è¡Œæ—¶ç±»å‹éªŒè¯
- **Schema ç”Ÿæˆ**: é€šè¿‡ `zod-to-json-schema` è‡ªåŠ¨ç”Ÿæˆ JSON Schema
- **é”™è¯¯å¤„ç†**: å†…ç½®å‚æ•°éªŒè¯å’Œå¼‚å¸¸æ•è·
- **æ³¨å†Œæœºåˆ¶**: å•ä¾‹æ¨¡å¼ï¼Œå·¥å‚å‡½æ•°è¿”å›åŒä¸€ä¸ªå®ä¾‹å¼•ç”¨

### 3.2 æ³¨å†Œæœºåˆ¶æºç 

```typescript
// ç¬¬ 149-150 è¡Œ
globalToolRegistry.register(def.name, () => toolInstance);
```

**è§£æ**:
- é—­åŒ…æ•è· `toolInstance` å˜é‡
- å·¥å‚å‡½æ•° `() => toolInstance` æ¯æ¬¡è°ƒç”¨éƒ½è¿”å›**åŒä¸€ä¸ªå¯¹è±¡å¼•ç”¨**
- å†…å­˜ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹å­˜åœ¨

### 3.3 å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ

```
åˆ›å»ºé˜¶æ®µï¼š
  tool() è¢«è°ƒç”¨
    â†“
  åˆ›å»º toolInstance (å†…å­˜åœ°å€: 0x1000)
    â†“
  æ³¨å†Œå·¥å‚å‡½æ•°: () => 0x1000
    â†“
  è¿”å› 0x1000

ä½¿ç”¨é˜¶æ®µï¼š
  registry.create('tool_name')
    â†“
  è°ƒç”¨å·¥å‚å‡½æ•°: () => 0x1000
    â†“
  è¿”å› 0x1000 (åŒä¸€ä¸ªå¼•ç”¨)
```

### 3.4 prompt å±æ€§å¤„ç†

```typescript
// åˆ›å»ºå·¥å…·
export const FsWrite = tool({
  name: 'fs_write',
  description: 'Write file',
  parameters: z.object({ /* ... */ }),
  async execute(args, ctx) { /* ... */ },
});

// äº‹åæ·»åŠ  prompt
FsWrite.prompt = PROMPT;

// Agent ä½¿ç”¨
const tool = registry.create('fs_write');
// tool === FsWrite (åŒä¸€ä¸ªå¼•ç”¨)
// tool.prompt === PROMPT âœ…
```

**ç»“è®º**: äº‹åæ·»åŠ çš„ `prompt` å±æ€§**æœ‰æ•ˆ**ï¼Œå› ä¸ºè¿”å›çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚

---

## 4. defineTool() è¯¦ç»†åˆ†æ

### 4.1 ç‰¹ç‚¹

- **ç®€åŒ–å®šä¹‰**: ä½¿ç”¨ç®€å•çš„ç±»å‹å®šä¹‰ï¼Œä¸éœ€è¦ Zod
- **è‡ªåŠ¨ Schema**: ä» `params` å¯¹è±¡è‡ªåŠ¨ç”Ÿæˆ JSON Schema
- **Prompt æ”¯æŒ**: æ¥å£ä¸­åŒ…å« `prompt` å­—æ®µ
- **é…ç½®çµæ´»**: æ”¯æŒ `config` å‚æ•°ï¼Œå¯åŠ¨æ€åˆ›å»ºå®ä¾‹

### 4.2 æ³¨å†Œæœºåˆ¶æºç 

```typescript
// ç¬¬ 208-214 è¡Œ
if (options?.autoRegister !== false) {
  globalToolRegistry.register(def.name, (_config) => {
    // å·¥å‚å‡½æ•°ï¼šæ ¹æ® config é‡å»ºå·¥å…·å®ä¾‹
    return defineTool(def, { autoRegister: false });
  });
}
```

**è§£æ**:
- é—­åŒ…æ•è· `def` å¯¹è±¡ï¼ˆå®šä¹‰ï¼‰è€Œé `toolInstance`ï¼ˆå®ä¾‹ï¼‰
- å·¥å‚å‡½æ•° `(_config) => defineTool(def, ...)` æ¯æ¬¡è°ƒç”¨éƒ½**é‡æ–°æ‰§è¡Œ defineTool**
- æ¯æ¬¡åˆ›å»º**æ–°çš„å¯¹è±¡å®ä¾‹**

### 4.3 å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ

```
åˆ›å»ºé˜¶æ®µï¼š
  defineTool(def) è¢«è°ƒç”¨
    â†“
  åˆ›å»º toolInstance1 (å†…å­˜åœ°å€: 0x1000)
    â†“
  æ³¨å†Œå·¥å‚å‡½æ•°: (_config) => defineTool(def, ...)
    â†“
  è¿”å› 0x1000

ä½¿ç”¨é˜¶æ®µï¼ˆç¬¬ä¸€æ¬¡ï¼‰ï¼š
  registry.create('tool_name')
    â†“
  è°ƒç”¨å·¥å‚å‡½æ•°: defineTool(def, ...)
    â†“
  åˆ›å»º toolInstance2 (å†…å­˜åœ°å€: 0x2000) â† æ–°å¯¹è±¡
    â†“
  è¿”å› 0x2000

ä½¿ç”¨é˜¶æ®µï¼ˆç¬¬äºŒæ¬¡ï¼‰ï¼š
  registry.create('tool_name')
    â†“
  è°ƒç”¨å·¥å‚å‡½æ•°: defineTool(def, ...)
    â†“
  åˆ›å»º toolInstance3 (å†…å­˜åœ°å€: 0x3000) â† åˆä¸€ä¸ªæ–°å¯¹è±¡
    â†“
  è¿”å› 0x3000
```

### 4.4 prompt å±æ€§å¤„ç†

```typescript
// âŒ é”™è¯¯æ–¹å¼ï¼šäº‹åæ·»åŠ 
export const createSchedulesBatchTool = defineTool({
  name: 'create_schedules_batch',
  description: 'Batch create schedules',
  params: { /* ... */ },
  async exec(args, ctx) { /* ... */ },
  // æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰ prompt å­—æ®µ
});

// äº‹åæ·»åŠ  prompt
(createSchedulesBatchTool as any).prompt = PROMPT;

// Agent ä½¿ç”¨
const tool = registry.create('create_schedules_batch');
// tool !== createSchedulesBatchTool (ä¸åŒå¼•ç”¨)
// tool.prompt === undefined âŒ
// å› ä¸º def é‡Œæ²¡æœ‰ promptï¼Œæ–°åˆ›å»ºçš„å®ä¾‹æ²¡æœ‰è¿™ä¸ªå±æ€§
```

```typescript
// âœ… æ­£ç¡®æ–¹å¼ï¼šåœ¨å®šä¹‰ä¸­åŒ…å«
export const createSchedulesBatchTool = defineTool({
  name: 'create_schedules_batch',
  description: 'Batch create schedules',
  prompt: PROMPT,  // â­ åœ¨è¿™é‡Œå®šä¹‰
  params: { /* ... */ },
  async exec(args, ctx) { /* ... */ },
});

// Agent ä½¿ç”¨
const tool = registry.create('create_schedules_batch');
// tool.prompt === PROMPT âœ…
// å› ä¸º def é‡Œæœ‰ promptï¼Œæ–°åˆ›å»ºçš„å®ä¾‹ä¼šåŒ…å«è¿™ä¸ªå±æ€§
```

**ç»“è®º**: äº‹åæ·»åŠ çš„ `prompt` å±æ€§**æ— æ•ˆ**ï¼Œå¿…é¡»åœ¨ `def` å¯¹è±¡ä¸­å®šä¹‰ã€‚

---

## 5. æ³¨å†Œæœºåˆ¶æ ¸å¿ƒå·®å¼‚

### 5.1 æºç å¯¹æ¯”

| ç»´åº¦ | tool() | defineTool() |
|------|--------|--------------|
| **é—­åŒ…æ•è·** | `toolInstance`ï¼ˆå®ä¾‹ï¼‰ | `def`ï¼ˆå®šä¹‰å¯¹è±¡ï¼‰ |
| **å·¥å‚å‡½æ•°** | `() => toolInstance` | `(_config) => defineTool(def, ...)` |
| **è°ƒç”¨ç»“æœ** | è¿”å›åŒä¸€ä¸ªå¯¹è±¡ | åˆ›å»ºæ–°å¯¹è±¡ |
| **å†…å­˜æ¨¡å‹** | å•ä¾‹æ¨¡å¼ | å·¥å‚æ¨¡å¼ |

### 5.2 å›¾ç¤ºå¯¹æ¯”

#### tool() - å•ä¾‹æ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  tool() æ‰§è¡Œ                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åˆ›å»º: toolInstance (0x1000)        â”‚
â”‚  æ³¨å†Œ: () => 0x1000                 â”‚
â”‚  è¿”å›: 0x1000                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ äº‹åä¿®æ”¹
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  toolInstance (0x1000)              â”‚
â”‚  .prompt = PROMPT âœ“                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ Agent ä½¿ç”¨
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  registry.create()                  â”‚
â”‚    â†’ è°ƒç”¨ () => 0x1000              â”‚
â”‚    â†’ è¿”å› 0x1000 (åŒä¸€ä¸ªå¼•ç”¨)       â”‚
â”‚    â†’ .prompt å­˜åœ¨ âœ“                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### defineTool() - å·¥å‚æ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  defineTool(def) æ‰§è¡Œ               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åˆ›å»º: toolInstance1 (0x1000)       â”‚
â”‚  æ³¨å†Œ: (_config) => defineTool(def) â”‚
â”‚  è¿”å›: 0x1000                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ äº‹åä¿®æ”¹
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  toolInstance1 (0x1000)             â”‚
â”‚  .prompt = PROMPT (åªåœ¨è¿™ä¸ªå®ä¾‹ä¸Š)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ Agent ä½¿ç”¨
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  registry.create()                  â”‚
â”‚    â†’ è°ƒç”¨ defineTool(def)           â”‚
â”‚    â†’ åˆ›å»º toolInstance2 (0x2000)    â”‚
â”‚    â†’ def é‡Œæ²¡æœ‰ prompt å­—æ®µ         â”‚
â”‚    â†’ è¿”å› 0x2000 (æ–°å¯¹è±¡)           â”‚
â”‚    â†’ .prompt ä¸å­˜åœ¨ âœ—               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 ä¸ºä»€ä¹ˆè®¾è®¡ä¸åŒï¼Ÿ

#### tool() çš„è®¾è®¡æ„å›¾

**ç›®æ ‡**: ç®€å•ã€å¿«é€Ÿã€æ€§èƒ½ä¼˜å…ˆ

**ä¼˜ç‚¹**:
- å•ä¾‹æ¨¡å¼ï¼Œå†…å­˜æ•ˆç‡é«˜
- æ— éœ€é‡å¤åˆ›å»ºå¯¹è±¡
- é€‚åˆé…ç½®å›ºå®šçš„å·¥å…·

**ç¼ºç‚¹**:
- ä¸æ”¯æŒåŠ¨æ€é…ç½®
- æ‰€æœ‰ä½¿ç”¨æ–¹å…±äº«åŒä¸€ä¸ªå®ä¾‹

#### defineTool() çš„è®¾è®¡æ„å›¾

**ç›®æ ‡**: çµæ´»ã€å¯é…ç½®ã€æ”¯æŒåŠ¨æ€åˆ›å»º

**ä¼˜ç‚¹**:
- æ”¯æŒ `config` å‚æ•°ï¼Œå¯æ ¹æ®ä¸åŒé…ç½®åˆ›å»ºä¸åŒå®ä¾‹
- å®ä¾‹éš”ç¦»ï¼Œé¿å…çŠ¶æ€æ±¡æŸ“
- é€‚åˆéœ€è¦åŠ¨æ€é…ç½®çš„å·¥å…·ï¼ˆå¦‚ `task_run`ï¼‰

**ç¼ºç‚¹**:
- æ¯æ¬¡åˆ›å»ºæ–°å®ä¾‹ï¼Œå†…å­˜å¼€é”€å¤§
- äº‹åä¿®æ”¹å±æ€§æ— æ•ˆ

**å®é™…æ¡ˆä¾‹**: `task_run` å·¥å…·éœ€è¦æ ¹æ®ä¸åŒçš„ `templates` é…ç½®åˆ›å»ºä¸åŒå®ä¾‹

```typescript
// src/tools/task_run/index.ts
export function createTaskRunTool(templates: AgentTemplate[]) {
  return tool({
    name: 'task_run',
    // ...
  });
  // å¯ä»¥æ ¹æ®ä¸åŒçš„ templates ç”Ÿæˆä¸åŒçš„ prompt
}

// ä½¿ç”¨æ—¶
const tool1 = registry.create('task_run', { templates: [t1, t2] });
const tool2 = registry.create('task_run', { templates: [t3, t4] });
// ä¸¤ä¸ªå®ä¾‹å¯ä»¥æœ‰ä¸åŒçš„é…ç½®
```

---

## 6. prompt å±æ€§å¤„ç†å·®å¼‚

### 6.1 tool() å¤„ç† prompt

**æ–¹å¼ 1: äº‹åæ·»åŠ ï¼ˆæœ‰æ•ˆï¼‰**

```typescript
export const FsWrite = tool({
  name: 'fs_write',
  description: 'Write file',
  parameters: z.object({
    path: z.string(),
    content: z.string(),
  }),
  async execute(args, ctx) {
    await ctx.sandbox.fs.write(args.path, args.content);
    return { ok: true };
  },
});

FsWrite.prompt = PROMPT;  // âœ… æœ‰æ•ˆ
```

**åŸå› **: `tool()` è¿”å›çš„æ˜¯å•ä¾‹ï¼Œå·¥å‚å‡½æ•°è¿”å›åŒä¸€ä¸ªå¯¹è±¡å¼•ç”¨ã€‚

**éªŒè¯**:

```typescript
const tool1 = registry.create('fs_write');
const tool2 = registry.create('fs_write');
console.log(tool1 === tool2);  // true
console.log(tool1.prompt);     // PROMPT
console.log(tool2.prompt);     // PROMPT
```

---

### 6.2 defineTool() å¤„ç† prompt

**æ–¹å¼ 1: äº‹åæ·»åŠ ï¼ˆæ— æ•ˆï¼‰**

```typescript
export const createSchedulesBatchTool = defineTool({
  name: 'create_schedules_batch',
  description: 'Batch create schedules',
  params: { /* ... */ },
  async exec(args, ctx) { /* ... */ },
});

(createSchedulesBatchTool as any).prompt = PROMPT;  // âŒ æ— æ•ˆ
```

**åŸå› **: `defineTool()` çš„å·¥å‚å‡½æ•°æ¯æ¬¡é‡å»ºå®ä¾‹ï¼Œæ–°å®ä¾‹åŸºäº `def`ï¼Œè€Œ `def` é‡Œæ²¡æœ‰ `prompt`ã€‚

**éªŒè¯**:

```typescript
const tool1 = registry.create('create_schedules_batch');
const tool2 = registry.create('create_schedules_batch');
console.log(tool1 === tool2);  // false (ä¸åŒå®ä¾‹)
console.log(createSchedulesBatchTool.prompt);  // PROMPT (åŸå®ä¾‹æœ‰)
console.log(tool1.prompt);     // undefined (æ–°å®ä¾‹æ²¡æœ‰)
console.log(tool2.prompt);     // undefined (æ–°å®ä¾‹æ²¡æœ‰)
```

**æ–¹å¼ 2: å®šä¹‰æ—¶åŒ…å«ï¼ˆæœ‰æ•ˆï¼‰**

```typescript
export const createSchedulesBatchTool = defineTool({
  name: 'create_schedules_batch',
  description: 'Batch create schedules',
  prompt: PROMPT,  // âœ… åœ¨è¿™é‡Œå®šä¹‰
  params: { /* ... */ },
  async exec(args, ctx) { /* ... */ },
});
```

**åŸå› **: `prompt` åœ¨ `def` å¯¹è±¡ä¸­ï¼Œæ¯æ¬¡ `defineTool(def)` éƒ½ä¼šåˆ›å»ºåŒ…å« `prompt` çš„æ–°å®ä¾‹ã€‚

**éªŒè¯**:

```typescript
const tool1 = registry.create('create_schedules_batch');
const tool2 = registry.create('create_schedules_batch');
console.log(tool1 === tool2);  // false (ä¸åŒå®ä¾‹)
console.log(tool1.prompt);     // PROMPT âœ…
console.log(tool2.prompt);     // PROMPT âœ…
```

---

## 7. ä½¿ç”¨åœºæ™¯å»ºè®®

### 7.1 ä½•æ—¶ä½¿ç”¨ tool()

**é€‚ç”¨åœºæ™¯**:
- âœ… å·¥å…·é…ç½®ç®€å•ä¸”å›ºå®š
- âœ… éœ€è¦è¿è¡Œæ—¶ç±»å‹éªŒè¯ï¼ˆZodï¼‰
- âœ… å¯¹æ€§èƒ½æœ‰è¦æ±‚ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰
- âœ… å¯ä»¥äº‹åæ·»åŠ å±æ€§ï¼ˆå¦‚ promptï¼‰

**ç¤ºä¾‹**: å†…ç½®å·¥å…·ï¼ˆfs_read, fs_write, fs_edit ç­‰ï¼‰

```typescript
import { tool } from '@kode/sdk';
import { z } from 'zod';
import { PROMPT } from './prompt';

export const FsRead = tool({
  name: 'fs_read',
  description: 'Read file contents',
  parameters: z.object({
    path: z.string(),
  }),
  async execute(args, ctx) {
    const content = await ctx.sandbox.fs.read(args.path);
    return { content };
  },
  metadata: {
    readonly: true,
  },
});

FsRead.prompt = PROMPT;  // å¯ä»¥è¿™æ ·æ·»åŠ 
```

---

### 7.2 ä½•æ—¶ä½¿ç”¨ defineTool()

**é€‚ç”¨åœºæ™¯**:
- âœ… å·¥å…·å¯èƒ½éœ€è¦åŠ¨æ€é…ç½®
- âœ… ä¸éœ€è¦å¤æ‚çš„è¿è¡Œæ—¶éªŒè¯
- âœ… å¸Œæœ›æ¥å£å®šä¹‰ç®€æ´
- âœ… prompt å¯ä»¥åœ¨å®šä¹‰æ—¶ç¡®å®š

**ç¤ºä¾‹**: è‡ªå®šä¹‰ä¸šåŠ¡å·¥å…·

```typescript
import { defineTool } from '@kode/sdk';
import { DESCRIPTION, PROMPT } from './prompt';

export const createSchedulesBatchTool = defineTool({
  name: 'create_schedules_batch',
  description: DESCRIPTION,
  prompt: PROMPT,  // â­ å¿…é¡»åœ¨è¿™é‡Œå®šä¹‰
  params: {
    date: {
      type: 'string',
      description: 'æ—¥æœŸï¼Œæ ¼å¼ YYYY-MM-DD',
    },
    natural_language: {
      type: 'string',
      description: 'ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æè¿°',
    },
    slot_interval: {
      type: 'number',
      description: 'æ—¶é—´æ§½é—´éš”ï¼ˆåˆ†é’Ÿï¼‰',
      required: false,
    },
  },
  attributes: { readonly: false },
  async exec(args, ctx) {
    // å®ç°é€»è¾‘
  },
});
```

---

### 7.3 é€‰æ‹©å†³ç­–æ ‘

```
å¼€å§‹
  â”‚
  â”œâ”€ éœ€è¦ Zod éªŒè¯ï¼Ÿ
  â”‚   â””â”€ æ˜¯ â†’ ä½¿ç”¨ tool()
  â”‚
  â”œâ”€ éœ€è¦åŠ¨æ€é…ç½®ï¼Ÿ
  â”‚   â””â”€ æ˜¯ â†’ ä½¿ç”¨ defineTool()
  â”‚
  â”œâ”€ å¸Œæœ›æ¥å£ç®€æ´ï¼Ÿ
  â”‚   â””â”€ æ˜¯ â†’ ä½¿ç”¨ defineTool()
  â”‚
  â”œâ”€ å¯¹æ€§èƒ½æœ‰æé«˜è¦æ±‚ï¼Ÿ
  â”‚   â””â”€ æ˜¯ â†’ ä½¿ç”¨ tool()
  â”‚
  â””â”€ é»˜è®¤æ¨è
      â””â”€ defineTool() (æ›´ç¬¦åˆç›´è§‰ï¼Œæ¥å£ç®€å•)
```

---

## 8. å®é™…ä»£ç ç¤ºä¾‹

### 8.1 tool() å®Œæ•´ç¤ºä¾‹

```typescript
// src/tools/fs_write/index.ts
import { tool } from '../tool';
import { z } from 'zod';
import { patterns } from '../type-inference';
import { DESCRIPTION, PROMPT } from './prompt';
import { ToolContext } from '../../core/types';

export const FsWrite = tool({
  name: 'fs_write',
  description: DESCRIPTION,
  parameters: z.object({
    path: patterns.filePath('Path to file within the sandbox'),
    content: z.string().describe('Content to write'),
  }),
  async execute(args, ctx: ToolContext) {
    const { path, content } = args;

    // æ–‡ä»¶æ–°é²œåº¦éªŒè¯
    const freshness = await ctx.services?.filePool?.validateWrite(path);
    if (freshness && !freshness.isFresh) {
      return {
        ok: false,
        error: 'File appears to have changed externally.',
      };
    }

    // å†™å…¥æ–‡ä»¶
    await ctx.sandbox.fs.write(path, content);
    await ctx.services?.filePool?.recordEdit(path);

    const bytes = Buffer.byteLength(content, 'utf8');
    const lines = content.split('\n').length;

    return {
      ok: true,
      path,
      bytes,
      lines,
    };
  },
  metadata: {
    readonly: false,
    version: '1.0',
  },
});

// äº‹åæ·»åŠ  promptï¼ˆæœ‰æ•ˆï¼‰
FsWrite.prompt = PROMPT;
```

---

### 8.2 defineTool() å®Œæ•´ç¤ºä¾‹

```typescript
// server/tools/create_schedules_batch/index.ts
import { defineTool } from '../../../src';
import { DESCRIPTION, PROMPT } from './prompt';
import { BatchCreateInput } from './types';
import { validateInput } from './validator';
import { executeBatchCreate } from './executor';

export const createSchedulesBatchTool = defineTool({
  name: 'create_schedules_batch',
  description: DESCRIPTION,
  prompt: PROMPT,  // â­ å¿…é¡»åœ¨å®šä¹‰ä¸­åŒ…å«
  params: {
    date: {
      type: 'string',
      description: 'æ—¥æœŸï¼Œæ ¼å¼ YYYY-MM-DD',
    },
    natural_language: {
      type: 'string',
      description: 'ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æè¿°',
    },
    slot_interval: {
      type: 'number',
      description: 'æ—¶é—´æ§½é—´éš”ï¼ˆåˆ†é’Ÿï¼‰',
      required: false,
    },
  },
  attributes: { readonly: false },
  async exec(args: BatchCreateInput, ctx) {
    // éªŒè¯è¾“å…¥
    const validation = validateInput(args);
    if (!validation.valid) {
      return { ok: false, error: validation.error };
    }
    
    // æ‰§è¡Œæ‰¹é‡åˆ›å»º
    return executeBatchCreate(args, ctx);
  },
});

// âŒ ä¸è¦è¿™æ ·åšï¼Œæ— æ•ˆ
// (createSchedulesBatchTool as any).prompt = PROMPT;
```

---

### 8.3 prompt å®šä¹‰ç¤ºä¾‹

```typescript
// prompt.ts
export const DESCRIPTION = 'å°†ç”¨æˆ·æè¿°çš„æ—¥ç¨‹ç›¸å…³è‡ªç„¶è¯­è¨€è½¬åŒ–ä¸ºç»“æ„åŒ–çš„æ—¶é—´è¡¨æ ¼å¼';

export const PROMPT = `ä½¿ç”¨æ­¤å·¥å…·æ‰¹é‡åˆ›å»ºå¤šä¸ªæ—¥ç¨‹è®°å½•ã€‚

æ ¸å¿ƒç‰¹ç‚¹ï¼š
- ä¸€æ¬¡æ€§åˆ›å»ºå¤šæ¡æ—¥ç¨‹ï¼Œå‡å°‘è°ƒç”¨æ¬¡æ•°
- è‡ªåŠ¨è§£ææ—¶é—´æ®µã€æ‹†åˆ†æ—¶é—´æ§½ã€æå–ä»»åŠ¡å’Œå¤‡æ³¨
- æ™ºèƒ½åŒ¹é…ä»»åŠ¡åç§°åˆ°å·²æœ‰ä»»åŠ¡

ğŸ“ å‚æ•°è¯´æ˜ï¼š
- date (å¿…éœ€): æ—¥æœŸï¼Œæ ¼å¼ YYYY-MM-DD
- natural_language (å¿…éœ€): ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æè¿°
- slot_interval (å¯é€‰): æ—¶é—´æ§½é—´éš”ï¼ˆåˆ†é’Ÿï¼‰ï¼Œé»˜è®¤30

ğŸ¯ ä½¿ç”¨ç¤ºä¾‹ï¼š
create_schedules_batch({
  date: "2025-10-18",
  natural_language: "æˆ‘ä¸‹åˆ1ç‚¹åŠåˆ°5ç‚¹åœ¨å¼€å‘å·¥å…·"
})

ğŸ’¡ æœ€ä½³ä½¿ç”¨åœºæ™¯ï¼š
- ç”¨æˆ·å£è¯­åŒ–æè¿°ä¸€æ®µæ—¶é—´çš„æ´»åŠ¨
- ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†æ‰€æœ‰ç»†èŠ‚
`;
```

---

## 9. æ€»ç»“å¯¹æ¯”è¡¨

### 9.1 æ ¸å¿ƒå·®å¼‚

| ç»´åº¦ | tool() | defineTool() |
|------|--------|--------------|
| **å®šä¹‰æ–‡ä»¶** | `src/tools/tool.ts` | `src/tools/define.ts` |
| **å‚æ•°éªŒè¯** | Zod (è¿è¡Œæ—¶éªŒè¯) | è‡ªåŠ¨ Schema (ç±»å‹æ¨æ–­) |
| **æ¥å£å¤æ‚åº¦** | ä¸­ç­‰ | ç®€å• |
| **æ³¨å†Œæœºåˆ¶** | å•ä¾‹æ¨¡å¼ | å·¥å‚æ¨¡å¼ |
| **é—­åŒ…æ•è·** | `toolInstance` | `def` |
| **å·¥å‚å‡½æ•°** | `() => instance` | `() => defineTool(def)` |
| **æ¯æ¬¡è°ƒç”¨** | è¿”å›åŒä¸€å¯¹è±¡ | åˆ›å»ºæ–°å¯¹è±¡ |
| **prompt äº‹åæ·»åŠ ** | âœ… æœ‰æ•ˆ | âŒ æ— æ•ˆ |
| **prompt å®šä¹‰æ—¶æ·»åŠ ** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| **åŠ¨æ€é…ç½®** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| **å†…å­˜æ•ˆç‡** | é«˜ï¼ˆå•ä¾‹ï¼‰ | ä½ï¼ˆå¤šå®ä¾‹ï¼‰ |
| **æ€§èƒ½** | ä¼˜ç§€ | è‰¯å¥½ |
| **é€‚ç”¨åœºæ™¯** | å†…ç½®å·¥å…· | ä¸šåŠ¡å·¥å…· |

---

### 9.2 prompt å±æ€§å¤„ç†å¯¹æ¯”

| æ“ä½œ | tool() | defineTool() |
|------|--------|--------------|
| **åœ¨ def ä¸­å®šä¹‰** | âŒ æ¥å£ä¸æ”¯æŒ | âœ… æ¥å£æ”¯æŒ |
| **äº‹åæ·»åŠ ** | âœ… æœ‰æ•ˆ | âŒ æ— æ•ˆ |
| **Agent èƒ½çœ‹åˆ°** | âœ… èƒ½ï¼ˆåŒä¸€å¯¹è±¡ï¼‰ | âœ… èƒ½ï¼ˆå¦‚æœåœ¨ def ä¸­å®šä¹‰ï¼‰<br/>âŒ ä¸èƒ½ï¼ˆå¦‚æœäº‹åæ·»åŠ ï¼‰ |

---

### 9.3 æ³¨å†Œæœºåˆ¶å¯¹æ¯”

| ç»´åº¦ | tool() | defineTool() |
|------|--------|--------------|
| **è®¾è®¡æ¨¡å¼** | Singletonï¼ˆå•ä¾‹ï¼‰ | Factoryï¼ˆå·¥å‚ï¼‰ |
| **å®ä¾‹æ•°é‡** | 1 ä¸ª | å¤šä¸ª |
| **å¯¹è±¡å¼•ç”¨** | æ‰€æœ‰è°ƒç”¨å…±äº« | æ¯æ¬¡è°ƒç”¨ç‹¬ç«‹ |
| **çŠ¶æ€éš”ç¦»** | æ— ï¼ˆå…±äº«çŠ¶æ€ï¼‰ | æœ‰ï¼ˆç‹¬ç«‹çŠ¶æ€ï¼‰ |
| **å¯é…ç½®æ€§** | é™æ€ | åŠ¨æ€ |

---

## 10. å®˜æ–¹æ–‡æ¡£å‚è€ƒ

### 10.1 å®˜æ–¹æ–‡æ¡£ä½ç½®

- **ç®€åŒ–å·¥å…· API**: `docs/simplified-tools.md`
- **ç¤ºä¾‹ä»£ç **: `examples/tooling/simplified-tools.ts`
- **æµ‹è¯•ç”¨ä¾‹**: `tests/tool-define.test.ts`

### 10.2 å®˜æ–¹è¯´æ˜æ‘˜å½•

**`docs/simplified-tools.md` ç¬¬ 1-11 è¡Œ**:

```markdown
# ç®€åŒ–çš„å·¥å…·å®šä¹‰ API

## æ¦‚è¿°

Kode SDK v2.7 å¼•å…¥äº†å…¨æ–°çš„å·¥å…·å®šä¹‰ APIï¼Œå¤§å¹…ç®€åŒ–äº†å¼€å‘ä½“éªŒï¼š

- âœ… **è‡ªåŠ¨ Schema ç”Ÿæˆ**ï¼šä»ç±»å‹å®šä¹‰è‡ªåŠ¨ç”Ÿæˆ JSON Schemaï¼Œæ— éœ€æ‰‹åŠ¨ç¼–å†™
- âœ… **ç®€åŒ–çš„å±æ€§æ ‡è®°**ï¼šç”¨ `readonly`/`noEffect` æ›¿ä»£å¤æ‚çš„ `access`/`mutates`/`safe`
- âœ… **è‡ªå®šä¹‰äº‹ä»¶æ”¯æŒ**ï¼šå·¥å…·å†…å¯å‘å°„è‡ªå®šä¹‰äº‹ä»¶åˆ° monitor é€šé“
- âœ… **å‘åå…¼å®¹**ï¼šå®Œå…¨å…¼å®¹ç°æœ‰çš„ `ToolInstance` æ¥å£
```

---

## 11. ç»“è®ºä¸å»ºè®®

### 11.1 æ ¸å¿ƒå‘ç°

1. **tool() å’Œ defineTool() éƒ½æ˜¯å®˜æ–¹å‡½æ•°**ï¼Œå‡åœ¨ `src/index.ts` ä¸­å¯¼å‡º
2. **æ³¨å†Œæœºåˆ¶ä¸åŒ**æ˜¯å¯¼è‡´ prompt å¤„ç†å·®å¼‚çš„æ ¹æœ¬åŸå› ï¼š
   - `tool()`: å•ä¾‹æ¨¡å¼ï¼Œå·¥å‚å‡½æ•°è¿”å›åŒä¸€å®ä¾‹
   - `defineTool()`: å·¥å‚æ¨¡å¼ï¼Œå·¥å‚å‡½æ•°é‡å»ºæ–°å®ä¾‹
3. **prompt å±æ€§**:
   - `tool()`: å¯ä»¥äº‹åæ·»åŠ ï¼ˆå› ä¸ºè¿”å›åŒä¸€å¯¹è±¡ï¼‰
   - `defineTool()`: å¿…é¡»åœ¨å®šä¹‰æ—¶åŒ…å«ï¼ˆå› ä¸ºåŸºäº def é‡å»ºï¼‰

### 11.2 æœ€ä½³å®è·µ

#### å¯¹äº tool() ç”¨æˆ·

```typescript
// âœ… æ¨èï¼šäº‹åæ·»åŠ 
export const MyTool = tool({ /* ... */ });
MyTool.prompt = PROMPT;
```

#### å¯¹äº defineTool() ç”¨æˆ·

```typescript
// âœ… æ¨èï¼šå®šä¹‰æ—¶åŒ…å«
export const MyTool = defineTool({
  /* ... */,
  prompt: PROMPT,  // å¿…é¡»åœ¨è¿™é‡Œ
});

// âŒ é”™è¯¯ï¼šäº‹åæ·»åŠ ï¼ˆæ— æ•ˆï¼‰
// (MyTool as any).prompt = PROMPT;
```

### 11.3 è¿ç§»å»ºè®®

å¦‚æœä½ çš„ä»£ç ä½¿ç”¨ `defineTool()` ä¸”äº‹åæ·»åŠ  `prompt`ï¼š

1. **æ£€æŸ¥ä»£ç **:
   ```bash
   grep -r "defineTool" --include="*.ts" | grep -l "\.prompt = "
   ```

2. **ä¿®æ”¹æ–¹å¼**:
   - å°† `prompt` ç§»åˆ° `defineTool()` çš„å‚æ•°å¯¹è±¡ä¸­
   - åˆ é™¤äº‹åæ·»åŠ çš„ä»£ç 

3. **éªŒè¯**:
   ```typescript
   const tool = registry.create('your_tool_name');
   console.assert(tool.prompt !== undefined, 'prompt åº”è¯¥å­˜åœ¨');
   ```

---

**æŠ¥å‘Šç»“æŸ**

å¦‚æœ‰ç–‘é—®ï¼Œè¯·å‚è€ƒæºç ï¼š
- `src/tools/tool.ts`
- `src/tools/define.ts`
- `docs/simplified-tools.md`

