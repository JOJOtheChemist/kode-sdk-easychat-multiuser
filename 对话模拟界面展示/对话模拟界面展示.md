# 对话模拟界面展示（接入后端事件流）

## 迭代概览

- `src/routes/demo-conversation.tsx` 现已直接连接后端 Demo Server 的 SSE 事件流：
  - 通过 `POST /api/conversations` 创建真实会话，并在本地保存 `conversationId`。
  - 使用 `EventSource` 订阅 `/api/conversations/:id/events`，实时消费 `text_chunk`、`tool:start`、`tool:end`、`token_usage` 等事件。
  - 将文本流增量写入助手气泡，工具调用以“执行中 → 完成”卡片形式展示结果，监控事件走系统提示气泡。
- 输入框内消息经由 `POST /api/conversations/:id/messages` 发送至后端，失败会在原气泡追加“发送失败”提示。
- 支持一键“重新开始”触发新的会话与事件流，便于复测。
- 可通过环境变量 `VITE_DEMO_BACKEND_URL` 重定向到其它后端地址，默认指向 `http://localhost:3000`。

## 后端启动方式（GLM 数据流）

```bash
cd /Users/yeya/FlutterProjects/kode-sdk/Kode-sdk
npm install
npm run build
npm run start --prefix demo
```

> `demo/runtime.ts` 使用 `GLMProvider`（模型 `glm-4.5-air`），默认内置测试用 API Key，可通过 `GLM_API_KEY` / `GLM_BASE_URL` 覆写。

## 前端页面：`src/routes/demo-conversation.tsx`

```tsx
import React from "react";
import { Spinner } from "@heroui/react";

const BACKEND_BASE_URL =
  import.meta.env.VITE_DEMO_BACKEND_URL || "http://localhost:3000";

type TextMessage = {
  id: string;
  kind: "text";
  role: "user" | "assistant";
  content: string;
  streaming?: boolean;
};

// ...

const DemoConversationRoute: React.FC = () => {
  const [conversationId, setConversationId] = React.useState<string | null>(null);
  const [messages, setMessages] = React.useState<ChatEntry[]>([]);
  const eventSourceRef = React.useRef<EventSource | null>(null);

  const appendAssistantDelta = React.useCallback((delta: string) => {
    // 将文本增量拼接到助手气泡
  }, []);

  const handleToolStart = React.useCallback((envelope: BackendEnvelope) => {
    // 工具开始 -> 添加“执行中”卡片
  }, []);

  const handleToolEnd = React.useCallback((envelope: BackendEnvelope) => {
    // 工具结束 -> 卡片改为“已完成”，附带输出
  }, []);

  React.useEffect(() => {
    // 1. 创建会话
    // 2. 打开 EventSource 监听 text_chunk / tool:start / tool:end 等事件
    // 3. 清理时关闭事件流
  }, []);

  const handleSubmit = React.useCallback(async (event) => {
    event.preventDefault();
    // 将用户消息发送至 `/messages`，并追加到本地消息列表
  }, [conversationId]);

  // 渲染文本气泡、工具调用卡片、系统事件提示 ...
};

export default DemoConversationRoute;
```

> 完整源码位于仓库 `src/routes/demo-conversation.tsx`，包含事件解析、工具状态渲染、SSE 生命周期管理等全部细节，建议在 IDE 中查看。
