# 数据存储结构详解 - 笔记 #5

## 存储目录结构

### 主存储路径
```
./.kode-html-test/
└── agt:01K7H1RY3BNE1D3YX3C01SM0R1/    # Agent实例目录
    ├── events/                         # 事件日志目录
    │   ├── monitor.log                # 监控事件日志
    │   └── progress.log               # 进度事件日志
    ├── meta.json                       # Agent元数据配置
    └── runtime/                        # 运行时数据目录
        ├── messages.json              # 对话历史记录
        └── tool-calls.json            # 工具调用记录
```

## 详细文件内容分析

### 1. messages.json - 对话历史
**功能**：存储完整的用户与Agent对话记录

**数据结构**：
```json
[
  {
    "role": "user",
    "content": [
      {
        "type": "text",
        "text": "建立一个html文件，里面写上点加号能增加数字"
      }
    ]
  },
  {
    "role": "assistant", 
    "content": [
      {
        "type": "text",
        "text": "\n\n我来为您创建一个带有加号按钮来增加数字的HTML文件。\n"
      },
      {
        "type": "tool_use",
        "id": "call_4b5b6938b3994b0e9eb13a19",
        "name": "fs_write",
        "input": {
          "path": "counter.html",
          "content": "..."
        }
      }
    ]
  }
]
```

**存储信息**：
- ✅ 用户输入消息
- ✅ AI助手回复
- ✅ 工具调用详情
- ✅ 消息时间戳
- ✅ 内容类型标识

### 2. tool-calls.json - 工具调用记录
**功能**：详细记录每个工具的执行过程

**数据结构**：
```json
[
  {
    "id": "call_4b5b6938b3994b0e9eb13a19",
    "name": "fs_write",
    "input": {
      "path": "counter.html",
      "content": "<!DOCTYPE html>...</html>"
    },
    "state": "COMPLETED",
    "approval": {
      // 审批信息
    }
  }
]
```

**记录信息**：
- ✅ 工具调用ID
- ✅ 工具名称
- ✅ 输入参数
- ✅ 执行状态
- ✅ 审批决策

### 3. meta.json - Agent元数据
**功能**：存储Agent的配置和状态信息

**典型内容**：
```json
{
  "agentId": "agt:01K7H1RY3BNE1D3YX3C01SM0R1",
  "templateId": "html-creator",
  "status": "READY",
  "createdAt": "2025-10-14T17:45:00.000Z",
  "lastActiveAt": "2025-10-14T17:45:30.000Z",
  "modelConfig": {
    "provider": "glm",
    "model": "glm-4.5-air"
  }
}
```

### 4. 事件日志文件

#### progress.log - 进度事件
**记录内容**：
- 文本流事件（text_chunk）
- 工具生命周期（tool:start/end）
- 完成状态（done）

#### monitor.log - 监控事件
**记录内容**：
- Agent状态变更
- 工具执行统计
- 错误和警告
- 性能指标
- 文件变更通知

## 存储机制特性

### 1. JSONStore持久化
- **存储方式**：基于JSON文件的WAL（Write-Ahead Log）
- **原子性**：确保数据写入的原子性
- **一致性**：维护数据状态的一致性
- **持久性**：数据永久保存，支持Agent恢复

### 2. Agent ID生成
- **格式**：`agt:` + ULID（Universally Unique Lexicographically Sortable Identifier）
- **示例**：`agt:01K7H1RY3BNE1D3YX3C01SM0R1`
- **特性**：按时间排序、全局唯一、高性能

### 3. 数据分离设计
- **按Agent分离**：每个Agent有独立存储目录
- **按类型分离**：事件、运行时数据、元数据分别存储
- **按时间分离**：支持时间范围查询和归档

## 存储位置汇总

### 主要存储目录
```bash
./.kode-html-test/              # 主存储（JSONStore数据库）
./html-workspace/              # 工作目录（文件创建位置）
```

### 其他存储示例
```bash
./.kode-demo-data/             # Demo数据存储
./.kode-glm-simple/            # GLM简单测试存储
./.kode-test-comprehensive/    # 综合测试存储
./.kode-bridge/                # WebSocket桥接存储
```

## 数据恢复能力

### Agent恢复
```typescript
const agent = await Agent.resume('agt:01K7H1RY3BNE1D3YX3C01SM0R1', config, deps, {
  strategy: 'crash',  // 自动封口未完成工具
  autoRun: true,      // 恢复后继续处理队列
});
```

### 恢复特性
- ✅ **对话历史恢复**：完整恢复之前的对话内容
- ✅ **工具调用恢复**：恢复中断的工具执行状态
- ✅ **Agent状态恢复**：恢复Agent的运行状态
- ✅ **上下文恢复**：恢复完整的工作上下文

---
*创建时间：2025-10-14*
*测试状态：存储结构分析完成*