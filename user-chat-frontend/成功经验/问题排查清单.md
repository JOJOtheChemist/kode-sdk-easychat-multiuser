# 问题排查清单

## 快速诊断步骤

### 1️⃣ 检查服务状态

```bash
# 检查前端 (8888)
lsof -i :8888

# 检查后端 (2500)
lsof -i :2500
```

✅ 两个服务都应该在运行

---

### 2️⃣ 浏览器控制台检查

打开浏览器开发者工具（F12），Console 标签：

**期望看到**:
```
[SSE] thinking { delta: '...', sessionId: '...' }
[SSE] text { delta: '...', sessionId: '...' }
[SSE] tool_start { name: '...', input: {...} }
[SSE] tool_end { name: '...', duration: 1234 }
[SSE] complete {}
```

**如果没有日志**:
- 请求可能没有发送成功
- 检查 Network 标签

**如果有错误**:
- 记录错误信息
- 检查请求参数

---

### 3️⃣ Network 面板检查

打开 Network 标签：

1. **找到 `/api/chat` 请求**
   - 状态应该是 `200`
   - Type 应该是 `eventsource` 或 `fetch`

2. **查看 Headers**
   ```
   Request URL: http://localhost:8888/api/chat
   Request Method: POST
   Status Code: 200 OK
   Content-Type: text/event-stream
   ```

3. **查看 Payload**
   ```json
   {
     "userId": "user1",
     "agentId": "schedule-assistant",
     "sessionId": "morning_work",
     "message": "你好啊"
   }
   ```

4. **查看 Response (EventStream)**
   应该能看到实时的 SSE 事件流

---

### 4️⃣ 后端日志检查

```bash
tail -50 /Users/yeya/FlutterProjects/kode-sdk/kode-sdk/server.log
```

**期望看到**:
```
[用户 → 日程助手] 会话: morning_work, 消息: 你好啊
[订阅] 开始 Progress 事件流监听...
[think_chunk] 发送思考内容，长度: 9
[text_chunk_start] 正式回复开始
[对话完成] 工具调用次数: 0, 原因: completed
🔓 [解锁] 会话 user1:morning_work 处理完成
```

**如果没有日志**:
- 请求可能没有到达后端
- 检查代理配置

---

### 5️⃣ 前端日志检查

```bash
tail -50 /Users/yeya/FlutterProjects/kode-sdk/user-chat-frontend/frontend.log
```

查看是否有 Vite 错误或热更新日志

---

## 常见问题和解决方案

### 问题 1: 发送消息后无响应

**症状**: 点击发送后，消息显示"正在输入..."，但一直没有回复

**检查**:
1. 浏览器控制台有错误吗？
2. Network 面板中请求状态是什么？
3. 后端日志显示收到请求了吗？

**解决**:
- 如果 Network 显示 `429`: 会话被锁定，等待几秒后重试
- 如果 Network 显示 `500`: 后端错误，查看后端日志
- 如果没有 `[SSE]` 日志: SSE 解析失败，检查代码

---

### 问题 2: 只显示"正在输入..."

**症状**: 消息发送成功，但只显示"正在输入..."，没有实际内容

**原因**: 可能是：
1. SSE 事件类型不匹配
2. `delta` 字段为空
3. 前端没有正确累积内容

**检查**:
```javascript
// 在浏览器控制台运行
console.log('[SSE]', currentEvent, data);
```

查看是否有 `text` 或 `thinking` 事件

---

### 问题 3: 工具调用不显示

**症状**: 后端日志显示工具被调用，但前端没有显示

**检查**:
1. 是否有 `[SSE] tool_start` 日志？
2. `accumulatedContent` 是否包含工具信息？

**解决**:
确保前端正确处理 `tool_start` 和 `tool_end` 事件

---

### 问题 4: 请求被拒绝 (429)

**症状**: Network 显示 `429 Too Many Requests`

**原因**: 会话被锁定（另一个请求正在处理）

**解决**:
1. 等待当前请求完成
2. 检查后端日志是否有 "🔓 [解锁]"
3. 如果长时间未解锁，可能是死锁，需要重启后端

---

### 问题 5: CORS 错误

**症状**: 控制台显示 CORS 相关错误

**原因**: 跨域请求被阻止

**解决**:
1. 检查 Vite 代理配置
2. 确保使用 `/api/chat` 而不是 `http://localhost:2500/api/chat`

---

## 调试工具

### 1. 实时监控后端日志

```bash
tail -f /Users/yeya/FlutterProjects/kode-sdk/kode-sdk/server.log | grep -E "用户|SSE|工具|完成|解锁"
```

### 2. 测试后端 API

```bash
curl -X POST http://localhost:2500/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "user1",
    "agentId": "schedule-assistant",
    "sessionId": "test_debug",
    "message": "测试消息"
  }'
```

### 3. 检查会话文件

```bash
ls -la /Users/yeya/FlutterProjects/kode-sdk/kode-sdk/.kode/user1/morning_work/
```

---

## 完整诊断脚本

```bash
#!/bin/bash

echo "=== 服务状态 ==="
echo "前端 (8888):"
lsof -i :8888 | grep LISTEN
echo "后端 (2500):"
lsof -i :2500 | grep LISTEN

echo ""
echo "=== 后端最新日志 ==="
tail -20 /Users/yeya/FlutterProjects/kode-sdk/kode-sdk/server.log

echo ""
echo "=== 测试后端 API ==="
curl -X POST http://localhost:2500/api/chat \
  -H "Content-Type: application/json" \
  -d '{"userId":"user1","agentId":"schedule-assistant","sessionId":"debug_test","message":"ping"}' \
  2>/dev/null | head -20

echo ""
echo "=== 会话目录 ==="
ls -la /Users/yeya/FlutterProjects/kode-sdk/kode-sdk/.kode/user1/
```

保存为 `debug.sh`，运行: `chmod +x debug.sh && ./debug.sh`

---

**记住**: 大多数问题都是 SSE 事件类型不匹配或解析错误导致的！
